Index: app/src/main/java/com/security/app/MainActivity.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.security.app\r\n\r\nimport android.app.NotificationChannel\r\nimport android.app.NotificationManager\r\nimport android.content.Context\r\nimport android.graphics.Color\r\nimport android.os.Build\r\nimport android.os.Bundle\r\nimport android.util.Log\r\nimport android.view.LayoutInflater\r\nimport android.view.View\r\nimport android.view.ViewGroup\r\nimport android.widget.ArrayAdapter\r\nimport android.widget.TextView\r\nimport android.widget.Toast\r\nimport com.google.firebase.FirebaseApp\r\nimport com.google.firebase.firestore.FirebaseFirestore\r\nimport com.google.firebase.messaging.FirebaseMessaging\r\nimport androidx.swiperefreshlayout.widget.SwipeRefreshLayout\r\n\r\nclass MainActivity : BaseActivity() {\r\n    \r\n    private lateinit var db: FirebaseFirestore\r\n    private lateinit var timestampText: TextView\r\n    private lateinit var securityStatus: TextView\r\n    private lateinit var scadaStatus: TextView\r\n    private lateinit var idsStatus: TextView\r\n    private lateinit var iperlStatus: TextView\r\n    \r\n    // Card views for alarm color changes\r\n    private lateinit var securityCard: androidx.cardview.widget.CardView\r\n    private lateinit var scadaCard: androidx.cardview.widget.CardView\r\n    private lateinit var idsCard: androidx.cardview.widget.CardView\r\n    private lateinit var iperlCard: androidx.cardview.widget.CardView\r\n    \r\n    // Firestore listener registrations for proper cleanup\r\n    private var sensorListener: com.google.firebase.firestore.ListenerRegistration? = null\r\n    private var gaugeListener: com.google.firebase.firestore.ListenerRegistration? = null\r\n    \r\n    override fun onCreate(savedInstanceState: Bundle?) {\r\n        super.onCreate(savedInstanceState)\r\n        setContentView(R.layout.activity_main_dashboard)\r\n        \r\n        // Initialize Firebase\r\n        FirebaseApp.initializeApp(this)\r\n        db = FirebaseFirestore.getInstance()\r\n        \r\n        // Initialize views\r\n        timestampText = findViewById(R.id.timestampText)\r\n        securityStatus = findViewById(R.id.securityStatus)\r\n        scadaStatus = findViewById(R.id.scadaStatus)\r\n        idsStatus = findViewById(R.id.idsStatus)\r\n        iperlStatus = findViewById(R.id.iperlStatus)\r\n        \r\n        // Initialize card views for alarm colors\r\n        securityCard = findViewById(R.id.securityCard)\r\n        scadaCard = findViewById(R.id.scadaCard)\r\n        idsCard = findViewById(R.id.idsCard)\r\n        iperlCard = findViewById(R.id.iperlCard)\r\n\r\n        // Apply per-card colors (reads prefs and falls back to defaults)\r\n        applyCardColors()\r\n\r\n        // Create notification channel\r\n        createNotificationChannel()\r\n        \r\n        // Get FCM token and save to Firestore\r\n        getFCMToken()\r\n\r\n        // Listen for sensor status updates\r\n        listenForSensorUpdates()\r\n\r\n        // Pre-load all graph data\r\n        GraphDataRepository.preLoadAllGraphData()\r\n\r\n        // Start the notification service\r\n        val serviceIntent = android.content.Intent(this, NotificationService::class.java)\r\n        startService(serviceIntent)\r\n\r\n        // Setup navigation\r\n        setupNavigation()\r\n\r\n        // Settings icon removed from layout; navigation to setup remains available from SCADA card\r\n\r\n        // Setup swipe to refresh\r\n        val swipeRefreshLayout = findViewById<SwipeRefreshLayout>(R.id.swipeRefreshLayout)\r\n        swipeRefreshLayout.setOnRefreshListener {\r\n            refreshData()\r\n            swipeRefreshLayout.isRefreshing = false\r\n        }\r\n\r\n        // Long-press timestamp to open AlarmTestActivity (quick access for debugging)\r\n        findViewById<TextView>(R.id.timestampText).setOnLongClickListener {\r\n            try {\r\n                val intent = android.content.Intent(this, AlarmTestActivity::class.java)\r\n                startActivity(intent)\r\n            } catch (_: Exception) {}\r\n            true\r\n        }\r\n    }\r\n\r\n    override fun onResume() {\r\n        super.onResume()\r\n        // Re-apply per-card colors in case they were changed in a child activity\r\n        applyCardColors()\r\n    }\r\n\r\n    private fun applyCardColors() {\r\n        val prefsInit = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n        val securityPref = prefsInit.getString(\"card_security_color\", null)\r\n        val scadaPref = prefsInit.getString(\"card_scada_color\", null)\r\n        val idsPref = prefsInit.getString(\"card_ids_color\", null)\r\n        val iperlPref = prefsInit.getString(\"card_iperl_color\", null)\r\n\r\n        if (!securityPref.isNullOrEmpty()) {\r\n            securityCard.setCardBackgroundColor(try { Color.parseColor(securityPref) } catch (e: IllegalArgumentException) { Color.parseColor(\"#2D5016\") })\r\n        } else {\r\n            securityCard.setCardBackgroundColor(Color.parseColor(\"#2D5016\"))\r\n        }\r\n        if (!scadaPref.isNullOrEmpty()) {\r\n            scadaCard.setCardBackgroundColor(try { Color.parseColor(scadaPref) } catch (e: IllegalArgumentException) { Color.parseColor(\"#1A237E\") })\r\n        } else {\r\n            scadaCard.setCardBackgroundColor(Color.parseColor(\"#1A237E\"))\r\n        }\r\n        if (!idsPref.isNullOrEmpty()) {\r\n            idsCard.setCardBackgroundColor(try { Color.parseColor(idsPref) } catch (e: IllegalArgumentException) { Color.parseColor(\"#BF360C\") })\r\n        } else {\r\n            idsCard.setCardBackgroundColor(Color.parseColor(\"#BF360C\"))\r\n        }\r\n        if (!iperlPref.isNullOrEmpty()) {\r\n            iperlCard.setCardBackgroundColor(try { Color.parseColor(iperlPref) } catch (e: IllegalArgumentException) { Color.parseColor(\"#4A148C\") })\r\n        } else {\r\n            iperlCard.setCardBackgroundColor(Color.parseColor(\"#4A148C\"))\r\n        }\r\n    }\r\n\r\n    private fun refreshData() {\r\n        listenForSensorUpdates()\r\n        GraphDataRepository.preLoadAllGraphData()\r\n        try { ToastHelper.show(this, \"Data refreshed\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n    }\r\n\r\n    // New helper: pick a color and apply to all four main dashboard cards\r\n    private fun showColorPickerForAllCards(dialogTitle: String) {\r\n        val colors = arrayOf(\r\n            \"#000000\", \"#FFFFFF\", \"#800000\", \"#008000\", \"#808000\", \"#000080\", \"#800080\", \"#008080\",\r\n            \"#C0C0C0\", \"#FF0000\", \"#00FF00\", \"#FFFF00\", \"#0000FF\", \"#FF00FF\", \"#00FFFF\", \"#808080\"\r\n        )\r\n        val colorNames = arrayOf(\r\n            \"Black\", \"White\", \"Maroon\", \"Green\", \"Olive\", \"Navy\", \"Purple\", \"Teal\",\r\n            \"Silver\", \"Red\", \"Lime\", \"Yellow\", \"Blue\", \"Fuchsia\", \"Aqua\", \"Gray\"\r\n        )\r\n\r\n        val builder = android.app.AlertDialog.Builder(this)\r\n        builder.setTitle(dialogTitle)\r\n        val adapter = ColorAdapter(this, colors, colorNames)\r\n        builder.setAdapter(adapter) { _, which ->\r\n            val selectedColor = colors[which]\r\n            val sharedPreferences = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n            with(sharedPreferences.edit()) {\r\n                putString(\"card_security_color\", selectedColor)\r\n                putString(\"card_scada_color\", selectedColor)\r\n                putString(\"card_ids_color\", selectedColor)\r\n                putString(\"card_iperl_color\", selectedColor)\r\n                apply()\r\n            }\r\n            // Immediately apply to UI\r\n            applyCardColors()\r\n        }\r\n        builder.show()\r\n    }\r\n\r\n    // New: show settings dialog with two pickers\r\n    private fun showSettingsDialog() {\r\n        val options = arrayOf(\"Card background color\", \"Graph background color\")\r\n        val builder = android.app.AlertDialog.Builder(this)\r\n        builder.setTitle(\"Appearance settings\")\r\n        builder.setItems(options) { _, which ->\r\n            when (which) {\r\n                0 -> showColorPickerForAllCards(\"Choose card background color\")\r\n                1 -> showColorPicker(\"graph_background_color\", \"Choose graph background color\")\r\n            }\r\n        }\r\n        builder.show()\r\n    }\r\n\r\n    private fun showColorPicker(prefKey: String, dialogTitle: String) {\r\n        val colors = arrayOf(\r\n            \"#000000\", \"#FFFFFF\", \"#800000\", \"#008000\", \"#808000\", \"#000080\", \"#800080\", \"#008080\",\r\n            \"#C0C0C0\", \"#FF0000\", \"#00FF00\", \"#FFFF00\", \"#0000FF\", \"#FF00FF\", \"#00FFFF\", \"#808080\"\r\n        )\r\n        val colorNames = arrayOf(\r\n            \"Black\", \"White\", \"Maroon\", \"Green\", \"Olive\", \"Navy\", \"Purple\", \"Teal\",\r\n            \"Silver\", \"Red\", \"Lime\", \"Yellow\", \"Blue\", \"Fuchsia\", \"Aqua\", \"Gray\"\r\n        )\r\n\r\n        val builder = android.app.AlertDialog.Builder(this)\r\n        builder.setTitle(dialogTitle)\r\n        val adapter = ColorAdapter(this, colors, colorNames)\r\n        builder.setAdapter(adapter) { _, which ->\r\n            val selectedColor = colors[which]\r\n            val sharedPreferences = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n            with(sharedPreferences.edit()) {\r\n                putString(prefKey, selectedColor)\r\n                apply()\r\n            }\r\n            // Recreate the activity so card colors update immediately on the main screen.\r\n            recreate()\r\n        }\r\n        builder.show()\r\n    }\r\n    \r\n    private fun createNotificationChannel() {\r\n        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {\r\n            val channelId = getString(R.string.default_notification_channel_id)\r\n            val name = getString(R.string.channel_name)\r\n            val descriptionText = getString(R.string.channel_description)\r\n            val importance = NotificationManager.IMPORTANCE_HIGH\r\n            \r\n            val notificationManager: NotificationManager =\r\n                getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager\r\n            \r\n            // Try to delete existing channel if possible, but don't crash if system prevents it\r\n            try {\r\n                notificationManager.deleteNotificationChannel(channelId)\r\n            } catch (se: SecurityException) {\r\n                // Some OEM/Android versions prevent deleting a channel while a foreground service is active.\r\n                // Log and proceed to create or update the channel instead.\r\n                Log.w(\"MainActivity\", \"Could not delete notification channel (ignored): ${se.message}\")\r\n            } catch (e: Exception) {\r\n                Log.w(\"MainActivity\", \"Unexpected error deleting notification channel (ignored): ${e.message}\")\r\n            }\r\n\r\n            // Create or update channel with bundled alarm sound (res/raw/alarm_tone.mp3)\r\n            val soundUri = android.net.Uri.parse(\"android.resource://$packageName/${R.raw.alarm_tone}\")\r\n            val audioAttrs = android.media.AudioAttributes.Builder()\r\n                .setUsage(android.media.AudioAttributes.USAGE_ALARM)\r\n                .setContentType(android.media.AudioAttributes.CONTENT_TYPE_SONIFICATION)\r\n                .setFlags(android.media.AudioAttributes.FLAG_AUDIBILITY_ENFORCED)\r\n                .build()\r\n            val existing = notificationManager.getNotificationChannel(channelId)\r\n            val channel = NotificationChannel(channelId, name, importance).apply {\r\n                description = descriptionText\r\n                enableVibration(true)\r\n                setShowBadge(true)\r\n                setBypassDnd(true)\r\n                lockscreenVisibility = android.app.Notification.VISIBILITY_PUBLIC\r\n                setSound(soundUri, audioAttrs)\r\n            }\r\n            if (existing == null) {\r\n                notificationManager.createNotificationChannel(channel)\r\n            } else {\r\n                // Update settings on the existing channel where supported\r\n                try {\r\n                    existing.description = channel.description\r\n                    existing.setSound(soundUri, audioAttrs)\r\n                    existing.enableVibration(true)\r\n                    notificationManager.createNotificationChannel(existing)\r\n                } catch (e: Exception) {\r\n                    Log.w(\"MainActivity\", \"Failed to update existing notification channel (ignored): ${e.message}\")\r\n                }\r\n            }\r\n          }\r\n      }\r\n\r\n    private inner class ColorAdapter(\r\n        context: Context,\r\n        private val colors: Array<String>,\r\n        private val colorNames: Array<String>\r\n    ) : ArrayAdapter<String>(context, R.layout.color_list_item, colorNames) {\r\n\r\n        override fun getView(position: Int, convertView: View?, parent: ViewGroup): View {\r\n            val view = convertView ?: LayoutInflater.from(context).inflate(R.layout.color_list_item, parent, false)\r\n            val colorSwatch = view.findViewById<View>(R.id.colorSwatch)\r\n            val colorName = view.findViewById<TextView>(R.id.colorName)\r\n\r\n            colorSwatch.setBackgroundColor(Color.parseColor(colors[position]))\r\n            colorName.text = colorNames[position]\r\n\r\n            return view\r\n        }\r\n    }\r\n    \r\n    private fun getFCMToken() {\r\n        FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->\r\n            if (!task.isSuccessful) {\r\n                Log.w(\"FCM\", \"Fetching FCM registration token failed\", task.exception)\r\n                // Show explicit toast so user/dev sees failure\r\n                runOnUiThread {\r\n                    try { ToastHelper.show(this, \"FCM token fetch failed: ${task.exception?.localizedMessage ?: \"Unknown error\"}\", android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                }\r\n                return@addOnCompleteListener\r\n            }\r\n\r\n            // Get new FCM registration token\r\n            val token = task.result\r\n            Log.d(\"FCM\", \"FCM Registration Token: $token\")\r\n\r\n            if (token.isNullOrEmpty()) {\r\n                Log.w(\"FCM\", \"FCM token is null or empty\")\r\n                runOnUiThread {\r\n                    try { ToastHelper.show(this, \"FCM token empty\", android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                }\r\n                return@addOnCompleteListener\r\n            }\r\n\r\n            try {\r\n                // Save token to Firestore\r\n                saveTokenToFirestore(token)\r\n\r\n                // Show token in UI for debugging\r\n                runOnUiThread {\r\n                    try { ToastHelper.show(this, \"FCM Token saved\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                }\r\n            } catch (e: Exception) {\r\n                Log.e(\"FCM\", \"Exception while saving token\", e)\r\n                runOnUiThread {\r\n                    try { ToastHelper.show(this, \"FCM save failed: ${e.localizedMessage}\", android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    private fun saveTokenToFirestore(token: String) {\r\n        val tokenData = hashMapOf(\r\n            \"token\" to token,\r\n            \"updated\" to com.google.firebase.Timestamp.now(),\r\n            \"platform\" to \"android\"\r\n        )\r\n        \r\n        db.collection(\"fcm_tokens\")\r\n            .document(token)\r\n            .set(tokenData)\r\n            .addOnSuccessListener {\r\n                Log.d(\"Firestore\", \"Token saved successfully\")\r\n            }\r\n            .addOnFailureListener { e ->\r\n                Log.w(\"Firestore\", \"Error saving token\", e)\r\n            }\r\n    }\r\n    \r\n    private fun listenForSensorUpdates() {\r\n        // Listen for security sensor updates\r\n        sensorListener = db.collection(\"security sensors\")\r\n            .document(\"live_status\")\r\n            .addSnapshotListener { snapshot, e ->\r\n                if (e != null) {\r\n                    Log.w(\"Firestore\", \"Listen failed.\", e)\r\n                    return@addSnapshotListener\r\n                }\r\n\r\n                if (snapshot != null && snapshot.exists()) {\r\n                    val data = snapshot.data\r\n                    updateUI(data)\r\n                } else {\r\n                    Log.d(\"Firestore\", \"Current data: null\")\r\n                }\r\n            }\r\n            \r\n        // Listen for gauge/water meter updates\r\n        gaugeListener = db.collection(\"security sensors\")\r\n            .document(\"gauge_status\")\r\n            .addSnapshotListener { snapshot, e ->\r\n                if (e != null) {\r\n                    Log.w(\"Firestore\", \"Gauge listen failed.\", e)\r\n                    return@addSnapshotListener\r\n                }\r\n\r\n                if (snapshot != null && snapshot.exists()) {\r\n                    val gaugeData = snapshot.data\r\n                    updateGaugeUI(gaugeData)\r\n                } else {\r\n                    Log.d(\"Firestore\", \"Gauge data: null\")\r\n                }\r\n            }\r\n    }\r\n    \r\n    private fun updateUI(data: Map<String, Any>?) {\r\n        if (data == null) return\r\n        \r\n        val zones = mapOf(\r\n            \"Garage\" to listOf(\"garage_motion\", \"garage_sensor\"),\r\n            \"Garage Side\" to listOf(\"garage_side_motion\", \"garage_side_sensor\"),\r\n            \"South\" to listOf(\"south_motion\", \"south_sensor\"),\r\n            \"Back\" to listOf(\"back_motion\", \"back_sensor\"),\r\n            \"North\" to listOf(\"north_motion\", \"north_sensor\"),\r\n            \"Front\" to listOf(\"front_motion\", \"front_sensor\")\r\n        )\r\n        \r\n        val statusBuilder = StringBuilder(\"Security Zone Status:\\n\\n\")\r\n        \r\n        zones.forEach { (zoneName, sensors) ->\r\n            val sensor1 = data[sensors[0]] as? Long ?: 0\r\n            val sensor2 = data[sensors[1]] as? Long ?: 0\r\n            \r\n            val status = if (sensor1 == 1L && sensor2 == 1L) {\r\n                \"\uD83D\uDEA8 MOTION DETECTED\"\r\n            } else {\r\n                \"✅ CLEAR\"\r\n            }\r\n            \r\n            statusBuilder.append(\"$zoneName: $status\\n\")\r\n        }\r\n        \r\n        // Add timestamp if available\r\n        val timestamp = data[\"timestamp\"]\r\n        if (timestamp != null) {\r\n            statusBuilder.append(\"\\nLast Update: ${timestamp}\")\r\n        }\r\n        \r\n        runOnUiThread {\r\n            // statusText removed from layout per UI update\r\n            timestampText.text = \"Last Update: ${java.text.SimpleDateFormat(\"HH:mm:ss\", java.util.Locale.getDefault()).format(java.util.Date())}\"\r\n            // Update individual status blocks\r\n            updateStatusBlocks(data)\r\n        }\r\n    }\r\n    \r\n    private fun updateGaugeUI(gaugeData: Map<String, Any>?) {\r\n        if (gaugeData == null) return\r\n        // Robust parsing for water readings and RSSI\r\n        fun safeDouble(value: Any?): Double = when (value) {\r\n            is Double -> value\r\n            is Float -> value.toDouble()\r\n            is Int -> value.toDouble()\r\n            is Long -> value.toDouble()\r\n            is String -> value.toDoubleOrNull() ?: 0.0\r\n            else -> 0.0\r\n        }\r\n        val mikeWaterReading = safeDouble(gaugeData[\"MikeWaterReading\"])\r\n        val allenWaterReading = safeDouble(gaugeData[\"AllenWaterReading\"])\r\n        val mikeRSSI = safeDouble(gaugeData[\"MikeRSSI\"])\r\n        val allenRSSI = safeDouble(gaugeData[\"AllenRSSI\"])\r\n\r\n        val metersOnline = listOf(mikeRSSI, allenRSSI).count { it != -999.0 }\r\n        val waterDataAvailable = listOf(mikeWaterReading, allenWaterReading).count { it > 0 }\r\n\r\n        iperlStatus.text = when {\r\n            waterDataAvailable == 2 -> \"2 Meters: ${String.format(\"%.0f\", mikeWaterReading)}L / ${String.format(\"%.0f\", allenWaterReading)}L\"\r\n            waterDataAvailable == 1 -> \"1 Meter Reading Available\"\r\n            metersOnline > 0 -> \"$metersOnline Meters Online\"\r\n            else -> \"No Meter Data\"\r\n        }\r\n    }\r\n\r\n    private fun updateStatusBlocks(data: Map<String, Any>) {\r\n        // Update Security Status with Alarm Detection\r\n        val zones = mapOf(\r\n            \"Garage\" to listOf(\"garage_motion\", \"garage_sensor\"),\r\n            \"Garage Side\" to listOf(\"garage_side_motion\", \"garage_side_sensor\"),\r\n            \"South\" to listOf(\"south_motion\", \"south_sensor\"),\r\n            \"Back\" to listOf(\"back_motion\", \"back_sensor\"),\r\n            \"North\" to listOf(\"north_motion\", \"north_sensor\"),\r\n            \"Front\" to listOf(\"front_motion\", \"front_sensor\")\r\n        )\r\n\r\n        var activeZones = 0\r\n        zones.forEach { (_, sensors) ->\r\n            val sensor1 = data[sensors[0]] as? Long ?: 0\r\n            val sensor2 = data[sensors[1]] as? Long ?: 0\r\n            if (sensor1 == 1L || sensor2 == 1L) activeZones++\r\n        }\r\n\r\n        // Read preferred card background color (applied for non-alarm state)\r\n        val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n        val securityPref = prefs.getString(\"card_security_color\", null)\r\n\r\n        // Security Alarm Logic\r\n        if (activeZones > 0) {\r\n            securityStatus.text = \"\uD83D\uDD34 $activeZones Active Zones\"\r\n            securityCard.setCardBackgroundColor(Color.parseColor(\"#D32F2F\")) // Red alarm\r\n        } else {\r\n            securityStatus.text = \"\uD83D\uDFE2 6 Zones Armed\"\r\n            val colorToUse = try {\r\n                if (!securityPref.isNullOrEmpty()) Color.parseColor(securityPref) else Color.parseColor(\"#2D5016\")\r\n            } catch (e: IllegalArgumentException) {\r\n                Color.parseColor(\"#2D5016\")\r\n            }\r\n            securityCard.setCardBackgroundColor(colorToUse)\r\n        }\r\n\r\n        // SCADA Alarm Logic - Check for sensor faults\r\n        updateSCADAAlarms(data)\r\n\r\n        // IDS Status - Check for network threats\r\n        updateIDSAlarms(data)\r\n\r\n        // IPERL Status - Check for water meter issues\r\n        updateIPERLAlarms(data)\r\n    }\r\n    \r\n    private fun updateSCADAAlarms(data: Map<String, Any>) {\r\n        // Check temperature sensors\r\n        val tempIn = (data[\"temp in\"] as? Double) ?: 20.0\r\n        val tempOut = (data[\"temp out\"] as? Double) ?: 15.0\r\n        val dvrTemp = (data[\"dvr_temp\"] as? Double) ?: 25.0\r\n        val power = (data[\"kw\"] as? Double) ?: 0.0\r\n        val amps = (data[\"amps\"] as? Double) ?: 0.0\r\n        \r\n        val hasAlarm = when {\r\n            tempIn > 35.0 || tempIn < 5.0 -> true // Indoor temp alarm\r\n            tempOut > 45.0 || tempOut < -10.0 -> true // Outdoor temp alarm  \r\n            dvrTemp > 45.0 -> true // DVR overheating\r\n            power > 15.0 -> true // Power consumption too high\r\n            amps > 60.0 -> true // Current draw too high\r\n            else -> false\r\n        }\r\n        \r\n        val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n        val scadaPref = prefs.getString(\"card_scada_color\", null)\r\n\r\n        if (hasAlarm) {\r\n            scadaStatus.text = \"\uD83D\uDD34 System Fault\"\r\n            scadaCard.setCardBackgroundColor(Color.parseColor(\"#D32F2F\")) // Red alarm\r\n        } else {\r\n            scadaStatus.text = \"\uD83D\uDFE2 All Normal\"\r\n            val colorToUse = try {\r\n                if (!scadaPref.isNullOrEmpty()) Color.parseColor(scadaPref) else Color.parseColor(\"#1A237E\")\r\n            } catch (e: IllegalArgumentException) {\r\n                Color.parseColor(\"#1A237E\")\r\n            }\r\n            scadaCard.setCardBackgroundColor(colorToUse)\r\n        }\r\n    }\r\n    \r\n    private fun updateIDSAlarms(data: Map<String, Any>) {\r\n        // Simulate IDS threat detection (you can connect real IDS data later)\r\n        val networkThreats = (data[\"network_threats\"] as? Long) ?: 0\r\n        val suspiciousActivity = (data[\"suspicious_activity\"] as? Boolean) ?: false\r\n        \r\n        val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n        val idsPref = prefs.getString(\"card_ids_color\", null)\r\n\r\n        if (networkThreats > 0 || suspiciousActivity) {\r\n            idsStatus.text = \"\uD83D\uDD34 Threats Detected\"\r\n            idsCard.setCardBackgroundColor(Color.parseColor(\"#D32F2F\")) // Red alarm\r\n        } else {\r\n            idsStatus.text = \"\uD83D\uDFE2 Controller Ready\"\r\n            val colorToUse = try {\r\n                if (!idsPref.isNullOrEmpty()) Color.parseColor(idsPref) else Color.parseColor(\"#BF360C\")\r\n            } catch (e: IllegalArgumentException) {\r\n                Color.parseColor(\"#BF360C\")\r\n            }\r\n            idsCard.setCardBackgroundColor(colorToUse)\r\n        }\r\n    }\r\n    \r\n    private fun updateIPERLAlarms(data: Map<String, Any>) {\r\n        // This will be updated when we integrate Google Sheets data\r\n        // For now, simulate water meter alarms\r\n        val waterPressure = (data[\"water_pressure\"] as? Double) ?: 3.5\r\n        val flowRate = (data[\"flow_rate\"] as? Double) ?: 0.0\r\n        \r\n        val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n        val iperlPref = prefs.getString(\"card_iperl_color\", null)\r\n\r\n        val hasWaterAlarm = when {\r\n            waterPressure < 1.5 || waterPressure > 6.0 -> true // Pressure alarm\r\n            flowRate > 15.0 -> true // High flow alarm (possible leak)\r\n            else -> false\r\n        }\r\n        \r\n        if (hasWaterAlarm) {\r\n            iperlStatus.text = \"\uD83D\uDD34 Water Alert\"\r\n            iperlCard.setCardBackgroundColor(Color.parseColor(\"#D32F2F\")) // Red alarm\r\n        } else {\r\n            iperlStatus.text = \"\uD83D\uDFE2 Meters Normal\"\r\n            val colorToUse = try {\r\n                if (!iperlPref.isNullOrEmpty()) Color.parseColor(iperlPref) else Color.parseColor(\"#4A148C\")\r\n            } catch (e: IllegalArgumentException) {\r\n                Color.parseColor(\"#4A148C\")\r\n            }\r\n            iperlCard.setCardBackgroundColor(colorToUse)\r\n        }\r\n    }\r\n    \r\n    private fun setupNavigation() {\r\n        // When a dashboard card is tapped, trigger the appropriate repository refresh so the\r\n        // destination activity's graphs observe fresh data immediately.\r\n        findViewById<androidx.cardview.widget.CardView>(R.id.securityCard).setOnClickListener {\r\n            // Security screen doesn't host heavy graphs, but ensure repository preloads data\r\n            GraphDataRepository.preLoadAllGraphData()\r\n            val intent = android.content.Intent(this, SecurityActivity::class.java)\r\n            startActivity(intent)\r\n        }\r\n        \r\n        findViewById<androidx.cardview.widget.CardView>(R.id.scadaCard).setOnClickListener {\r\n            // Refresh SCADA-related graph sources before opening SCADA view\r\n            GraphDataRepository.refreshPowerData()\r\n            GraphDataRepository.refreshWeatherData()\r\n            GraphDataRepository.refreshGeyserData()\r\n            GraphDataRepository.refreshDvrData()\r\n            val intent = android.content.Intent(this, ScadaActivity::class.java)\r\n            startActivity(intent)\r\n        }\r\n        \r\n        findViewById<androidx.cardview.widget.CardView>(R.id.idsCard).setOnClickListener {\r\n            // IDS doesn't have separate graph endpoints yet; perform a preload for safety\r\n            GraphDataRepository.preLoadAllGraphData()\r\n            val intent = android.content.Intent(this, IDSActivity::class.java)\r\n            startActivity(intent)\r\n        }\r\n        \r\n        findViewById<androidx.cardview.widget.CardView>(R.id.iperlCard).setOnClickListener {\r\n            // Force-refresh water meter CSV and parsing so IPERL graphs show latest values\r\n            GraphDataRepository.refreshWaterMeterData(forceRefresh = true)\r\n            val intent = android.content.Intent(this, IPERLActivity::class.java)\r\n            startActivity(intent)\r\n        }\r\n\r\n         // Add long-press listeners to test alarms\r\n         securityCard.setOnLongClickListener {\r\n             testSecurityAlarm()\r\n             true\r\n         }\r\n\r\n         scadaCard.setOnLongClickListener {\r\n             testSCADAAlarm()\r\n             true\r\n         }\r\n\r\n         idsCard.setOnLongClickListener {\r\n             testIDSAlarm()\r\n             true\r\n         }\r\n\r\n         iperlCard.setOnLongClickListener {\r\n             testIPERLAlarm()\r\n             true\r\n         }\r\n     }\r\n\r\n    // Test alarm functions - Long press cards to test alarm states\r\n    private fun testSecurityAlarm() {\r\n        // Simulate motion detection\r\n        val testData = mapOf(\r\n            \"garage_motion\" to 1L,\r\n            \"south_motion\" to 1L,\r\n            \"timestamp\" to com.google.firebase.Timestamp.now()\r\n        )\r\n        updateStatusBlocks(testData)\r\n        try { ToastHelper.show(this, \"Security Alarm Test - Motion Detected\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n\r\n        // Reset after 5 seconds\r\n        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({\r\n            val normalData = mapOf(\r\n                \"garage_motion\" to 0L,\r\n                \"south_motion\" to 0L,\r\n                \"timestamp\" to com.google.firebase.Timestamp.now()\r\n            )\r\n            updateStatusBlocks(normalData)\r\n        }, 5000)\r\n    }\r\n    \r\n    private fun testSCADAAlarm() {\r\n        // Simulate high temperature alarm\r\n        val testData = mapOf(\r\n            \"temp in\" to 45.0, // High indoor temp\r\n            \"dvr_temp\" to 50.0, // DVR overheating\r\n            \"kw\" to 18.0, // High power consumption\r\n            \"timestamp\" to com.google.firebase.Timestamp.now()\r\n        )\r\n        updateStatusBlocks(testData)\r\n        try { ToastHelper.show(this, \"SCADA Alarm Test - High Temperature\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n\r\n        // Reset after 5 seconds\r\n        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({\r\n            val normalData = mapOf(\r\n                \"temp in\" to 22.0,\r\n                \"dvr_temp\" to 25.0,\r\n                \"kw\" to 5.0,\r\n                \"timestamp\" to com.google.firebase.Timestamp.now()\r\n            )\r\n            updateStatusBlocks(normalData)\r\n        }, 5000)\r\n    }\r\n    \r\n    private fun testIDSAlarm() {\r\n        // Simulate network threat\r\n        val testData = mapOf(\r\n            \"network_threats\" to 3L,\r\n            \"suspicious_activity\" to true,\r\n            \"timestamp\" to com.google.firebase.Timestamp.now()\r\n        )\r\n        updateStatusBlocks(testData)\r\n        try { ToastHelper.show(this, \"IDS Alarm Test - Threats Detected\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n\r\n        // Reset after 5 seconds\r\n        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({\r\n            val normalData = mapOf(\r\n                \"network_threats\" to 0L,\r\n                \"suspicious_activity\" to false,\r\n                \"timestamp\" to com.google.firebase.Timestamp.now()\r\n            )\r\n            updateStatusBlocks(normalData)\r\n        }, 5000)\r\n    }\r\n    \r\n    private fun testIPERLAlarm() {\r\n        // Simulate water pressure alarm\r\n        val testData = mapOf(\r\n            \"water_pressure\" to 0.8, // Low pressure alarm\r\n            \"flow_rate\" to 20.0, // High flow rate (possible leak)\r\n            \"timestamp\" to com.google.firebase.Timestamp.now()\r\n        )\r\n        updateStatusBlocks(testData)\r\n        try { ToastHelper.show(this, \"IPERL Alarm Test - Water Pressure Low\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n\r\n        // Reset after 5 seconds\r\n        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({\r\n            val normalData = mapOf(\r\n                \"water_pressure\" to 3.5,\r\n                \"flow_rate\" to 2.0,\r\n                \"timestamp\" to com.google.firebase.Timestamp.now()\r\n            )\r\n            updateStatusBlocks(normalData)\r\n        }, 5000)\r\n    }\r\n    \r\n    override fun onDestroy() {\r\n        super.onDestroy()\r\n        // Remove Firestore listeners to prevent memory leaks\r\n        try { sensorListener?.remove() } catch (_: Exception) {}\r\n        try { gaugeListener?.remove() } catch (_: Exception) {}\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/security/app/MainActivity.kt b/app/src/main/java/com/security/app/MainActivity.kt
--- a/app/src/main/java/com/security/app/MainActivity.kt	(revision 44d69ffda4d1488978c0d0db75712de451938b41)
+++ b/app/src/main/java/com/security/app/MainActivity.kt	(date 1766914029413)
@@ -32,7 +32,14 @@
     private lateinit var scadaCard: androidx.cardview.widget.CardView
     private lateinit var idsCard: androidx.cardview.widget.CardView
     private lateinit var iperlCard: androidx.cardview.widget.CardView
-    
+
+    // Dashboard lights controller views
+    private var dashboardLightsOnButton: android.widget.Button? = null
+    private var dashboardLightsOffButton: android.widget.Button? = null
+    private var dashboardLightsStatusText: TextView? = null
+    private var dashboardLightsStatusIcon: android.widget.ImageView? = null
+    private var dashboardLightsDetails: TextView? = null
+
     // Firestore listener registrations for proper cleanup
     private var sensorListener: com.google.firebase.firestore.ListenerRegistration? = null
     private var gaugeListener: com.google.firebase.firestore.ListenerRegistration? = null
@@ -58,6 +65,35 @@
         idsCard = findViewById(R.id.idsCard)
         iperlCard = findViewById(R.id.iperlCard)
 
+        // Hook dashboard lights controller
+        dashboardLightsOnButton = findViewById(R.id.dashboardLightsOnButton)
+        dashboardLightsOffButton = findViewById(R.id.dashboardLightsOffButton)
+        dashboardLightsStatusText = findViewById(R.id.dashboardLightsStatusText)
+        dashboardLightsStatusIcon = findViewById(R.id.dashboardLightsStatusIcon)
+        dashboardLightsDetails = findViewById(R.id.dashboardLightsDetails)
+
+        // Write directly via LightsService (no navigation needed)
+        dashboardLightsOnButton?.setOnClickListener {
+            Log.d("MainActivity", "Dashboard Lights ON clicked — using LightsService")
+            val ok = try { LightsService().writeOutsideLights(this@MainActivity, true) } catch (e: Exception) {
+                Log.w("MainActivity", "LightsService ON failed", e); false
+            }
+            try {
+                val msg = if (ok) getString(R.string.bridge_command_on_sent) else getString(R.string.failed_send_bridge_command, "service write failed")
+                ToastHelper.show(this@MainActivity, msg, Toast.LENGTH_SHORT)
+            } catch (_: Exception) {}
+        }
+        dashboardLightsOffButton?.setOnClickListener {
+            Log.d("MainActivity", "Dashboard Lights OFF clicked — using LightsService")
+            val ok = try { LightsService().writeOutsideLights(this@MainActivity, false) } catch (e: Exception) {
+                Log.w("MainActivity", "LightsService OFF failed", e); false
+            }
+            try {
+                val msg = if (ok) getString(R.string.bridge_command_off_sent) else getString(R.string.failed_send_bridge_command, "service write failed")
+                ToastHelper.show(this@MainActivity, msg, Toast.LENGTH_SHORT)
+            } catch (_: Exception) {}
+        }
+
         // Apply per-card colors (reads prefs and falls back to defaults)
         applyCardColors()
 
Index: app/src/main/java/com/security/app/MyFirebaseMessagingService.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.security.app\r\n\r\nimport android.app.NotificationChannel\r\nimport android.app.NotificationManager\r\nimport android.app.PendingIntent\r\nimport android.content.Context\r\nimport android.content.Intent\r\nimport android.media.AudioAttributes\r\nimport android.media.RingtoneManager\r\nimport android.os.Build\r\nimport android.util.Log\r\nimport androidx.core.app.NotificationCompat\r\nimport com.google.firebase.messaging.FirebaseMessagingService\r\nimport com.google.firebase.messaging.RemoteMessage\r\n\r\nclass MyFirebaseMessagingService : FirebaseMessagingService() {\r\n\r\n    override fun onMessageReceived(remoteMessage: RemoteMessage) {\r\n        Log.d(TAG, \"From: ${remoteMessage.from}\")\r\n\r\n        var title: String = \"\uD83D\uDEA8 SECURITY ALERT \uD83D\uDEA8\"\r\n        var body: String = \"Motion detected!\"\r\n\r\n        // Check if message contains data payload (preferred for custom sound)\r\n        if (remoteMessage.data.isNotEmpty()) {\r\n            Log.d(TAG, \"Message data payload: ${remoteMessage.data}\")\r\n            // Data map returns nullable Strings; only replace when non-null\r\n            remoteMessage.data[\"title\"]?.let { title = it }\r\n            remoteMessage.data[\"body\"]?.let { body = it }\r\n            sendNotification(title, body)\r\n            return\r\n        }\r\n\r\n        // Check if message contains a notification payload\r\n        remoteMessage.notification?.let {\r\n            Log.d(TAG, \"Message Notification Body: ${it.body}\")\r\n            val nTitle = it.title ?: title\r\n            val nBody = it.body ?: body\r\n            sendNotification(nTitle, nBody)\r\n        }\r\n    }\r\n\r\n    override fun onNewToken(token: String) {\r\n        Log.d(TAG, \"Refreshed token: $token\")\r\n        sendRegistrationToServer(token)\r\n    }\r\n\r\n    private fun sendRegistrationToServer(token: String?) {\r\n        // TODO: Implement this method to send token to your app server.\r\n        Log.d(TAG, \"sendRegistrationTokenToServer($token)\")\r\n    }\r\n\r\n    private fun sendNotification(title: String, messageBody: String) {\r\n        // Append to alarm history as JSON objects (keep last 5)\r\n        try {\r\n            val prefs = getSharedPreferences(\"alarm_history\", Context.MODE_PRIVATE)\r\n            val key = \"recent_alarms_json\"\r\n            val existing = prefs.getString(key, \"[]\") ?: \"[]\"\r\n            val arr = org.json.JSONArray(existing)\r\n            val obj = org.json.JSONObject()\r\n            obj.put(\"time_ms\", System.currentTimeMillis())\r\n            obj.put(\"title\", title)\r\n            obj.put(\"message\", messageBody)\r\n            obj.put(\"zone\", org.json.JSONObject.NULL)\r\n            obj.put(\"severity\", \"warning\")\r\n            obj.put(\"sensors\", org.json.JSONArray())\r\n\r\n            val newArr = org.json.JSONArray()\r\n            newArr.put(obj)\r\n            var i = 0\r\n            while (i < arr.length() && newArr.length() < 5) {\r\n                try { newArr.put(arr.getJSONObject(i)) } catch (_: Exception) {}\r\n                i++\r\n            }\r\n            prefs.edit().putString(key, newArr.toString()).apply()\r\n        } catch (_: Exception) {}\r\n\r\n        // Determine if this incoming FCM should trigger a full-screen alarm\r\n        val isFullScreen = try {\r\n            title.contains(\"alert\", ignoreCase = true) || messageBody.contains(\"both sensors\", ignoreCase = true) || messageBody.contains(\"active\", ignoreCase = true)\r\n        } catch (_: Exception) { false }\r\n\r\n        if (isFullScreen) {\r\n            // Build alarm_json payload (mirror NotificationService behavior) and start full-screen activity\r\n            try {\r\n                val nowMs = System.currentTimeMillis()\r\n                val alarmObj = org.json.JSONObject()\r\n                alarmObj.put(\"zone\", title)\r\n                alarmObj.put(\"title\", title)\r\n                alarmObj.put(\"message\", messageBody)\r\n                alarmObj.put(\"time_ms\", nowMs)\r\n                alarmObj.put(\"severity\", \"critical\")\r\n                alarmObj.put(\"sensors\", org.json.JSONArray())\r\n\r\n                val directIntent = Intent(this, AlarmFullscreenActivity::class.java)\r\n                directIntent.putExtra(\"alarm_title\", title)\r\n                directIntent.putExtra(\"alarm_message\", messageBody)\r\n                directIntent.putExtra(\"alarm_time_ms\", nowMs)\r\n                directIntent.putExtra(\"alarm_json\", alarmObj.toString())\r\n                directIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP)\r\n\r\n                android.os.Handler(android.os.Looper.getMainLooper()).post {\r\n                    try {\r\n                        startActivity(directIntent)\r\n                        Log.d(TAG, \"Started AlarmFullscreenActivity directly for FCM full-screen alarm\")\r\n                    } catch (e: Exception) {\r\n                        Log.e(TAG, \"Failed to start AlarmFullscreenActivity from FCM\", e)\r\n                    }\r\n                }\r\n\r\n                // We intentionally do not post a notification for full-screen FCM messages\r\n                return\r\n            } catch (e: Exception) {\r\n                Log.w(TAG, \"Failed to launch full-screen alarm from FCM: ${e.message}\")\r\n                // Fall through to posting a regular notification below\r\n            }\r\n        }\r\n\r\n        val intent = Intent(this, MainActivity::class.java)\r\n        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP)\r\n        val requestCode = 0\r\n        val pendingIntent = PendingIntent.getActivity(\r\n            this,\r\n            requestCode,\r\n            intent,\r\n            PendingIntent.FLAG_IMMUTABLE,\r\n        )\r\n\r\n        // Choose channel: security channel for alerts, default silent otherwise\r\n        val securityChannelId = \"security_alerts\"\r\n        val defaultChannelId = getString(R.string.default_notification_channel_id)\r\n        val channelToUse = if (title.contains(\"security\", ignoreCase = true) || title.contains(\"alert\", ignoreCase = true)) securityChannelId else defaultChannelId\r\n\r\n        val notificationManager = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager\r\n\r\n        val notificationId = System.currentTimeMillis().toInt()\r\n\r\n        val notificationBuilder = NotificationCompat.Builder(this, channelToUse)\r\n            .setSmallIcon(R.drawable.ic_notification)\r\n            .setContentTitle(title)\r\n            .setContentText(messageBody)\r\n            .setAutoCancel(true)\r\n            .setContentIntent(pendingIntent)\r\n            .setPriority(NotificationCompat.PRIORITY_MAX)\r\n            .setCategory(NotificationCompat.CATEGORY_ALARM)\r\n            .setVibrate(longArrayOf(1000, 1000, 1000, 1000, 1000))\r\n            .setDefaults(0) // Don't use default sound, use channel sound\r\n            .addAction(\r\n                R.drawable.ic_notification,\r\n                \"Acknowledge\",\r\n                createAcknowledgeIntent(notificationId)\r\n            )\r\n\r\n        notificationManager.notify(notificationId, notificationBuilder.build())\r\n        Log.d(TAG, \"Security alarm notification sent with ID: $notificationId (channel=$channelToUse)\")\r\n    }\r\n\r\n    private fun createAcknowledgeIntent(notificationId: Int): PendingIntent {\r\n        val intent = Intent(this, NotificationActionReceiver::class.java)\r\n        intent.action = \"ACKNOWLEDGE_ALARM\"\r\n        intent.putExtra(\"notification_id\", notificationId)\r\n        return PendingIntent.getBroadcast(\r\n            this,\r\n            notificationId,\r\n            intent,\r\n            PendingIntent.FLAG_IMMUTABLE or PendingIntent.FLAG_UPDATE_CURRENT\r\n        )\r\n    }\r\n\r\n    companion object {\r\n        private const val TAG = \"MyFirebaseMsgService\"\r\n    }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/security/app/MyFirebaseMessagingService.kt b/app/src/main/java/com/security/app/MyFirebaseMessagingService.kt
--- a/app/src/main/java/com/security/app/MyFirebaseMessagingService.kt	(revision 44d69ffda4d1488978c0d0db75712de451938b41)
+++ b/app/src/main/java/com/security/app/MyFirebaseMessagingService.kt	(date 1766890021372)
@@ -27,6 +27,8 @@
             // Data map returns nullable Strings; only replace when non-null
             remoteMessage.data["title"]?.let { title = it }
             remoteMessage.data["body"]?.let { body = it }
+            // Record into recent activity log
+            try { appendToSecurityRecentActivity(title, body) } catch (_: Exception) {}
             sendNotification(title, body)
             return
         }
@@ -36,10 +38,26 @@
             Log.d(TAG, "Message Notification Body: ${it.body}")
             val nTitle = it.title ?: title
             val nBody = it.body ?: body
+            try { appendToSecurityRecentActivity(nTitle, nBody) } catch (_: Exception) {}
             sendNotification(nTitle, nBody)
         }
     }
 
+    // Append one line to the shared security recent activity preference
+    private fun appendToSecurityRecentActivity(title: String, messageBody: String) {
+        val ctx = applicationContext
+        val prefs = ctx.getSharedPreferences("app_prefs", Context.MODE_PRIVATE)
+        val existing = prefs.getString("security_recent_activity", "") ?: ""
+        val fmt = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.getDefault())
+        val timeStr = fmt.format(java.util.Date(System.currentTimeMillis()))
+        val line = "[$timeStr] ${title.trim()}: ${messageBody.trim()}"
+        val merged = if (existing.isEmpty()) line else existing + "\n" + line
+        // Trim to last 50 lines
+        val lines = merged.replace("\r\n", "\n").replace("\r", "\n").split("\n").filter { it.isNotBlank() }
+        val last50 = if (lines.size <= 50) lines else lines.takeLast(50)
+        prefs.edit().putString("security_recent_activity", last50.joinToString("\n")).apply()
+    }
+
     override fun onNewToken(token: String) {
         Log.d(TAG, "Refreshed token: $token")
         sendRegistrationToServer(token)
Index: app/src/main/res/layout/activity_main_dashboard.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<androidx.swiperefreshlayout.widget.SwipeRefreshLayout\r\n    xmlns:android=\"http://schemas.android.com/apk/res/android\"\r\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\r\n    android:id=\"@+id/swipeRefreshLayout\"\r\n    android:layout_width=\"match_parent\"\r\n    android:layout_height=\"match_parent\">\r\n\r\n    <ScrollView\r\n        android:layout_width=\"match_parent\"\r\n        android:layout_height=\"match_parent\"\r\n        android:fillViewport=\"true\">\r\n\r\n        <LinearLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:orientation=\"vertical\"\r\n            android:padding=\"16dp\">\r\n\r\n            <!-- Header Section -->\r\n            <LinearLayout\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"0dp\"\r\n                android:layout_weight=\"3\"\r\n                android:orientation=\"vertical\"\r\n                android:gravity=\"center\">\r\n\r\n                <RelativeLayout\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:gravity=\"center\">\r\n\r\n                    <TextView\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:text=\"\uD83C\uDFE0 Home Automation Hub\"\r\n                        android:textSize=\"28sp\"\r\n                        android:textColor=\"?android:attr/textColorPrimary\"\r\n                        android:textStyle=\"bold\"\r\n                        android:gravity=\"center\"\r\n                        android:layout_marginBottom=\"8dp\" />\r\n\r\n                    <!-- settings icon removed from main dashboard as requested -->\r\n                </RelativeLayout>\r\n\r\n                <!-- subtitle/status line removed per request -->\r\n\r\n                <TextView\r\n                    android:id=\"@+id/timestampText\"\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:text=\"Last Update: --:--\"\r\n                    android:textSize=\"14sp\"\r\n                    android:textColor=\"?android:attr/textColorSecondary\"\r\n                    android:gravity=\"center\"\r\n                    android:layout_marginTop=\"4dp\" />\r\n\r\n            </LinearLayout>\r\n\r\n\r\n            <!-- Dashboard Grid - Lower Quarter -->\r\n            <LinearLayout\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"0dp\"\r\n                android:layout_weight=\"1\"\r\n                android:orientation=\"vertical\">\r\n\r\n                <!-- Top Row -->\r\n                <LinearLayout\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:orientation=\"horizontal\"\r\n                    android:layout_marginBottom=\"8dp\">\r\n\r\n                    <!-- Security Block -->\r\n                    <androidx.cardview.widget.CardView\r\n                        android:id=\"@+id/securityCard\"\r\n                        android:layout_width=\"0dp\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:layout_weight=\"1\"\r\n                        android:layout_marginEnd=\"4dp\"\r\n                        app:cardBackgroundColor=\"#2D5016\"\r\n                        app:cardCornerRadius=\"12dp\"\r\n                        app:cardElevation=\"4dp\"\r\n                        xmlns:app=\"http://schemas.android.com/apk/res-auto\">\r\n\r\n                        <LinearLayout\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"match_parent\"\r\n                            android:orientation=\"vertical\"\r\n                            android:gravity=\"center\"\r\n                            android:padding=\"16dp\">\r\n\r\n                            <TextView\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"Security\"\r\n                                android:textSize=\"24sp\"\r\n                                android:textColor=\"#4CAF50\"\r\n                                android:textStyle=\"bold\"\r\n                                android:layout_marginBottom=\"4dp\" />\r\n\r\n                            <TextView\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"Security\"\r\n                                android:textSize=\"16sp\"\r\n                                android:textColor=\"#ffffff\"\r\n                                android:textStyle=\"bold\" />\r\n\r\n                            <TextView\r\n                                android:id=\"@+id/securityStatus\"\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"6 Zones Armed\"\r\n                                android:textSize=\"12sp\"\r\n                                android:textColor=\"#B8D4A0\" />\r\n\r\n                        </LinearLayout>\r\n                    </androidx.cardview.widget.CardView>\r\n\r\n                    <!-- SCADA Block -->\r\n                    <androidx.cardview.widget.CardView\r\n                        android:id=\"@+id/scadaCard\"\r\n                        android:layout_width=\"0dp\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:layout_weight=\"1\"\r\n                        android:layout_marginStart=\"4dp\"\r\n                        app:cardBackgroundColor=\"#1A237E\"\r\n                        app:cardCornerRadius=\"12dp\"\r\n                        app:cardElevation=\"4dp\">\r\n\r\n                        <LinearLayout\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"match_parent\"\r\n                            android:orientation=\"vertical\"\r\n                            android:gravity=\"center\"\r\n                            android:padding=\"16dp\">\r\n\r\n                            <TextView\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"SCADA\"\r\n                                android:textSize=\"24sp\"\r\n                                android:textColor=\"#FF9800\"\r\n                                android:textStyle=\"bold\"\r\n                                android:layout_marginBottom=\"4dp\" />\r\n\r\n                            <TextView\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"SCADA\"\r\n                                android:textSize=\"16sp\"\r\n                                android:textColor=\"#ffffff\"\r\n                                android:textStyle=\"bold\" />\r\n\r\n                            <TextView\r\n                                android:id=\"@+id/scadaStatus\"\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"Water: Normal\"\r\n                                android:textSize=\"12sp\"\r\n                                android:textColor=\"#9FA8DA\" />\r\n\r\n                        </LinearLayout>\r\n                    </androidx.cardview.widget.CardView>\r\n\r\n                </LinearLayout>\r\n\r\n                <!-- Bottom Row -->\r\n                <LinearLayout\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:orientation=\"horizontal\"\r\n                    android:layout_marginTop=\"8dp\">\r\n\r\n                    <!-- IDS Block -->\r\n                    <androidx.cardview.widget.CardView\r\n                        android:id=\"@+id/idsCard\"\r\n                        android:layout_width=\"0dp\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:layout_weight=\"1\"\r\n                        android:layout_marginEnd=\"4dp\"\r\n                        app:cardBackgroundColor=\"#BF360C\"\r\n                        app:cardCornerRadius=\"12dp\"\r\n                        app:cardElevation=\"4dp\">\r\n\r\n                        <LinearLayout\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"match_parent\"\r\n                            android:orientation=\"vertical\"\r\n                            android:gravity=\"center\"\r\n                            android:padding=\"16dp\">\r\n\r\n                            <TextView\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"IDS\"\r\n                                android:textSize=\"24sp\"\r\n                                android:textColor=\"#FF5722\"\r\n                                android:textStyle=\"bold\"\r\n                                android:layout_marginBottom=\"4dp\" />\r\n\r\n                            <TextView\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"IDS\"\r\n                                android:textSize=\"16sp\"\r\n                                android:textColor=\"#ffffff\"\r\n                                android:textStyle=\"bold\" />\r\n\r\n                            <TextView\r\n                                android:id=\"@+id/idsStatus\"\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"Controller Ready\"\r\n                                android:textSize=\"12sp\"\r\n                                android:textColor=\"#FFAB91\" />\r\n\r\n                        </LinearLayout>\r\n                    </androidx.cardview.widget.CardView>\r\n\r\n                    <!-- IPERL Block -->\r\n                    <androidx.cardview.widget.CardView\r\n                        android:id=\"@+id/iperlCard\"\r\n                        android:layout_width=\"0dp\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:layout_weight=\"1\"\r\n                        android:layout_marginStart=\"4dp\"\r\n                        app:cardBackgroundColor=\"#4A148C\"\r\n                        app:cardCornerRadius=\"12dp\"\r\n                        app:cardElevation=\"4dp\">\r\n\r\n                        <LinearLayout\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"match_parent\"\r\n                            android:orientation=\"vertical\"\r\n                            android:gravity=\"center\"\r\n                            android:padding=\"16dp\">\r\n\r\n                            <TextView\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"IPERL\"\r\n                                android:textSize=\"24sp\"\r\n                                android:textColor=\"#E91E63\"\r\n                                android:textStyle=\"bold\"\r\n                                android:layout_marginBottom=\"4dp\" />\r\n\r\n                            <TextView\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"IPERL\"\r\n                                android:textSize=\"16sp\"\r\n                                android:textColor=\"#ffffff\"\r\n                                android:textStyle=\"bold\" />\r\n\r\n                            <TextView\r\n                                android:id=\"@+id/iperlStatus\"\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"2 Meters Online\"\r\n                                android:textSize=\"12sp\"\r\n                                android:textColor=\"#E1BEE7\" />\r\n\r\n                        </LinearLayout>\r\n                    </androidx.cardview.widget.CardView>\r\n\r\n                </LinearLayout>\r\n\r\n            </LinearLayout>\r\n\r\n        </LinearLayout>\r\n    </ScrollView>\r\n</androidx.swiperefreshlayout.widget.SwipeRefreshLayout>\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/res/layout/activity_main_dashboard.xml b/app/src/main/res/layout/activity_main_dashboard.xml
--- a/app/src/main/res/layout/activity_main_dashboard.xml	(revision 44d69ffda4d1488978c0d0db75712de451938b41)
+++ b/app/src/main/res/layout/activity_main_dashboard.xml	(date 1766890021294)
@@ -43,6 +43,146 @@
                     <!-- settings icon removed from main dashboard as requested -->
                 </RelativeLayout>
 
+                <!-- Inserted: Outside Lights controller preview just below the title -->
+                <LinearLayout
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:orientation="vertical"
+                    android:layout_marginTop="12dp"
+                    android:layout_marginBottom="12dp">
+
+                    <LinearLayout
+                        android:layout_width="wrap_content"
+                        android:layout_height="wrap_content"
+                        android:orientation="horizontal"
+                        android:gravity="center_vertical"
+                        android:layout_marginBottom="8dp">
+
+                        <ImageView
+                            android:id="@+id/dashboardLightsTitleIcon"
+                            android:layout_width="20dp"
+                            android:layout_height="20dp"
+                            android:layout_marginEnd="8dp"
+                            android:src="@drawable/ic_lightbulb"
+                            app:tint="?android:attr/textColorPrimary"
+                            android:contentDescription="Lights" />
+
+                        <TextView
+                            android:id="@+id/dashboardLightsTitleText"
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="Outside Lights"
+                            android:textSize="18sp"
+                            android:textColor="?android:attr/textColorPrimary"
+                            android:textStyle="bold" />
+                    </LinearLayout>
+
+                    <androidx.cardview.widget.CardView
+                        android:layout_width="match_parent"
+                        android:layout_height="wrap_content"
+                        app:cardBackgroundColor="@android:color/transparent"
+                        app:cardCornerRadius="8dp"
+                        android:contentDescription="Outside lights controller">
+
+                        <LinearLayout
+                            android:layout_width="match_parent"
+                            android:layout_height="wrap_content"
+                            android:orientation="vertical"
+                            android:padding="12dp">
+
+                            <!-- Status row -->
+                            <LinearLayout
+                                android:layout_width="match_parent"
+                                android:layout_height="wrap_content"
+                                android:orientation="horizontal"
+                                android:gravity="center_vertical"
+                                android:layout_marginBottom="8dp">
+
+                                <TextView
+                                    android:layout_width="0dp"
+                                    android:layout_height="wrap_content"
+                                    android:layout_weight="1"
+                                    android:text="🔌 Status:"
+                                    android:textColor="#ffffff"
+                                    android:textSize="14sp" />
+
+                                <LinearLayout
+                                    android:layout_width="wrap_content"
+                                    android:layout_height="wrap_content"
+                                    android:orientation="horizontal"
+                                    android:gravity="center_vertical">
+
+                                    <ImageView
+                                        android:id="@+id/dashboardLightsStatusIcon"
+                                        android:layout_width="18dp"
+                                        android:layout_height="18dp"
+                                        android:src="@drawable/ic_lightbulb"
+                                        app:tint="#FF5722"
+                                        android:layout_marginEnd="6dp"
+                                        android:contentDescription="Lights status icon" />
+
+                                    <TextView
+                                        android:id="@+id/dashboardLightsStatusText"
+                                        android:layout_width="wrap_content"
+                                        android:layout_height="wrap_content"
+                                        android:text="OFF"
+                                        android:textColor="#FF5722"
+                                        android:textSize="14sp"
+                                        android:textStyle="bold" />
+                                </LinearLayout>
+                            </LinearLayout>
+
+                            <!-- Control buttons -->
+                            <LinearLayout
+                                android:layout_width="match_parent"
+                                android:layout_height="wrap_content"
+                                android:orientation="horizontal"
+                                android:gravity="center">
+
+                                <Button
+                                    android:id="@+id/dashboardLightsOnButton"
+                                    android:layout_width="0dp"
+                                    android:layout_height="48dp"
+                                    android:layout_weight="1"
+                                    android:layout_marginEnd="8dp"
+                                    android:text="LIGHTS ON"
+                                    android:drawableStart="@drawable/ic_lightbulb"
+                                    android:textColor="#ffffff"
+                                    android:backgroundTint="#4CAF50"
+                                    android:textSize="12sp"
+                                    android:textStyle="bold" />
+
+                                <Button
+                                    android:id="@+id/dashboardLightsOffButton"
+                                    android:layout_width="0dp"
+                                    android:layout_height="48dp"
+                                    android:layout_weight="1"
+                                    android:layout_marginStart="8dp"
+                                    android:text="LIGHTS OFF"
+                                    android:drawableStart="@drawable/ic_lightbulb"
+                                    android:textColor="#ffffff"
+                                    android:backgroundTint="#FF5722"
+                                    android:textSize="12sp"
+                                    android:textStyle="bold" />
+                            </LinearLayout>
+
+                            <!-- Technical details -->
+                            <TextView
+                                android:id="@+id/dashboardLightsDetails"
+                                android:layout_width="match_parent"
+                                android:layout_height="wrap_content"
+                                android:layout_marginTop="8dp"
+                                android:text="Sent TXT: -- | Y21_read: 0 | Last Command: --"
+                                android:visibility="gone"
+                                android:textColor="@color/light_grey"
+                                android:textSize="12sp"
+                                android:gravity="center" />
+
+                        </LinearLayout>
+                    </androidx.cardview.widget.CardView>
+
+                </LinearLayout>
+
                 <!-- subtitle/status line removed per request -->
 
                 <TextView
Index: app/src/main/java/com/security/app/ScadaActivity.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.security.app\r\n\r\nimport android.app.Activity\r\nimport android.content.Intent\r\nimport android.os.Bundle\r\nimport android.util.Log\r\nimport android.widget.TextView\r\nimport android.widget.ImageView\r\nimport android.content.res.ColorStateList\r\nimport androidx.activity.result.ActivityResult\r\nimport androidx.core.content.ContextCompat\r\nimport androidx.activity.result.ActivityResultLauncher\r\nimport androidx.activity.result.contract.ActivityResultContracts\r\nimport com.google.android.gms.auth.api.signin.GoogleSignIn\r\nimport com.google.android.gms.auth.api.signin.GoogleSignInAccount\r\nimport com.google.android.gms.auth.api.signin.GoogleSignInClient\r\nimport com.google.android.gms.auth.api.signin.GoogleSignInOptions\r\nimport com.google.android.gms.common.api.Scope\r\nimport com.google.api.client.googleapis.extensions.android.gms.auth.GoogleAccountCredential\r\nimport com.google.api.client.json.gson.GsonFactory\r\nimport com.google.api.services.drive.Drive\r\nimport com.google.api.services.drive.DriveScopes\r\nimport com.google.api.client.http.javanet.NetHttpTransport\r\nimport com.google.firebase.auth.FirebaseAuth\r\nimport com.google.firebase.auth.GoogleAuthProvider\r\nimport com.google.firebase.firestore.FirebaseFirestore\r\nimport com.google.firebase.firestore.ListenerRegistration\r\nimport com.google.firebase.firestore.DocumentSnapshot\r\nimport androidx.swiperefreshlayout.widget.SwipeRefreshLayout\r\nimport kotlinx.coroutines.CoroutineScope\r\nimport kotlinx.coroutines.Dispatchers\r\nimport kotlinx.coroutines.launch\r\nimport kotlinx.coroutines.withContext\r\nimport android.graphics.Color\r\nimport android.content.Context\r\nimport android.net.ConnectivityManager\r\nimport android.net.LinkProperties\r\nimport android.net.Network\r\nimport androidx.appcompat.app.AlertDialog\r\nimport android.widget.Button\r\nimport androidx.core.graphics.toColorInt\r\nimport androidx.core.content.edit\r\nimport java.util.Locale\r\nimport org.json.JSONObject\r\nimport org.json.JSONArray\r\nimport java.net.HttpURLConnection\r\nimport java.net.URL\r\nimport java.io.BufferedReader\r\nimport java.io.InputStreamReader\r\nimport java.text.SimpleDateFormat\r\nimport java.util.TimeZone\r\nimport kotlin.math.*\r\n\r\nclass ScadaActivity : BaseActivity() {\r\n\r\n    private lateinit var ampsTextView: TextView\r\n    private lateinit var kwTextView: TextView\r\n    private lateinit var diagnosticsText: TextView\r\n    private lateinit var geyserTempTextView: TextView\r\n    private lateinit var geyserPressureTextView: TextView\r\n    private lateinit var dvrTempTextView: TextView\r\n    private lateinit var dvrHeartbeatStatus: TextView\r\n    private lateinit var indoorTempTextView: TextView\r\n    private lateinit var outdoorTempTextView: TextView\r\n    private lateinit var outdoorHumidityTextView: TextView\r\n    private lateinit var windSpeedTextView: TextView\r\n    private lateinit var windDirectionTextView: ImageView\r\n    private lateinit var alarmActiveStatus: TextView\r\n    private lateinit var alarmStatusDot: ImageView\r\n    private lateinit var dvrStatusDot: ImageView\r\n    // Presence UI\r\n    private lateinit var setupPresenceText: TextView\r\n    private lateinit var setupPresenceDot: ImageView\r\n    private lateinit var checkNetworkButton: Button\r\n\r\n    // New: Sun & Tide UI\r\n    private lateinit var sunInfoTextView: TextView\r\n    private lateinit var tideInfoTextView: TextView\r\n\r\n    // Swakopmund coordinates (approx)\r\n    private val SWAK_LAT = -22.676f\r\n    private val SWAK_LON = 14.526f\r\n\r\n    // Embedded Stormglass API key (stored in repo per user request)\r\n    // NOTE: this key was provided by the user and is intentionally embedded for this private app.\r\n    private val EMBEDDED_STORMGLASS_API_KEY = \"7c29c9f4-c692-11f0-a8f4-0242ac130003-7c29ca6c-c692-11f0-a8f4-0242ac130003\"\r\n\r\n    // Trend arrow TextViews for geyser\r\n    private lateinit var waterTempTrendTextView: TextView\r\n    private lateinit var waterPressureTrendTextView: TextView\r\n    // Previous values for simple delta-based trend\r\n    private var prevWaterTemp: Double? = null\r\n    private var prevWaterPressure: Double? = null\r\n    // DVR pulse tracking for status dot (mirror NotificationService logic)\r\n    private var lastDvrPulse: Double? = null\r\n    private var lastDvrPulseTime: Long = 0L\r\n\r\n    // Helper: read numeric tolerance for DVR pulse comparisons\r\n    private fun getDvrPulseTolerance(): Double {\r\n        return try {\r\n            val prefs = getSharedPreferences(\"alarm_prefs\", Context.MODE_PRIVATE)\r\n            prefs.getFloat(\"dvr_pulse_tolerance\", 0.01f).toDouble()\r\n        } catch (_: Exception) { 0.01 }\r\n    }\r\n\r\n    // Firestore reference for security sensors\r\n    private lateinit var db: FirebaseFirestore\r\n\r\n    // Safe getter: returns a String representation of a field even when it's not stored as a String\r\n    private fun DocumentSnapshot.getStringSafe(field: String): String? {\r\n        return try {\r\n            val v = this.get(field)\r\n            when (v) {\r\n                is String -> v\r\n                is Number -> v.toString()\r\n                is Boolean -> v.toString()\r\n                is com.google.firebase.Timestamp -> try { v.toDate().toString() } catch (_: Exception) { null }\r\n                else -> v?.toString()\r\n            }\r\n        } catch (e: Exception) {\r\n            // In case of any unexpected casting exceptions, return null (caller can handle)\r\n            Log.w(\"ScadaActivity\", \"getStringSafe failed for field=$field: ${e.message}\")\r\n            null\r\n        }\r\n    }\r\n\r\n    // Google Sheets reader for geyser data\r\n    private lateinit var sheetsReader: GoogleSheetsReader\r\n    // DVR-specific sheet reader (separate gid)\r\n    private val dvrSheetsReader = DVRGoogleSheetsReader()\r\n\r\n    // Analytics variables\r\n    private lateinit var totalPointsValue: TextView\r\n    private lateinit var dataRateValue: TextView\r\n    private lateinit var activeSensorsValue: TextView\r\n    private lateinit var dailyPowerTextView: TextView\r\n    private var lastUpdateTime: Long = 0L\r\n    private var totalDataPoints: Int = 0\r\n    private var dataRate: Double = 0.0\r\n    private var activeSensors: Int = 0\r\n\r\n    // Data class for Geyser readings\r\n    data class GeyserReading(\r\n        val waterTemp: Double = 0.0,\r\n        val waterPressure: Double = 0.0,\r\n        val dvrTemp: Double = 0.0,\r\n        val currentAmps: Double = 0.0,\r\n        val currentPower: Double = 0.0,\r\n        val dailyPower: Double = 0.0,\r\n        val indoorTemp: Double = 0.0,\r\n        val outdoorTemp: Double = 0.0,\r\n        val humidity: Double = 0.0,\r\n        val windSpeed: Double = 0.0,\r\n        val windDirection: Float = 0f\r\n    )\r\n\r\n    // --- Lights Control Fields ---\r\n    // Icon + text views for lights status\r\n    private lateinit var lightsStatusIcon: ImageView\r\n    private lateinit var lightsStatusText: TextView\r\n    private lateinit var lightsDetails: TextView\r\n    // Polling job: limit reads to once every 30s up to 10 attempts (5 minutes)\r\n    private var lightsPollJob: kotlinx.coroutines.Job? = null\r\n    // Drive polling job (so we can cancel it when switching backends)\r\n    private var drivePollingJob: kotlinx.coroutines.Job? = null\r\n\r\n    // Google Drive API\r\n    private lateinit var googleSignInClient: GoogleSignInClient\r\n    private var driveService: Drive? = null\r\n    // Activity Result launcher replaces deprecated startActivityForResult\r\n    private lateinit var signInLauncher: ActivityResultLauncher<Intent>\r\n\r\n    private lateinit var auth: FirebaseAuth\r\n    // Firestore listener registration for lights_status\r\n    private var lightsStatusListener: ListenerRegistration? = null\r\n\r\n    override fun onCreate(savedInstanceState: Bundle?) {\r\n        Log.d(\"ScadaActivity\", \"onCreate called\")\r\n        super.onCreate(savedInstanceState)\r\n        setContentView(R.layout.activity_scada)\r\n\r\n        // Initialize Activity Result launcher for Google Sign-In\r\n        signInLauncher = registerForActivityResult(ActivityResultContracts.StartActivityForResult()) { result: ActivityResult ->\r\n            try {\r\n                if (result.resultCode == Activity.RESULT_OK) {\r\n                    val dataIntent = result.data\r\n                    val task = GoogleSignIn.getSignedInAccountFromIntent(dataIntent)\r\n                    if (task.isSuccessful) {\r\n                        val account = task.result\r\n                        if (account?.idToken.isNullOrEmpty()) {\r\n                            try { ToastHelper.show(this@ScadaActivity, getString(R.string.google_signin_failed_missing_idtoken), android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                            return@registerForActivityResult\r\n                        }\r\n                        // account non-null here\r\n                        firebaseAuthWithGoogle(account)\r\n                        initializeDriveService(account)\r\n                    } else {\r\n                        try { ToastHelper.show(this@ScadaActivity, getString(R.string.google_signin_failed_generic, task.exception?.localizedMessage ?: \"\"), android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                    }\r\n                } else {\r\n                    try { ToastHelper.show(this@ScadaActivity, getString(R.string.google_signin_cancelled), android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                }\r\n            } catch (e: Exception) {\r\n                Log.w(\"ScadaActivity\", \"Sign-in launcher callback error\", e)\r\n                try { ToastHelper.show(this@ScadaActivity, getString(R.string.google_signin_failed_generic, e.localizedMessage ?: \"\"), android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n            }\r\n        }\r\n\r\n        // Initialize views with amps prominent, kW smaller as requested\r\n        diagnosticsText = findViewById(R.id.diagnosticsText)\r\n        ampsTextView = findViewById(R.id.currentAmps)\r\n        kwTextView = findViewById(R.id.currentPower)\r\n        geyserTempTextView = findViewById(R.id.waterTempValue)\r\n        geyserPressureTextView = findViewById(R.id.waterPressureValue)\r\n        dvrTempTextView = findViewById(R.id.dvrTemp)\r\n        dvrHeartbeatStatus = findViewById(R.id.dvrHeartbeatStatus)\r\n        indoorTempTextView = findViewById(R.id.indoorTemp)\r\n        outdoorTempTextView = findViewById(R.id.outdoorTemp)\r\n        outdoorHumidityTextView = findViewById(R.id.outdoorHumidity)\r\n        windSpeedTextView = findViewById(R.id.windSpeed)\r\n        windDirectionTextView = findViewById(R.id.windDirectionArrow)\r\n        alarmActiveStatus = findViewById(R.id.alarmActiveStatus)\r\n        // status dots\r\n        alarmStatusDot = findViewById(R.id.alarmStatusDot)\r\n        dvrStatusDot = findViewById(R.id.dvrStatusDot)\r\n\r\n        // New: bind sun/tide views (layout added)\r\n        try {\r\n            sunInfoTextView = findViewById(R.id.sunInfo)\r\n            tideInfoTextView = findViewById(R.id.tideInfo)\r\n            // Ensure the tide view is clickable and opens the WorldTides key dialog on click or long-press\r\n            try {\r\n                tideInfoTextView.isClickable = true\r\n                tideInfoTextView.isLongClickable = true\r\n                tideInfoTextView.setOnClickListener { showStormglassKeyDialog() }\r\n                tideInfoTextView.setOnLongClickListener {\r\n                    showStormglassKeyDialog(); true\r\n                }\r\n\r\n                // Also attach handlers to the parent CardView (user may long-press the whole card)\r\n                try {\r\n                    var vp: android.view.ViewParent? = tideInfoTextView.parent\r\n                    while (vp != null) {\r\n                        if (vp is androidx.cardview.widget.CardView) {\r\n                            vp.isClickable = true\r\n                            vp.isLongClickable = true\r\n                            vp.setOnClickListener { showStormglassKeyDialog() }\r\n                            vp.setOnLongClickListener { showStormglassKeyDialog(); true }\r\n                            break\r\n                        }\r\n                        vp = vp.parent\r\n                    }\r\n                } catch (e: Exception) {\r\n                    Log.w(\"ScadaActivity\", \"Failed attaching click to parent card\", e)\r\n                }\r\n            } catch (e: Exception) {\r\n                Log.w(\"ScadaActivity\", \"tideInfoTextView click/long-click binding failed\", e)\r\n            }\r\n        } catch (_: Exception) {\r\n            // Layout may not include the new views in older variants — tolerate silently\r\n        }\r\n\r\n        // Presence UI bindings (setup card)\r\n        try {\r\n            setupPresenceText = findViewById(R.id.setupPresenceText)\r\n            setupPresenceDot = findViewById(R.id.setupPresenceDot)\r\n            checkNetworkButton = findViewById(R.id.checkNetworkButton)\r\n            checkNetworkButton.setOnClickListener { updatePresenceUI(true) }\r\n        } catch (_: Exception) {}\r\n\r\n        // Initial presence update\r\n        updatePresenceUI(false)\r\n\r\n        // Wind invert is now managed solely in the Alarm Settings dialog (no inline control)\r\n\r\n        // Bind trend arrow TextViews\r\n        waterTempTrendTextView = findViewById(R.id.waterTempTrend)\r\n        waterPressureTrendTextView = findViewById(R.id.waterPressureTrend)\r\n\r\n        // Initialize Firestore for security sensors\r\n        db = FirebaseFirestore.getInstance()\r\n        // Start a single Firestore snapshot listener for lights_status so the bulb indicator updates live\r\n        setupLightsListener()\r\n\r\n        // Initialize FirebaseAuth now so lights button handlers can check sign-in state\r\n        auth = FirebaseAuth.getInstance()\r\n\r\n        // Initialize Google Sheets reader for geyser data\r\n        sheetsReader = GoogleSheetsReader()\r\n\r\n        // Set initial values to show amps prominent, kW smaller layout\r\n        ampsTextView.text = getString(R.string.dash_amp)  // Amps prominently displayed\r\n        kwTextView.text = getString(R.string.dash_kw)  // kW smaller on side\r\n        geyserTempTextView.text = getString(R.string.loading_sheets)\r\n        geyserPressureTextView.text = getString(R.string.loading_sheets)\r\n        dvrTempTextView.text = getString(R.string.dvr_label)\r\n        indoorTempTextView.text = \"--°C\"\r\n        outdoorTempTextView.text = \"--°C\"\r\n        outdoorHumidityTextView.text = \"--%\"\r\n        windSpeedTextView.text = getString(R.string.dash_wind)\r\n        windDirectionTextView.setImageResource(R.drawable.ic_wind_arrow) // Set default wind direction icon\r\n        // initialize status dot colors from default text/colors\r\n        try {\r\n            // Default: assume DVR online (green)\r\n            val green = \"#4CAF50\".toColorInt()\r\n            dvrStatusDot.imageTintList = ColorStateList.valueOf(green)\r\n        } catch (_: Exception) {}\r\n        try {\r\n            // Default alarm state - match existing alarmActiveStatus text color if present\r\n            val green = \"#4CAF50\".toColorInt()\r\n            alarmStatusDot.imageTintList = ColorStateList.valueOf(green)\r\n        } catch (_: Exception) {}\r\n\r\n        // Initialize analytics TextViews\r\n        totalPointsValue = findViewById(R.id.totalPointsValue)\r\n        dataRateValue = findViewById(R.id.dataRateValue)\r\n        activeSensorsValue = findViewById(R.id.activeSensorsValue)\r\n        // Bind SCADA daily power card so it displays the parsed daily total (column J)\r\n        dailyPowerTextView = findViewById(R.id.dailyPower)\r\n        dailyPowerTextView.text = \"-- kWh\"\r\n\r\n        // Lights control views\r\n        lightsStatusIcon = findViewById(R.id.lightsStatusIcon)\r\n        lightsStatusText = findViewById(R.id.lightsStatusText)\r\n        lightsDetails = findViewById(R.id.lightsDetails)\r\n        // Setup lights control buttons\r\n        val lightsOnButton = findViewById<android.widget.Button>(R.id.lightsOnButton)\r\n        val lightsOffButton = findViewById<android.widget.Button>(R.id.lightsOffButton)\r\n        // Enable buttons immediately so users can send Firebase/bridge commands even when Drive isn't signed-in.\r\n        lightsOnButton.isEnabled = true\r\n        lightsOffButton.isEnabled = true\r\n        Log.d(\"ScadaActivity\", \"Lights buttons enabled at startup\")\r\n        // New: Firestore-based lights commands (replace Drive-based flow)\r\n        val dbFs = FirebaseFirestore.getInstance()\r\n        // Bridge expects Flights_commands/current_command — write there as well for compatibility with the local bridge\r\n        val bridgeCmdDoc = dbFs.collection(\"Flights_commands\").document(\"current_command\")\r\n\r\n        // Helper that writes a bridge-compatible payload to Flights_commands/current_command\r\n        fun writeBridgeCommand(desired: Boolean, onSuccess: (() -> Unit)? = null, onFailure: ((Exception) -> Unit)? = null) {\r\n            try {\r\n                val bridgePayload = hashMapOf<String, Any>(\r\n                    \"desired\" to desired,\r\n                    \"desired_ts\" to com.google.firebase.firestore.FieldValue.serverTimestamp(),\r\n                    \"command\" to if (desired) \"on\" else \"off\",\r\n                    \"command_ts\" to com.google.firebase.firestore.FieldValue.serverTimestamp(),\r\n                    \"command_source\" to \"android_app\"\r\n                )\r\n\r\n                bridgeCmdDoc.set(bridgePayload, com.google.firebase.firestore.SetOptions.merge())\r\n                    .addOnSuccessListener {\r\n                        Log.d(\"ScadaActivity\", \"Wrote bridge command doc (desired=$desired)\")\r\n                        // Read back the document to confirm the write landed and log/notify user for debugging\r\n                        try {\r\n                            bridgeCmdDoc.get()\r\n                                .addOnSuccessListener { bdoc ->\r\n                                    Log.d(\"ScadaActivity\", \"bridgeCmdDoc after write: ${bdoc.data}\")\r\n                                    val sb = bdoc.data?.toString() ?: \"(no bridge doc)\"\r\n                                    try { ToastHelper.show(this@ScadaActivity, getString(R.string.bridge_doc_readback, sb), android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                                }\r\n                                .addOnFailureListener { e -> Log.w(\"ScadaDiag\", \"Failed reading bridgeCmdDoc\", e) }\r\n                        } catch (e: Exception) {\r\n                            Log.w(\"ScadaDiag\", \"Readback failed\", e)\r\n                        }\r\n                        onSuccess?.invoke()\r\n                    }\r\n                    .addOnFailureListener { e ->\r\n                        Log.e(\"ScadaActivity\", \"Failed writing bridge command doc\", e)\r\n                        // Log current auth state for diagnosis\r\n                        try {\r\n                            val currentUser = auth?.currentUser\r\n                            Log.d(\"ScadaActivity\", \"Firebase auth currentUser uid=${currentUser?.uid} email=${currentUser?.email}\")\r\n                        } catch (_: Exception) {}\r\n\r\n                        // Enhanced handling: if PERMISSION_DENIED, prompt user to re-authenticate\r\n                        val isPermError = try {\r\n                            (e is com.google.firebase.firestore.FirebaseFirestoreException && e.code == com.google.firebase.firestore.FirebaseFirestoreException.Code.PERMISSION_DENIED)\r\n                                    || (e?.message?.contains(\"PERMISSION_DENIED\", ignoreCase = true) == true)\r\n                        } catch (_: Exception) { false }\r\n\r\n                        if (isPermError) {\r\n                            runOnUiThread {\r\n                                try {\r\n                                    androidx.appcompat.app.AlertDialog.Builder(this@ScadaActivity)\r\n                                        .setTitle(R.string.error_short)\r\n                                        .setMessage(\"Permission error sending bridge command:\\n${e?.message}\\n\\nWould you like to sign in to Google to restore permissions?\")\r\n                                        .setPositiveButton(android.R.string.ok, { _, _ -> try { ensureFreshGoogleSignIn() } catch (_: Exception) {} })\r\n                                        .setNegativeButton(android.R.string.cancel, null)\r\n                                        .show()\r\n                                } catch (_: Exception) {\r\n                                    try { ToastHelper.show(this@ScadaActivity, \"Permission error: ${e?.message}\", android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                                }\r\n                            }\r\n                        } else {\r\n                            onFailure?.invoke(e)\r\n                        }\r\n                    }\r\n            } catch (e: Exception) {\r\n                Log.e(\"ScadaActivity\", \"Exception preparing bridge payload\", e)\r\n                onFailure?.invoke(e)\r\n            }\r\n        }\r\n\r\n        lightsOnButton.setOnClickListener {\r\n             Log.d(\"ScadaActivity\", \"Lights ON clicked — writing bridge command\")\r\n             writeBridgeCommand(true,\r\n                 onSuccess = {\r\n                     ToastHelper.show(this@ScadaActivity, getString(R.string.bridge_command_on_sent), android.widget.Toast.LENGTH_SHORT)\r\n                     try { startLightsPolling() } catch (_: Exception) {}\r\n                 },\r\n                 onFailure = { e ->\r\n                     Log.e(\"ScadaActivity\", \"Lights ON write failed\", e)\r\n                     try {\r\n                         val currentUser = auth?.currentUser\r\n                         Log.d(\"ScadaActivity\", \"auth.currentUser uid=${currentUser?.uid} email=${currentUser?.email}\")\r\n                     } catch (_: Exception) {}\r\n                     val errMsg = try { e?.message ?: e.toString() } catch (_: Exception) { \"Unknown error\" }\r\n                     val isPerm = try {\r\n                         (e is com.google.firebase.firestore.FirebaseFirestoreException && e.code == com.google.firebase.firestore.FirebaseFirestoreException.Code.PERMISSION_DENIED)\r\n                                 || errMsg.contains(\"PERMISSION_DENIED\", ignoreCase = true)\r\n                     } catch (_: Exception) { false }\r\n                     if (isPerm) {\r\n                         runOnUiThread {\r\n                             try {\r\n                                 androidx.appcompat.app.AlertDialog.Builder(this@ScadaActivity)\r\n                                     .setTitle(R.string.error_short)\r\n                                     .setMessage(\"Permission error sending bridge command:\\n$errMsg\\n\\nWould you like to sign in to Google to restore permissions?\")\r\n                                     .setPositiveButton(android.R.string.ok, { _, _ -> try { ensureFreshGoogleSignIn() } catch (_: Exception) {} })\r\n                                     .setNegativeButton(android.R.string.cancel, null)\r\n                                     .show()\r\n                             } catch (_: Exception) {\r\n                                 try { ToastHelper.show(this@ScadaActivity, \"Permission error: $errMsg\", android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                             }\r\n                         }\r\n                     } else {\r\n                         try { ToastHelper.show(this@ScadaActivity, getString(R.string.failed_send_bridge_command, errMsg), android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                         try { ensureFreshGoogleSignIn() } catch (_: Exception) {}\r\n                     }\r\n                 }\r\n             )\r\n         }\r\n\r\n         lightsOffButton.setOnClickListener {\r\n             Log.d(\"ScadaActivity\", \"Lights OFF clicked — writing bridge command\")\r\n             writeBridgeCommand(false,\r\n                 onSuccess = {\r\n                     ToastHelper.show(this@ScadaActivity, getString(R.string.bridge_command_off_sent), android.widget.Toast.LENGTH_SHORT)\r\n                     try { startLightsPolling() } catch (_: Exception) {}\r\n                 },\r\n                 onFailure = { e ->\r\n                     Log.e(\"ScadaActivity\", \"Lights OFF write failed\", e)\r\n                     try {\r\n                         val currentUser = auth?.currentUser\r\n                         Log.d(\"ScadaActivity\", \"auth.currentUser uid=${currentUser?.uid} email=${currentUser?.email}\")\r\n                     } catch (_: Exception) {}\r\n                     val errMsg = try { e?.message ?: e.toString() } catch (_: Exception) { \"Unknown error\" }\r\n                     val isPerm = try {\r\n                         (e is com.google.firebase.firestore.FirebaseFirestoreException && e.code == com.google.firebase.firestore.FirebaseFirestoreException.Code.PERMISSION_DENIED)\r\n                                 || errMsg.contains(\"PERMISSION_DENIED\", ignoreCase = true)\r\n                     } catch (_: Exception) { false }\r\n                     if (isPerm) {\r\n                         runOnUiThread {\r\n                             try {\r\n                                 androidx.appcompat.app.AlertDialog.Builder(this@ScadaActivity)\r\n                                     .setTitle(R.string.error_short)\r\n                                     .setMessage(\"Permission error sending bridge command:\\n$errMsg\\n\\nWould you like to sign in to Google to restore permissions?\")\r\n                                     .setPositiveButton(android.R.string.ok, { _, _ -> try { ensureFreshGoogleSignIn() } catch (_: Exception) {} })\r\n                                     .setNegativeButton(android.R.string.cancel, null)\r\n                                     .show()\r\n                             } catch (_: Exception) {\r\n                                 try { ToastHelper.show(this@ScadaActivity, \"Permission error: $errMsg\", android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                             }\r\n                         }\r\n                     } else {\r\n                         try { ToastHelper.show(this@ScadaActivity, getString(R.string.failed_send_bridge_command, errMsg), android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                         try { ensureFreshGoogleSignIn() } catch (_: Exception) {}\r\n                     }\r\n                 }\r\n             )\r\n         }\r\n\r\n        // Setup click listeners for graphs\r\n        setupGraphClickListeners()\r\n\r\n        // diagnosticsText long-press removed — appearance controls moved into the Settings dialog (alarmStatusCard).\r\n\r\n        // Firebase monitoring removed - all data now from Google Sheets\r\n\r\n        // Start Google Sheets monitoring for geyser data\r\n        monitorGeyserData()\r\n\r\n        // Also update sun/tide info now\r\n        try { updateSunAndTides() } catch (e: Exception) { Log.w(\"ScadaActivity\", \"updateSunAndTides failed\", e) }\r\n\r\n        // Setup Google Drive sign-in\r\n        setupGoogleDriveSignIn()\r\n        // Start polling for Y21_read_status from Drive file\r\n        startY21ReadPolling()\r\n\r\n        // Alarm status card opens settings dialog\r\n        findViewById<androidx.cardview.widget.CardView>(R.id.alarmStatusCard).setOnClickListener {\r\n            openAlarmSettingsDialog()\r\n        }\r\n\r\n        // If launched with open_setup extra, display the setup dialog immediately\r\n        try {\r\n            val openSetup = intent?.getBooleanExtra(\"open_setup\", false) ?: false\r\n            if (openSetup) {\r\n                android.os.Handler(android.os.Looper.getMainLooper()).post {\r\n                    openAlarmSettingsDialog()\r\n                }\r\n            }\r\n        } catch (_: Exception) {}\r\n\r\n        // Google Sign-In button\r\n        val signInButton = findViewById<com.google.android.gms.common.SignInButton>(R.id.googleSignInButton)\r\n        signInButton.setOnClickListener {\r\n            val gso = GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)\r\n                .requestEmail()\r\n                .requestIdToken(getString(R.string.default_web_client_id))\r\n                .requestScopes(Scope(DriveScopes.DRIVE)) // Changed from DRIVE_FILE to DRIVE\r\n                .build()\r\n            googleSignInClient = GoogleSignIn.getClient(this, gso)\r\n            signInLauncher.launch(googleSignInClient.signInIntent)\r\n        }\r\n\r\n        // Setup swipe to refresh\r\n        val swipeRefreshLayout = findViewById<SwipeRefreshLayout>(R.id.swipeRefreshLayout)\r\n        swipeRefreshLayout.setOnRefreshListener {\r\n            refreshData()\r\n            swipeRefreshLayout.isRefreshing = false\r\n        }\r\n    }\r\n\r\n    private fun refreshData() {\r\n        monitorGeyserData()\r\n        try { ToastHelper.show(this@ScadaActivity, \"Data refreshed\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n    }\r\n\r\n    private fun setupGraphClickListeners() {\r\n        // Weather section click - show weather graphs\r\n        findViewById<android.widget.LinearLayout>(R.id.weatherSection).setOnClickListener {\r\n            val intent = Intent(this, WeatherGraphsActivity::class.java)\r\n            startActivity(intent)\r\n        }\r\n\r\n        // Power section click - show power graphs\r\n        findViewById<androidx.cardview.widget.CardView>(R.id.powerSection).setOnClickListener {\r\n            val intent = Intent(this, PowerGraphsActivity::class.java)\r\n            startActivity(intent)\r\n        }\r\n\r\n        // Geyser section click - show geyser graphs\r\n        findViewById<androidx.cardview.widget.CardView>(R.id.geyserSection).setOnClickListener {\r\n            val intent = Intent(this, GeyserGraphsActivity::class.java)\r\n            startActivity(intent)\r\n        }\r\n\r\n        // DVR section click - show DVR graphs\r\n        findViewById<androidx.cardview.widget.CardView>(R.id.dvrSection).setOnClickListener {\r\n            val intent = Intent(this, DvrGraphsActivity::class.java)\r\n            startActivity(intent)\r\n        }\r\n\r\n        // Back button functionality\r\n        findViewById<android.widget.TextView>(R.id.scadaBackButton).setOnClickListener {\r\n            finish()\r\n        }\r\n    }\r\n\r\n    // Firebase monitoring removed - all data now comes from Google Sheets\r\n\r\n    private fun updateAnalytics() {\r\n        // Count data points (all fields are always present)\r\n        val points = 10 // number of fields in GeyserReading\r\n        val currentTime = System.currentTimeMillis()\r\n        if (lastUpdateTime != 0L) {\r\n            val timeDiffMin = (currentTime - lastUpdateTime) / 60000.0\r\n            if (timeDiffMin > 0) {\r\n                dataRate = points / timeDiffMin\r\n            }\r\n        }\r\n        lastUpdateTime = currentTime\r\n        totalDataPoints += points\r\n        activeSensors = points\r\n        // Update UI\r\n        totalPointsValue.text = totalDataPoints.toString()\r\n        dataRateValue.text = String.format(Locale.getDefault(), \"%.1f/min\", dataRate)\r\n        activeSensorsValue.text = activeSensors.toString()\r\n    }\r\n\r\n    private fun monitorGeyserData() {\r\n        // Launch coroutine to fetch geyser data from Google Sheets\r\n        CoroutineScope(Dispatchers.Main).launch {\r\n            try {\r\n                // Update the last updated time\r\n                val sdf = java.text.SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\", Locale.getDefault())\r\n                val lastUpdated = sdf.format(java.util.Date())\r\n                val existingText = diagnosticsText.text.toString()\r\n                val newText = existingText.replace(Regex(\"Last Update: .*\"), \"Last Update: $lastUpdated\")\r\n                diagnosticsText.text = newText\r\n                // Fetch latest readings from Google Sheets (real geyser data)\r\n                val sensorReadings = withContext(Dispatchers.IO) {\r\n                     sheetsReader.fetchLatestReadings(2) // Get the two most recent readings so we can compute an initial trend immediately\r\n                 }\r\n\r\n                // Debugging: if parser returned no data or weather fields are all zero, fetch raw CSV and try alternate gids\r\n                if (sensorReadings.isEmpty() || (sensorReadings[0].outdoorTemp == 0.0f && sensorReadings[0].humidity == 0.0f && sensorReadings[0].windSpeed == 0.0f)) {\r\n                    try {\r\n                        Log.w(\"ScadaActivity\", \"SheetsReader returned empty/zero weather; dumping raw CSV and trying alternate gids for diagnosis\")\r\n                        // Log first few lines of the default gid CSV\r\n                        val rawCsv0 = withContext(Dispatchers.IO) { sheetsReader.fetchRawCsvForGid(0) }\r\n                        if (rawCsv0 != null) {\r\n                            val head = rawCsv0.split('\\n').take(10).joinToString(\"\\\\n\")\r\n                            Log.w(\"ScadaActivity\", \"CSV gid=0 head:\\n$head\")\r\n                        } else {\r\n                            Log.w(\"ScadaActivity\", \"CSV gid=0 returned null\")\r\n                        }\r\n\r\n                        // Try common alternate gids (0..5) and log parsed samples\r\n                        for (gid in 0..5) {\r\n                            try {\r\n                                val parsedSample = withContext(Dispatchers.IO) { sheetsReader.fetchRecentReadingsFromGid(gid, 24, 5) }\r\n                                Log.w(\"ScadaActivity\", \"Parsed from gid=$gid count=${parsedSample.size} sample=${parsedSample.firstOrNull()}\")\r\n                            } catch (e: Exception) {\r\n                                Log.w(\"ScadaActivity\", \"fetchRecentReadingsFromGid failed for gid=$gid\", e)\r\n                            }\r\n                        }\r\n                    } catch (e: Exception) {\r\n                        Log.w(\"ScadaActivity\", \"Sheets debug diagnostics failed\", e)\r\n                    }\r\n                }\r\n\r\n                 if (sensorReadings.isNotEmpty()) {\r\n                    // If we have two rows, set previous values from the older row (index 1) so the trend arrow can be computed immediately\r\n                    if (sensorReadings.size >= 2) {\r\n                        val older = sensorReadings[1]\r\n                        prevWaterTemp = older.waterTemp.toDouble()\r\n                        prevWaterPressure = older.waterPressure.toDouble()\r\n                    }\r\n                    // Convert SensorReading to GeyserReading\r\n                    val s = sensorReadings[0] // most recent row\r\n                    try { android.util.Log.d(\"ScadaActivity\", \"SensorReading row parsed: $s\") } catch (_: Exception) {}\r\n                    val latestReading = GeyserReading(\r\n                        waterTemp = s.waterTemp.toDouble(),\r\n                        waterPressure = s.waterPressure.toDouble(),\r\n                        dvrTemp = s.dvrTemp.toDouble(),\r\n                        currentAmps = s.currentAmps.toDouble(),\r\n                        currentPower = s.currentPower.toDouble(),\r\n                        dailyPower = s.dailyPower.toDouble(),\r\n                        indoorTemp = s.indoorTemp.toDouble(),\r\n                        outdoorTemp = s.outdoorTemp.toDouble(),\r\n                        humidity = s.humidity.toDouble(),\r\n                        windSpeed = s.windSpeed.toDouble(),\r\n                        windDirection = s.windDirection\r\n                    )\r\n                    // Update UI with REAL data from Google Sheets (LAST ROW)\r\n                    updateAnalytics()\r\n                    geyserTempTextView.text = String.format(Locale.getDefault(), \"%.1f°C\", latestReading.waterTemp)\r\n                    geyserPressureTextView.text = String.format(Locale.getDefault(), \"%.1f bar\", latestReading.waterPressure)\r\n                    // Show daily power (kWh) on the SCADA card\r\n                    dailyPowerTextView.text = String.format(Locale.getDefault(), \"%.1f kWh\", latestReading.dailyPower)\r\n                    // Handle DVR temperature: prefer the DVR-specific gid (used by the DVR graphs) so the card and graph match.\r\n                    try {\r\n                        // Prefer the DVR value already loaded into GraphDataRepository (the graph source) so the card matches the graph.\r\n                        // If repository has no data, fall back to a short DVR gid network fetch, otherwise use the general sheet value.\r\n                        var sourceDvr: Double = latestReading.dvrTemp\r\n                        try {\r\n                            val repoLatest = GraphDataRepository.dvrGraphData.value.lastOrNull()?.dvrTemp\r\n                            if (repoLatest != null) {\r\n                                sourceDvr = repoLatest.toDouble()\r\n                                Log.d(\"ScadaActivity\", \"Using DVR value from GraphDataRepository for card: $sourceDvr\")\r\n                            } else {\r\n                                // Repository empty — attempt a short network fetch of DVR gid (non-blocking network done on IO)\r\n                                try {\r\n                                    val fetchedReading = withContext(Dispatchers.IO) { dvrSheetsReader.fetchLatestDvrReading() }\r\n                                    if (fetchedReading != null) {\r\n                                        sourceDvr = fetchedReading.dvrTemp.toDouble()\r\n                                        Log.d(\"ScadaActivity\", \"Fetched DVR gid value for card: $sourceDvr\")\r\n                                    }\r\n                                } catch (e: Exception) {\r\n                                    Log.w(\"ScadaActivity\", \"DVR gid network fetch failed; will use general sheet value\", e)\r\n                                }\r\n                            }\r\n                        } catch (e: Exception) {\r\n                            Log.w(\"ScadaActivity\", \"Failed resolving preferred DVR source; using general sheet value\", e)\r\n                        }\r\n                        var displayDvr = sourceDvr\r\n\r\n                        // If the reading looks like Kelvin (hot: >200), convert to Celsius\r\n                        if (displayDvr.isFinite() && displayDvr > 200.0) {\r\n                            val conv = displayDvr - 273.15\r\n                            android.util.Log.i(\"ScadaActivity\", \"DVR reading looks like Kelvin; converting: raw=$displayDvr K -> ${String.format(Locale.getDefault(), \"%.2f\", conv)} °C\")\r\n                            displayDvr = conv\r\n                        }\r\n\r\n                        // If the value is obviously out of range (too hot or invalid), attempt a DVR gid fallback read in background\r\n                        if (!displayDvr.isFinite() || displayDvr > 120.0 || displayDvr < -50.0) {\r\n                            android.util.Log.w(\"ScadaActivity\", \"DVR reading out of range (raw=$sourceDvr -> display=$displayDvr); attempting DVR-specific fallback read\")\r\n                            try {\r\n                                CoroutineScope(Dispatchers.IO).launch {\r\n                                    val dvrRow = dvrSheetsReader.fetchLatestDvrReading()\r\n                                    if (dvrRow != null) {\r\n                                        val d = dvrRow\r\n                                        var dval = d.dvrTemp.toDouble()\r\n                                        if (dval.isFinite() && dval > 200.0) dval -= 273.15\r\n                                        withContext(Dispatchers.Main) {\r\n                                            try {\r\n                                                if (dval.isFinite() && dval <= 120.0 && dval >= -50.0) {\r\n                                                    dvrTempTextView.text = String.format(Locale.getDefault(), \"%.1f°C\", dval)\r\n                                                    lastDvrPulse = dval\r\n                                                    lastDvrPulseTime = System.currentTimeMillis()\r\n                                                    android.util.Log.i(\"ScadaActivity\", \"DVR fallback read successful: $dval °C\")\r\n                                                } else {\r\n                                                    dvrTempTextView.text = \"N/A\"\r\n                                                }\r\n                                            } catch (_: Exception) {}\r\n                                        }\r\n                                    } else {\r\n                                        withContext(Dispatchers.Main) { try { dvrTempTextView.text = \"N/A\" } catch (_: Exception) {} }\r\n                                    }\r\n                                }\r\n                            } catch (e: Exception) {\r\n                                android.util.Log.w(\"ScadaActivity\", \"DVR fallback read kicked off failed\", e)\r\n                                try { dvrTempTextView.text = \"N/A\" } catch (_: Exception) {}\r\n                            }\r\n                        } else {\r\n                            // Normal display (valid value from preferred source)\r\n                            dvrTempTextView.text = String.format(Locale.getDefault(), \"%.1f°C\", displayDvr)\r\n                            lastDvrPulse = displayDvr\r\n                            lastDvrPulseTime = System.currentTimeMillis()\r\n                            // Persist the DVR pulse/time so NotificationService and other components share the same baseline\r\n                            try {\r\n                                val alarmPrefs = getSharedPreferences(\"alarm_prefs\", Context.MODE_PRIVATE)\r\n                                alarmPrefs.edit().putFloat(\"last_dvr_pulse_value\", lastDvrPulse!!.toFloat()).putLong(\"last_dvr_pulse_time_ms\", lastDvrPulseTime).apply()\r\n                                android.util.Log.d(\"ScadaActivity\", \"Persisted lastDvrPulse=$lastDvrPulse at $lastDvrPulseTime to alarm_prefs\")\r\n                                // Broadcast to NotificationService (if running) so it updates its in-memory state immediately\r\n                                try {\r\n                                    val b = Intent(NotificationService.ACTION_UPDATE_DVR_PULSE)\r\n                                    b.putExtra(\"last_dvr_pulse_value\", lastDvrPulse!!)\r\n                                    b.putExtra(\"last_dvr_pulse_time_ms\", lastDvrPulseTime)\r\n                                    sendBroadcast(b)\r\n                                } catch (e: Exception) { android.util.Log.w(\"ScadaActivity\", \"Failed sending DVR update broadcast\", e) }\r\n                            } catch (e: Exception) {\r\n                                android.util.Log.w(\"ScadaActivity\", \"Failed to persist last DVR pulse\", e)\r\n                            }\r\n                        }\r\n                    } catch (e: Exception) {\r\n                        android.util.Log.w(\"ScadaActivity\", \"Failed processing DVR temperature display\", e)\r\n                        try { dvrTempTextView.text = \"N/A\" } catch (_: Exception) {}\r\n                    }\r\n                    ampsTextView.text = String.format(Locale.getDefault(), \"%.1f A\", latestReading.currentAmps)\r\n                    kwTextView.text = String.format(Locale.getDefault(), \"%.2f kW\", latestReading.currentPower)\r\n                    // Update weather card values (indoor/outdoor/humidity/wind) — these were not being written previously\r\n                    try {\r\n                        indoorTempTextView.text = String.format(Locale.getDefault(), \"%.1f°C\", latestReading.indoorTemp)\r\n                        outdoorTempTextView.text = String.format(Locale.getDefault(), \"%.1f°C\", latestReading.outdoorTemp)\r\n                        outdoorHumidityTextView.text = String.format(Locale.getDefault(), \"%.0f%%\", latestReading.humidity)\r\n                        windSpeedTextView.text = String.format(Locale.getDefault(), \"%.1f km/h\", latestReading.windSpeed)\r\n                        // Apply user-configured wind arrow offset for display only\r\n                        try {\r\n                            val prefsLocal = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n                            val windOffset = prefsLocal.getFloat(\"wind_arrow_offset_deg\", 0f)\r\n                            val rawDeg = ((latestReading.windDirection) % 360f + 360f) % 360f\r\n                            val displayRotation = ((rawDeg + windOffset) % 360f + 360f) % 360f\r\n                            windDirectionTextView.rotation = displayRotation\r\n                        } catch (_: Exception) {}\r\n                    } catch (e: Exception) {\r\n                        Log.w(\"ScadaActivity\", \"Failed updating weather card UI\", e)\r\n                    }\r\n\r\n                    // If DVR temperature was not present (0.0), try the dedicated DVR gid CSV as fallback\r\n                    if (latestReading.dvrTemp == 0.0) {\r\n                        try {\r\n                            CoroutineScope(Dispatchers.IO).launch {\r\n                                val dvrRow = dvrSheetsReader.fetchLatestDvrReading()\r\n                                if (dvrRow != null) {\r\n                                    val d = dvrRow\r\n                                    withContext(Dispatchers.Main) {\r\n                                        try {\r\n                                            dvrTempTextView.text = String.format(Locale.getDefault(), \"%.1f°C\", d.dvrTemp)\r\n                                        } catch (_: Exception) {}\r\n                                    }\r\n                                }\r\n                            }\r\n                        } catch (e: Exception) { Log.w(\"ScadaActivity\", \"DVR fallback read failed\", e) }\r\n                    }\r\n\r\n                    // Dynamic status text for temperature and pressure\r\n                    try {\r\n                        val prefsLocal = getSharedPreferences(\"alarm_prefs\", Context.MODE_PRIVATE)\r\n                        // Pressure threshold exists in prefs; default to 1.0 bar\r\n                        val lowPressure = prefsLocal.getFloat(\"low_pressure_threshold\", 1.0f).toDouble()\r\n\r\n                        // Temperature range: use prefs if present, otherwise sensible defaults (40..70°C)\r\n                        val tempMin = prefsLocal.getFloat(\"water_temp_min\", 40.0f).toDouble()\r\n                        val tempMax = prefsLocal.getFloat(\"water_temp_max\", 70.0f).toDouble()\r\n\r\n                        // Temperature status\r\n                        val tempStatusText: String\r\n                        val tempColor = when {\r\n                            latestReading.waterTemp < tempMin -> \"#FF5722\".toColorInt() // slightly warning\r\n                            latestReading.waterTemp > tempMax -> \"#F44336\".toColorInt() // high = red\r\n                            else -> \"#4CAF50\".toColorInt() // normal = green\r\n                        }\r\n                        tempStatusText = when {\r\n                            latestReading.waterTemp < tempMin -> String.format(Locale.getDefault(), \"Low (%.1f°C)\", latestReading.waterTemp)\r\n                            latestReading.waterTemp > tempMax -> String.format(Locale.getDefault(), \"High (%.1f°C)\", latestReading.waterTemp)\r\n                            else -> String.format(Locale.getDefault(), \"Normal (%.1f°C)\", latestReading.waterTemp)\r\n                        }\r\n                        try { findViewById<TextView>(R.id.waterTempStatus).text = tempStatusText } catch (_: Exception) {}\r\n                        try { findViewById<TextView>(R.id.waterTempStatus).setTextColor(tempColor) } catch (_: Exception) {}\r\n\r\n                        // Pressure status\r\n                        val pressureStatusText: String\r\n                        val pressureColor = if (latestReading.waterPressure < lowPressure) \"#F44336\".toColorInt() else \"#4CAF50\".toColorInt()\r\n                        pressureStatusText = if (latestReading.waterPressure < lowPressure) String.format(Locale.getDefault(), \"Low (%.1f bar)\", latestReading.waterPressure) else String.format(Locale.getDefault(), \"OK (%.1f bar)\", latestReading.waterPressure)\r\n                        try { findViewById<TextView>(R.id.waterPressureStatus).text = pressureStatusText } catch (_: Exception) {}\r\n                        try { findViewById<TextView>(R.id.waterPressureStatus).setTextColor(pressureColor) } catch (_: Exception) {}\r\n                    } catch (e: Exception) {\r\n                        Log.w(\"ScadaActivity\", \"Failed updating geyser status texts\", e)\r\n                    }\r\n\r\n                    // DVR pulse status: use numeric comparison (tolerance) to avoid false 'unchanged' due to formatting\r\n                    try {\r\n                        val pulseVal = latestReading.dvrTemp.toDouble()\r\n                        val prefsLocal = getSharedPreferences(\"alarm_prefs\", Context.MODE_PRIVATE)\r\n                        val dvrStaleMinutes = prefsLocal.getLong(\"dvr_stale_minutes\", 60L)\r\n                        val tol = getDvrPulseTolerance()\r\n                        android.util.Log.d(\"ScadaActivity\", \"DVR pulse check: pulseVal=$pulseVal lastDvrPulse=$lastDvrPulse lastDvrPulseTime=$lastDvrPulseTime tol=$tol\")\r\n                        if (lastDvrPulse == null) {\r\n                            lastDvrPulse = pulseVal\r\n                            lastDvrPulseTime = System.currentTimeMillis()\r\n                            // Persist initial pulse/time\r\n                            try {\r\n                                val alarmPrefs = getSharedPreferences(\"alarm_prefs\", Context.MODE_PRIVATE)\r\n                                alarmPrefs.edit().putFloat(\"last_dvr_pulse_value\", lastDvrPulse!!.toFloat()).putLong(\"last_dvr_pulse_time_ms\", lastDvrPulseTime).apply()\r\n                                android.util.Log.d(\"ScadaActivity\", \"Persisted initial lastDvrPulse=$lastDvrPulse at $lastDvrPulseTime to alarm_prefs\")\r\n                                // Broadcast update so service syncs immediately\r\n                                try {\r\n                                    val b = Intent(NotificationService.ACTION_UPDATE_DVR_PULSE)\r\n                                    b.putExtra(\"last_dvr_pulse_value\", lastDvrPulse!!)\r\n                                    b.putExtra(\"last_dvr_pulse_time_ms\", lastDvrPulseTime)\r\n                                    sendBroadcast(b)\r\n                                } catch (e: Exception) { android.util.Log.w(\"ScadaActivity\", \"Failed sending DVR initial broadcast\", e) }\r\n                            } catch (e: Exception) {\r\n                                android.util.Log.w(\"ScadaActivity\", \"Failed to persist initial lastDvrPulse\", e)\r\n                            }\r\n                            val okGreen = \"#4CAF50\".toColorInt()\r\n                            dvrStatusDot.imageTintList = ColorStateList.valueOf(okGreen)\r\n                            dvrHeartbeatStatus.text = getString(R.string.status_online)\r\n                            dvrHeartbeatStatus.setTextColor(okGreen)\r\n                        } else {\r\n                            val changed = kotlin.math.abs(pulseVal - lastDvrPulse!!) > tol\r\n                            if (!changed) {\r\n                                val minutesElapsed = (System.currentTimeMillis() - lastDvrPulseTime) / 60000L\r\n                                android.util.Log.d(\"ScadaActivity\", \"DVR pulse unchanged. minutesElapsed=$minutesElapsed (threshold=$dvrStaleMinutes)\")\r\n                                if (minutesElapsed >= dvrStaleMinutes) {\r\n                                    // Stale\r\n                                    val staleRed = \"#F44336\".toColorInt()\r\n                                    dvrStatusDot.imageTintList = ColorStateList.valueOf(staleRed)\r\n                                    dvrHeartbeatStatus.text = \"Stale (${minutesElapsed}m)\"\r\n                                    dvrHeartbeatStatus.setTextColor(staleRed)\r\n                                    android.util.Log.i(\"ScadaActivity\", \"DVR marked STALE: pulse=$pulseVal minutesElapsed=$minutesElapsed\")\r\n                                } else {\r\n                                    // Still fresh - show age in minutes\r\n                                    val okGreen = \"#4CAF50\".toColorInt()\r\n                                    dvrStatusDot.imageTintList = ColorStateList.valueOf(okGreen)\r\n                                    dvrHeartbeatStatus.text = \"Online (${minutesElapsed}m)\"\r\n                                    dvrHeartbeatStatus.setTextColor(okGreen)\r\n                                }\r\n                            } else {\r\n                                // Pulse changed -> update time and set Online (just now)\r\n                                lastDvrPulse = pulseVal\r\n                                lastDvrPulseTime = System.currentTimeMillis()\r\n                                // Persist updated pulse/time so NotificationService sees the update immediately\r\n                                try {\r\n                                    val alarmPrefs = getSharedPreferences(\"alarm_prefs\", Context.MODE_PRIVATE)\r\n                                    alarmPrefs.edit().putFloat(\"last_dvr_pulse_value\", lastDvrPulse!!.toFloat()).putLong(\"last_dvr_pulse_time_ms\", lastDvrPulseTime).apply()\r\n                                    android.util.Log.d(\"ScadaActivity\", \"Persisted updated lastDvrPulse=$lastDvrPulse at $lastDvrPulseTime to alarm_prefs\")\r\n                                    // Broadcast update so service syncs immediately\r\n                                    try {\r\n                                        val b = Intent(NotificationService.ACTION_UPDATE_DVR_PULSE)\r\n                                        b.putExtra(\"last_dvr_pulse_value\", lastDvrPulse!!)\r\n                                        b.putExtra(\"last_dvr_pulse_time_ms\", lastDvrPulseTime)\r\n                                        sendBroadcast(b)\r\n                                    } catch (e: Exception) { android.util.Log.w(\"ScadaActivity\", \"Failed sending DVR updated broadcast\", e) }\r\n                                } catch (e: Exception) {\r\n                                    android.util.Log.w(\"ScadaActivity\", \"Failed to persist updated last DVR pulse\", e)\r\n                                }\r\n                                val okGreen = \"#4CAF50\".toColorInt()\r\n                                dvrStatusDot.imageTintList = ColorStateList.valueOf(okGreen)\r\n                                dvrHeartbeatStatus.text = \"Online (now)\"\r\n                                dvrHeartbeatStatus.setTextColor(okGreen)\r\n                                android.util.Log.i(\"ScadaActivity\", \"DVR pulse updated: new pulse=$pulseVal\")\r\n                            }\r\n                        }\r\n                    } catch (e: Exception) {\r\n                        // If anything goes wrong, default to showing Online but log for debugging\r\n                        android.util.Log.w(\"ScadaActivity\", \"DVR status check failed\", e)\r\n                        try {\r\n                            val okGreen = \"#4CAF50\".toColorInt()\r\n                            dvrStatusDot.imageTintList = ColorStateList.valueOf(okGreen)\r\n                            dvrHeartbeatStatus.text = getString(R.string.status_online)\r\n                            dvrHeartbeatStatus.setTextColor(okGreen)\r\n                        } catch (_: Exception) {}\r\n                    }\r\n\r\n                    // Use raw wind direction degrees from data. Compute a display-only rotation by\r\n                    // applying any user-configured offset (e.g. 180°) but do NOT modify the underlying data.\r\n                    val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n                    val windOffset = prefs.getFloat(\"wind_arrow_offset_deg\", 0f)\r\n                    // Normalize raw degrees to 0..360\r\n                    val rawDeg = ((latestReading.windDirection) % 360f + 360f) % 360f\r\n                    val displayRotation = ((rawDeg + windOffset) % 360f + 360f) % 360f\r\n                    // Apply rotation to the ImageView. The vector drawable points up (north) at 0°.\r\n                    try {\r\n                        windDirectionTextView.rotation = displayRotation\r\n                    } catch (_: Exception) {}\r\n\r\n                    // Simple delta-based trend for geyser temp + pressure\r\n                    // small deadband to avoid flicker\r\n                    val tempThreshold = 0.2\r\n                    val pressureThreshold = 0.05\r\n\r\n                    // Temperature trend\r\n                    prevWaterTemp?.let { prev ->\r\n                        when {\r\n                            latestReading.waterTemp > prev + tempThreshold -> {\r\n                                waterTempTrendTextView.text = \"↑\"\r\n                                waterTempTrendTextView.setTextColor(\"#4CAF50\".toColorInt()) // green\r\n                            }\r\n                            latestReading.waterTemp < prev - tempThreshold -> {\r\n                                waterTempTrendTextView.text = \"↓\"\r\n                                waterTempTrendTextView.setTextColor(\"#F44336\".toColorInt()) // red\r\n                            }\r\n                            else -> {\r\n                                waterTempTrendTextView.text = \"→\"\r\n                                waterTempTrendTextView.setTextColor(\"#9FA8DA\".toColorInt()) // neutral\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // Pressure trend\r\n                    prevWaterPressure?.let { prevP ->\r\n                        when {\r\n                            latestReading.waterPressure > prevP + pressureThreshold -> {\r\n                                waterPressureTrendTextView.text = \"↑\"\r\n                                waterPressureTrendTextView.setTextColor(\"#4CAF50\".toColorInt())\r\n                            }\r\n                            latestReading.waterPressure < prevP - pressureThreshold -> {\r\n                                waterPressureTrendTextView.text = \"↓\"\r\n                                waterPressureTrendTextView.setTextColor(\"#F44336\".toColorInt())\r\n                            }\r\n                            else -> {\r\n                                waterPressureTrendTextView.text = \"→\"\r\n                                waterPressureTrendTextView.setTextColor(\"#9FA8DA\".toColorInt())\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // Update previous values after computing trend\r\n                    prevWaterTemp = latestReading.waterTemp\r\n                    prevWaterPressure = latestReading.waterPressure\r\n\r\n                    // Update analytics with the latest reading\r\n                    updateAnalytics()\r\n                } else {\r\n                    // No Sheets data — show localized message\r\n                    geyserTempTextView.text = getString(R.string.no_sheets_data_short)\r\n                    geyserPressureTextView.text = getString(R.string.no_sheets_data_short)\r\n                }\r\n            } catch (e: Exception) {\r\n                e.printStackTrace()\r\n                // Show error state\r\n                runOnUiThread {\r\n                    geyserTempTextView.text = getString(R.string.error_short)\r\n                    geyserPressureTextView.text = getString(R.string.error_short)\r\n                }\r\n            }\r\n            // Schedule next update in 30 seconds for fresh geyser data\r\n            android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({\r\n                monitorGeyserData()\r\n            }, 30000) // Update every 30 seconds\r\n        }\r\n    }\r\n\r\n\r\n    private fun ensureFreshGoogleSignIn() {\r\n        val account = GoogleSignIn.getLastSignedInAccount(this)\r\n        if (account == null) {\r\n            // Not signed in, start the sign-in flow\r\n            signInLauncher.launch(googleSignInClient.signInIntent)\r\n        } else {\r\n            // Already signed in, proceed to initialize Drive\r\n            firebaseAuthWithGoogle(account)\r\n            initializeDriveService(account)\r\n        }\r\n    }\r\n\r\n    private fun setupGoogleDriveSignIn() {\r\n        Log.d(\"ScadaActivity\", \"setupGoogleDriveSignIn called\")\r\n        auth = FirebaseAuth.getInstance()\r\n        val gso = GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)\r\n            .requestIdToken(getString(R.string.default_web_client_id))\r\n            .requestEmail()\r\n            .requestScopes(Scope(DriveScopes.DRIVE)) // Changed from DRIVE_FILE to DRIVE\r\n            .build()\r\n        googleSignInClient = GoogleSignIn.getClient(this, gso)\r\n\r\n        googleSignInClient.silentSignIn().addOnCompleteListener(this) { task ->\r\n            if (task.isSuccessful) {\r\n                val account = task.result\r\n                firebaseAuthWithGoogle(account)\r\n                initializeDriveService(account)\r\n            } else {\r\n                // Silent sign-in failed, fallback to interactive sign-in\r\n                signInLauncher.launch(googleSignInClient.signInIntent)\r\n            }\r\n        }\r\n    }\r\n\r\n    // Remove onActivityResult override (replaced by signInLauncher)\r\n\r\n    private fun firebaseAuthWithGoogle(account: GoogleSignInAccount) {\r\n        Log.d(\"ScadaActivity\", \"firebaseAuthWithGoogle called with account: ${account.email}\")\r\n        if (account.idToken.isNullOrEmpty()) {\r\n            Log.e(\"ScadaActivity\", \"idToken is null or empty. Cannot authenticate with Firebase.\")\r\n            runOnUiThread {\r\n                try { ToastHelper.show(this, \"Google Sign-In failed: Missing idToken. Please try again.\", android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n            }\r\n            // Optionally, retry sign-in\r\n            signInLauncher.launch(googleSignInClient.signInIntent)\r\n            return\r\n        }\r\n        val credential = GoogleAuthProvider.getCredential(account.idToken, null)\r\n        auth.signInWithCredential(credential)\r\n            .addOnCompleteListener(this) { task ->\r\n                if (task.isSuccessful) {\r\n                    Log.d(\"ScadaActivity\", \"Firebase authentication successful\")\r\n                    // Now that we are authenticated, we can start listening for Firestore updates\r\n                    //listenForLightsStatus()\r\n                } else {\r\n                    Log.w(\"ScadaActivity\", \"Firebase authentication failed\", task.exception)\r\n                    runOnUiThread {\r\n                        try { ToastHelper.show(this, \"Firebase authentication failed.\", android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}\r\n                    }\r\n                }\r\n            }\r\n    }\r\n\r\n    private fun initializeDriveService(account: GoogleSignInAccount?) {\r\n        Log.d(\"ScadaActivity\", \"initializeDriveService called with account: $account\")\r\n        if (account == null) return\r\n        Log.i(\"ScadaActivity\", \"Signed-in Google account: ${account.email}\")\r\n        val credential = GoogleAccountCredential.usingOAuth2(\r\n            this, listOf(DriveScopes.DRIVE) // Changed from DRIVE_FILE to DRIVE\r\n        )\r\n        credential.selectedAccount = account.account\r\n        driveService = Drive.Builder(\r\n            NetHttpTransport(),\r\n            GsonFactory.getDefaultInstance(),\r\n            credential\r\n        ).setApplicationName(\"Home Automation\").build()\r\n        // Enable lights buttons now that Drive is ready\r\n        runOnUiThread {\r\n            findViewById<android.widget.Button>(R.id.lightsOnButton).isEnabled = true\r\n            findViewById<android.widget.Button>(R.id.lightsOffButton).isEnabled = true\r\n            Log.d(\"ScadaActivity\", \"Lights buttons enabled after Drive initialization\")\r\n        }\r\n        // List all accessible files for debugging\r\n        CoroutineScope(Dispatchers.IO).launch {\r\n            listAllDriveFilesForDebug()\r\n        }\r\n        // We no longer poll the Drive lights file. Instead listen for status updates in Firestore.\r\n        // Start Firestore listener for lights status so UI shows canonical confirmation from the bridge.\r\n        try { fetchLightsStatusOnce() } catch (_: Exception) {}\r\n        // Ensure lights backend selection is applied now that Drive is initialized. If the user\r\n        // selected 'drive' as the backend, this will start the drive polling job.\r\n        try { applyLightsBackendSelection() } catch (_: Exception) {}\r\n    }\r\n\r\n    // List all accessible files and log their names and IDs\r\n    private suspend fun listAllDriveFilesForDebug() = withContext(Dispatchers.IO) {\r\n        val drive = driveService ?: return@withContext\r\n        try {\r\n            val result = drive.files().list().setPageSize(100).setFields(\"files(id, name)\").execute()\r\n            val files = result.files\r\n            if (files == null || files.isEmpty()) {\r\n                Log.d(\"ScadaActivity\", \"[DEBUG] No files found in Drive.\")\r\n            } else {\r\n                Log.d(\"ScadaActivity\", \"[DEBUG] Files accessible to app:\")\r\n                for (file in files) {\r\n                    Log.d(\"ScadaActivity\", \"[DEBUG] File: ${file.name} (ID: ${file.id})\")\r\n                }\r\n            }\r\n        } catch (e: Exception) {\r\n            Log.e(\"ScadaActivity\", \"[DEBUG] Error listing Drive files\", e)\r\n        }\r\n    }\r\n\r\n    // Replaced the realtime listener with a one-shot fetch to reduce Firestore reads.\r\n    // Call `fetchLightsStatusOnce()` explicitly when you want to refresh the bulb indicator\r\n    // (onResume, after writing a command, or via a manual refresh). This avoids constant\r\n    // background reads that consume quota.\r\n    private fun fetchLightsStatusOnce() {\r\n        try {\r\n            val statusRef = db.collection(\"scada_controls\").document(\"lights_status\")\r\n            statusRef.get()\r\n                .addOnSuccessListener { snapshot ->\r\n                    // process on main dispatcher\r\n                    CoroutineScope(Dispatchers.Main).launch {\r\n                        try {\r\n                            if (snapshot == null || !snapshot.exists()) return@launch\r\n\r\n                            val appPrefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n                            val backend = appPrefs.getString(\"lights_control_backend\", \"firebase\") ?: \"firebase\"\r\n\r\n                            val lightsState: Boolean? = if (backend == \"drive\") {\r\n                                val y21 = snapshot.getStringSafe(\"Y21_read_status\") ?: snapshot.getStringSafe(\"Y21_read\") ?: snapshot.getStringSafe(\"Y21\")\r\n                                val m21 = snapshot.getStringSafe(\"M21_read\") ?: snapshot.getStringSafe(\"M21\")\r\n                                val driveValue = m21 ?: y21\r\n                                when {\r\n                                    driveValue?.contains(\"ON\", ignoreCase = true) == true -> true\r\n                                    driveValue?.contains(\"1\") == true -> true\r\n                                    driveValue?.contains(\"OFF\", ignoreCase = true) == true -> false\r\n                                    driveValue?.contains(\"0\") == true -> false\r\n                                    else -> null\r\n                                }\r\n                            } else {\r\n                                val state = when {\r\n                                    snapshot.contains(\"coil_1298_state\") -> snapshot.getBoolean(\"coil_1298_state\")\r\n                                    snapshot.contains(\"coil_1298\") -> snapshot.getBoolean(\"coil_1298\")\r\n                                    snapshot.contains(\"coil_1298_state_bool\") -> snapshot.getBoolean(\"coil_1298_state_bool\")\r\n                                    snapshot.contains(\"coil_1298_state_str\") -> try { snapshot.getString(\"coil_1298_state_str\")?.toBoolean() } catch (_: Exception) { null }\r\n                                    snapshot.contains(\"state\") -> snapshot.getBoolean(\"state\")\r\n                                    snapshot.contains(\"actual_state\") -> snapshot.getBoolean(\"actual_state\")\r\n                                    else -> null\r\n                                }\r\n                                if (state == null) Log.w(\"ScadaActivity\", \"FCM mode: No coil_1298 state found in snapshot. Available fields: ${snapshot.data?.keys}\")\r\n                                state\r\n                            }\r\n\r\n                            val lastCmd = snapshot.getString(\"last_command\") ?: \"--\"\r\n                            val lastActionAny = snapshot.get(\"last_action_ts\")\r\n                            val lastAction = when (lastActionAny) {\r\n                                is com.google.firebase.Timestamp -> try { java.text.SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\", Locale.getDefault()).format(java.util.Date(lastActionAny.toDate().time)) } catch (_: Exception) { \"\" }\r\n                                is String -> lastActionAny\r\n                                else -> \"\"\r\n                            }\r\n\r\n                            // Update UI\r\n                            try {\r\n                                val color = when (lightsState) {\r\n                                    true -> \"#4CAF50\".toColorInt()\r\n                                    false -> \"#FF5722\".toColorInt()\r\n                                    null -> \"#9E9E9E\".toColorInt()\r\n                                }\r\n                                lightsStatusIcon.imageTintList = ColorStateList.valueOf(color)\r\n                                lightsStatusText.setTextColor(color)\r\n                                lightsStatusText.text = when (lightsState) {\r\n                                    true -> getString(R.string.text_on)\r\n                                    false -> getString(R.string.text_off)\r\n                                    null -> getString(R.string.text_unknown)\r\n                                }\r\n\r\n                                if (backend == \"drive\") {\r\n                                     val y21 = snapshot.getStringSafe(\"Y21_read_status\") ?: snapshot.getStringSafe(\"Y21_read\") ?: snapshot.getStringSafe(\"Y21\")\r\n                                     val m21 = snapshot.getStringSafe(\"M21_read\") ?: snapshot.getStringSafe(\"M21\")\r\n                                     val driveText = when {\r\n                                         !m21.isNullOrEmpty() -> m21\r\n                                         !y21.isNullOrEmpty() -> y21\r\n                                         else -> \"--\"\r\n                                     }\r\n                                     lightsDetails.text = getString(R.string.drive_prefix, driveText)\r\n                                 } else {\r\n                                    val yVal = lightsState?.toString() ?: \"--\"\r\n                                    val details = mutableListOf<String>()\r\n                                    details.add(getString(R.string.y1298_format, yVal))\r\n                                    details.add(getString(R.string.cmd_format, lastCmd))\r\n                                    if (lastAction.isNotEmpty()) details.add(getString(R.string.at_format, lastAction))\r\n                                    lightsDetails.text = details.joinToString(\" \")\r\n                                }\r\n                            } catch (e: Exception) {\r\n                                Log.w(\"ScadaActivity\", \"Failed update lights indicator from snapshot\", e)\r\n                            }\r\n\r\n                        } catch (e: Exception) {\r\n                            Log.w(\"ScadaActivity\", \"Error processing lights_status snapshot\", e)\r\n                        }\r\n                    }\r\n                }\r\n                .addOnFailureListener { e -> Log.w(\"ScadaActivity\", \"Failed fetching lights_status\", e) }\r\n        } catch (e: Exception) {\r\n            Log.w(\"ScadaActivity\", \"setupLightsListener failed\", e)\r\n        }\r\n    }\r\n\r\n    // ---- Stubs to satisfy references during cleanup. These are small no-ops that log actions.\r\n    private fun setupLightsListener() {\r\n        // Previously this started a realtime listener. For now we perform a single fetch.\r\n        try { fetchLightsStatusOnce() } catch (_: Exception) { Log.w(\"ScadaActivity\", \"setupLightsListener no-op\") }\r\n    }\r\n\r\n    private fun startLightsPolling() {\r\n        // Starts a short polling job; keep as no-op here (existing code conditionally calls it)\r\n        Log.d(\"ScadaActivity\", \"startLightsPolling called - no-op stub\")\r\n    }\r\n\r\n    private fun startY21ReadPolling() {\r\n        Log.d(\"ScadaActivity\", \"startY21ReadPolling called - no-op stub\")\r\n    }\r\n\r\n    private fun openAlarmSettingsDialog() {\r\n        // Debugging: log entry so we can confirm clicks reach this method via Logcat\r\n        Log.d(\"ScadaActivity\", \"openAlarmSettingsDialog called\")\r\n        val prefs = getSharedPreferences(\"alarm_prefs\", Context.MODE_PRIVATE)\r\n        // App-level prefs used for appearance/wind/backend selection\r\n        val appPrefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n        val dialogView = layoutInflater.inflate(R.layout.dialog_alarm_settings, null)\r\n\r\n        // Bind dialog views (use nullable types to tolerate layout variants)\r\n        val etLowPressure = dialogView.findViewById<android.widget.EditText?>(R.id.et_low_pressure)\r\n        val etHighAmps = dialogView.findViewById<android.widget.EditText?>(R.id.et_high_amps)\r\n        val etHighAmpsDuration = dialogView.findViewById<android.widget.EditText?>(R.id.et_high_amps_duration)\r\n        val etWaterVariance = dialogView.findViewById<android.widget.EditText?>(R.id.et_water_variance)\r\n        val etDvrMinutes = dialogView.findViewById<android.widget.EditText?>(R.id.et_dvr_stale_minutes)\r\n        val etWaterHourlyThreshold = dialogView.findViewById<android.widget.EditText?>(R.id.et_water_hourly_threshold)\r\n        val etWaterHourlyHours = dialogView.findViewById<android.widget.EditText?>(R.id.et_water_hourly_hours)\r\n        val switchInvertWind = dialogView.findViewById<androidx.appcompat.widget.SwitchCompat?>(R.id.switch_invert_wind)\r\n        // Appearance buttons (moved here from diagnostics long-press)\r\n        val btnCardColor = dialogView.findViewById<android.widget.Button?>(R.id.btn_card_color)\r\n        val btnGraphColor = dialogView.findViewById<android.widget.Button?>(R.id.btn_graph_color)\r\n        val btnSave = dialogView.findViewById<android.widget.Button>(R.id.btn_save_alarms)\r\n\r\n        // New: time picker buttons for security schedule\r\n        val btnEnableTime = dialogView.findViewById<android.widget.Button?>(R.id.btn_security_enable_time)\r\n        val btnDisableTime = dialogView.findViewById<android.widget.Button?>(R.id.btn_security_disable_time)\r\n        val btnClearSecuritySchedule = dialogView.findViewById<android.widget.Button?>(R.id.btn_clear_security_schedule)\r\n\r\n        // Load stored schedule and set button labels\r\n        try {\r\n            val seH = appPrefs.getInt(\"security_enable_hour\", -1)\r\n            val seM = appPrefs.getInt(\"security_enable_min\", 0)\r\n            val sdH = appPrefs.getInt(\"security_disable_hour\", -1)\r\n            val sdM = appPrefs.getInt(\"security_disable_min\", 0)\r\n            if (seH >= 0) btnEnableTime?.text = String.format(Locale.getDefault(), \"%02d:%02d\", seH, seM) else btnEnableTime?.text = getString(R.string.set_time)\r\n            if (sdH >= 0) btnDisableTime?.text = String.format(Locale.getDefault(), \"%02d:%02d\", sdH, sdM) else btnDisableTime?.text = getString(R.string.set_time)\r\n        } catch (_: Exception) {}\r\n\r\n        // Helper to show TimePicker and write selection to button text\r\n        fun openTimePicker(initialH: Int?, initialM: Int?, onPicked: (Int, Int) -> Unit) {\r\n            val now = java.util.Calendar.getInstance()\r\n            val h = initialH ?: now.get(java.util.Calendar.HOUR_OF_DAY)\r\n            val m = initialM ?: now.get(java.util.Calendar.MINUTE)\r\n            val picker = android.app.TimePickerDialog(this, { _, hourOfDay, minute -> onPicked(hourOfDay, minute) }, h, m, true)\r\n            picker.show()\r\n        }\r\n\r\n        btnEnableTime?.setOnClickListener {\r\n            try {\r\n                val seH = appPrefs.getInt(\"security_enable_hour\", -1).takeIf { it >= 0 }\r\n                val seM = appPrefs.getInt(\"security_enable_min\", 0)\r\n                openTimePicker(seH, seM) { hh, mm -> btnEnableTime.text = String.format(Locale.getDefault(), \"%02d:%02d\", hh, mm); appPrefs.edit { putInt(\"security_enable_hour\", hh); putInt(\"security_enable_min\", mm) } }\r\n            } catch (e: Exception) { android.util.Log.w(\"ScadaActivity\", \"Enable time picker failed\", e) }\r\n        }\r\n\r\n        btnDisableTime?.setOnClickListener {\r\n            try {\r\n                val sdH = appPrefs.getInt(\"security_disable_hour\", -1).takeIf { it >= 0 }\r\n                val sdM = appPrefs.getInt(\"security_disable_min\", 0)\r\n                openTimePicker(sdH, sdM) { hh, mm -> btnDisableTime.text = String.format(Locale.getDefault(), \"%02d:%02d\", hh, mm); appPrefs.edit { putInt(\"security_disable_hour\", hh); putInt(\"security_disable_min\", mm) } }\r\n            } catch (e: Exception) { android.util.Log.w(\"ScadaActivity\", \"Disable time picker failed\", e) }\r\n        }\r\n\r\n        // Load security schedule into dialog from appPrefs\r\n        try {\r\n            val seH = appPrefs.getInt(\"security_enable_hour\", -1)\r\n            val seM = appPrefs.getInt(\"security_enable_min\", 0)\r\n            val sdH = appPrefs.getInt(\"security_disable_hour\", -1)\r\n            val sdM = appPrefs.getInt(\"security_disable_min\", 0)\r\n            if (seH >= 0) btnEnableTime?.text = String.format(Locale.getDefault(), \"%02d:%02d\", seH, seM) else btnEnableTime?.text = getString(R.string.set_time)\r\n            if (sdH >= 0) btnDisableTime?.text = String.format(Locale.getDefault(), \"%02d:%02d\", sdH, sdM) else btnDisableTime?.text = getString(R.string.set_time)\r\n        } catch (_: Exception) {}\r\n\r\n        // NOTE: previously there was a direct `findViewById(R.id.cb_enable_when_away)` here which caused unresolved-reference\r\n        // and later duplicate declarations; that code has been removed so the safer resource.getIdentifier-based lookup\r\n        // (declared below) is the single source of the optional checkbox reference.\r\n\r\n        // Load current prefs into dialog fields (safe calls)\r\n        try { etLowPressure?.setText(prefs.getFloat(\"low_pressure_threshold\", 1.0f).toString()) } catch (_: Exception) {}\r\n        try { etHighAmps?.setText(prefs.getFloat(\"high_amps_threshold\", 6.0f).toString()) } catch (_: Exception) {}\r\n        try { etHighAmpsDuration?.setText((prefs.getLong(\"high_amps_duration_ms\", 3600000L) / 60000L).toString()) } catch (_: Exception) {}\r\n        try { etWaterVariance?.setText(prefs.getFloat(\"water_variance_threshold\", 0.1f).toString()) } catch (_: Exception) {}\r\n        try { etDvrMinutes?.setText((prefs.getLong(\"dvr_stale_minutes\", 60L)).toString()) } catch (_: Exception) {}\r\n        try { etWaterHourlyThreshold?.setText(prefs.getFloat(\"water_hourly_volume_threshold\", 500f).toString()) } catch (_: Exception) {}\r\n        try { etWaterHourlyHours?.setText(prefs.getInt(\"water_hourly_window_hours\", 1).toString()) } catch (_: Exception) {}\r\n\r\n        // Resolve optional spinner and checkbox IDs via resources.getIdentifier so missing layout elements are tolerated\r\n        val spinnerLiters = dialogView.findViewById<android.widget.Spinner?>(resources.getIdentifier(\"spinner_hourly_preset\", \"id\", packageName))\r\n        val spinnerHours = dialogView.findViewById<android.widget.Spinner?>(resources.getIdentifier(\"spinner_hourly_hours_preset\", \"id\", packageName))\r\n        val cbEnableWhenAway = run {\r\n            val id = resources.getIdentifier(\"cb_enable_when_away\", \"id\", packageName)\r\n            if (id != 0) dialogView.findViewById<android.widget.CheckBox?>(id) else null\r\n        }\r\n\r\n        // Ensure spinner choices and radio group reflect the saved values (avoid showing defaults)\r\n        try {\r\n            val literOptions = arrayOf(\"100 L\", \"250 L\", \"500 L\", \"1000 L\")\r\n            val currentHourly = etWaterHourlyThreshold?.text.toString().toFloatOrNull()\r\n            if (currentHourly != null) {\r\n                val idx = literOptions.indexOfFirst { opt ->\r\n                    opt.split(\" \").firstOrNull()?.toFloatOrNull() == currentHourly\r\n                }.coerceAtLeast(0)\r\n                spinnerLiters?.setSelection(idx)\r\n            }\r\n        } catch (_: Exception) {}\r\n\r\n        try {\r\n            val hourOptions = arrayOf(\"1 h\", \"2 h\", \"4 h\", \"8 h\")\r\n            val currentHours = etWaterHourlyHours?.text.toString().toIntOrNull() ?: 1\r\n            val idx = hourOptions.indexOfFirst { opt -> opt.split(\" \").firstOrNull()?.toIntOrNull() == currentHours }\r\n            if (idx >= 0) spinnerHours?.setSelection(idx) else spinnerHours?.setSelection(0)\r\n        } catch (_: Exception) {}\r\n\r\n        try {\r\n            val rg = dialogView.findViewById<android.widget.RadioGroup?>(R.id.rg_lights_control)\r\n            val backendPref = appPrefs.getString(\"lights_control_backend\", \"firebase\") ?: \"firebase\"\r\n            if (backendPref == \"drive\") {\r\n                rg?.check(R.id.rb_control_drive)\r\n            } else {\r\n                rg?.check(R.id.rb_control_firebase)\r\n            }\r\n        } catch (_: Exception) {}\r\n\r\n        // Initialize invert wind and live preview from global app prefs\r\n        val currentOffset = appPrefs.getFloat(\"wind_arrow_offset_deg\", 0f)\r\n\r\n        // Dialog preview controls\r\n        val previewArrow = dialogView.findViewById<ImageView?>(R.id.preview_wind_arrow)\r\n        val tvOffset = dialogView.findViewById<TextView?>(R.id.tv_wind_offset_value)\r\n        val seekOffset = dialogView.findViewById<android.widget.SeekBar?>(R.id.seek_wind_offset)\r\n\r\n        // Set initial preview and seek position\r\n        val normalizedCurrent = ((currentOffset) % 360f + 360f) % 360f\r\n        seekOffset?.progress = normalizedCurrent.toInt()\r\n        tvOffset?.text = getString(R.string.offset_format, normalizedCurrent.toInt())\r\n        try { previewArrow?.rotation = normalizedCurrent } catch (_: Exception) {}\r\n\r\n        // Switch reflects zero vs non-zero offset (invert convenience)\r\n        switchInvertWind?.isChecked = (normalizedCurrent % 360f) != 0f\r\n\r\n        // SeekBar listener updates preview arrow smoothly (animate rotation)\r\n        seekOffset?.setOnSeekBarChangeListener(object : android.widget.SeekBar.OnSeekBarChangeListener {\r\n            override fun onProgressChanged(seekBar: android.widget.SeekBar?, progress: Int, fromUser: Boolean) {\r\n                tvOffset?.text = getString(R.string.offset_format, progress)\r\n                try {\r\n                    val from = previewArrow?.rotation ?: 0f\r\n                    val to = progress.toFloat()\r\n                    val animator = android.animation.ObjectAnimator.ofFloat(previewArrow, \"rotation\", from, to)\r\n                    animator.duration = 250\r\n                    animator.start()\r\n                } catch (_: Exception) {}\r\n                try { switchInvertWind?.isChecked = (progress % 360) != 0 } catch (_: Exception) {}\r\n            }\r\n            override fun onStartTrackingTouch(seekBar: android.widget.SeekBar?) {}\r\n            override fun onStopTrackingTouch(seekBar: android.widget.SeekBar?) {}\r\n        })\r\n\r\n        // Switch toggles quick 180° vs 0° and updates preview/seek\r\n        switchInvertWind?.setOnCheckedChangeListener { _, isChecked ->\r\n            val newOffset = if (isChecked) 180f else 0f\r\n            try { seekOffset?.progress = newOffset.toInt() } catch (_: Exception) {}\r\n        }\r\n\r\n        // Appearance button handlers: reuse showColorPicker helper already present in the activity\r\n        btnCardColor?.setOnClickListener {\r\n            showColorPicker(\"card_scada_color\", \"Choose card background color\") {\r\n                try { ToastHelper.show(this, \"Card color saved\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n            }\r\n        }\r\n        btnGraphColor?.setOnClickListener {\r\n            showColorPicker(\"graph_background_color\", \"Choose graph background color\") {\r\n                try { ToastHelper.show(this, \"Graph color saved\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n            }\r\n        }\r\n\r\n        val dialog = androidx.appcompat.app.AlertDialog.Builder(this)\r\n            .setView(dialogView)\r\n            .create()\r\n\r\n        // Load recent alarms from shared prefs and populate the Recent Alarms card\r\n        try {\r\n            val historyPrefs = getSharedPreferences(\"alarm_history\", Context.MODE_PRIVATE)\r\n            val rawJson = historyPrefs.getString(\"recent_alarms_json\", \"[]\") ?: \"[]\"\r\n            val arr = org.json.JSONArray(rawJson)\r\n            val slots = listOf(\r\n                dialogView.findViewById<TextView?>(R.id.recent_alarm_1),\r\n                dialogView.findViewById<TextView?>(R.id.recent_alarm_2),\r\n                dialogView.findViewById<TextView?>(R.id.recent_alarm_3),\r\n                dialogView.findViewById<TextView?>(R.id.recent_alarm_4),\r\n                dialogView.findViewById<TextView?>(R.id.recent_alarm_5)\r\n            )\r\n            for (i in 0 until 5) {\r\n                val tv = slots[i]\r\n                val obj = if (i < arr.length()) try { arr.getJSONObject(i) } catch (_: Exception) { null } else null\r\n                if (obj != null) {\r\n                    val timeMs = obj.optLong(\"time_ms\", 0L)\r\n                    val title = obj.optString(\"title\", \"\")\r\n                    val msg = obj.optString(\"message\", \"\")\r\n                    val timeStr = if (timeMs > 0L) try { java.text.SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\", Locale.getDefault()).format(java.util.Date(timeMs)) } catch (_: Exception) { \"\" } else \"\"\r\n                    if (timeStr.isNotEmpty()) tv?.text = getString(R.string.recent_alarm_with_time, i+1, timeStr, title, msg) else if (title.isNotEmpty()) tv?.text = getString(R.string.recent_alarm_no_time, i+1, title, msg) else tv?.text = getString(R.string.recent_alarm_empty, i+1)\r\n                } else {\r\n                    tv?.text = getString(R.string.recent_alarm_empty, i+1)\r\n                }\r\n            }\r\n        } catch (e: Exception) {\r\n            android.util.Log.w(\"ScadaActivity\", \"Failed to load recent alarms\", e)\r\n        }\r\n\r\n        // Wire Clear History button\r\n        try {\r\n            val btnClear = dialogView.findViewById<android.widget.Button>(R.id.btn_clear_history)\r\n            btnClear.setOnClickListener {\r\n                try {\r\n                    val historyPrefs = getSharedPreferences(\"alarm_history\", Context.MODE_PRIVATE)\r\n                    historyPrefs.edit { putString(\"recent_alarms_json\", \"[]\") }\r\n                    for (i in 1..5) {\r\n                        val tv = dialogView.findViewById<TextView?>(resources.getIdentifier(\"recent_alarm_$i\", \"id\", packageName))\r\n                        tv?.text = getString(R.string.recent_alarm_empty, i)\r\n                    }\r\n                    try { ToastHelper.show(this@ScadaActivity, \"Alarm history cleared\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                } catch (e: Exception) {\r\n                    android.util.Log.w(\"ScadaActivity\", \"Failed to clear alarm history\", e)\r\n                }\r\n            }\r\n        } catch (_: Exception) {}\r\n\r\n        // Save button handler: persist offsets + other prefs\r\n        btnSave?.setOnClickListener {\r\n            val lowP = etLowPressure?.text.toString().toFloatOrNull() ?: 1.0f\r\n            val highA = try { etHighAmps?.text.toString().toFloatOrNull() ?: prefs.getFloat(\"high_amps_threshold\", 6.0f) } catch (_: Exception) { prefs.getFloat(\"high_amps_threshold\", 6.0f) }\r\n            val highADurMin = etHighAmpsDuration?.text.toString().toLongOrNull() ?: 60L\r\n            val variance = etWaterVariance?.text.toString().toFloatOrNull() ?: 0.1f\r\n            val dvrMin = etDvrMinutes?.text.toString().toLongOrNull() ?: 60L\r\n            val hourlyThreshold = etWaterHourlyThreshold?.text.toString().toFloatOrNull() ?: 500f\r\n            val hourlyWindowHours = etWaterHourlyHours?.text.toString().toIntOrNull() ?: 1\r\n\r\n            try {\r\n                prefs.edit {\r\n                    putFloat(\"low_pressure_threshold\", lowP)\r\n                    putFloat(\"high_amps_threshold\", highA)\r\n                    putLong(\"high_amps_duration_ms\", highADurMin * 60000L)\r\n                    putFloat(\"water_variance_threshold\", variance)\r\n                    putLong(\"dvr_stale_minutes\", dvrMin)\r\n                    putFloat(\"water_hourly_volume_threshold\", hourlyThreshold)\r\n                    putInt(\"water_hourly_window_hours\", hourlyWindowHours)\r\n                }\r\n            } catch (e: Exception) {\r\n                android.util.Log.w(\"ScadaActivity\", \"Failed to save alarm prefs\", e)\r\n            }\r\n\r\n            // Also save current seek offset & lights backend into app prefs synchronously\r\n            try {\r\n                val selectedOffset = dialogView.findViewById<android.widget.SeekBar?>(R.id.seek_wind_offset)?.progress?.toFloat() ?: currentOffset\r\n                appPrefs.edit {\r\n                    putFloat(\"wind_arrow_offset_deg\", selectedOffset)\r\n                    val rg = dialogView.findViewById<android.widget.RadioGroup?>(R.id.rg_lights_control)\r\n                    val selected = when (rg?.checkedRadioButtonId) {\r\n                        R.id.rb_control_drive -> \"drive\"\r\n                        else -> \"firebase\"\r\n                    }\r\n                    putString(\"lights_control_backend\", selected)\r\n                }\r\n            } catch (e: Exception) {\r\n                android.util.Log.w(\"ScadaActivity\", \"Failed to save app prefs\", e)\r\n            }\r\n\r\n            try { ToastHelper.show(this@ScadaActivity, \"Alarm settings saved\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n            dialog.dismiss()\r\n            updateAlarmStatus()\r\n            applyLightsBackendSelection()\r\n        }\r\n\r\n        // Clear schedule handler\r\n        try {\r\n            btnClearSecuritySchedule?.setOnClickListener {\r\n                try {\r\n                    appPrefs.edit { remove(\"security_enable_hour\"); remove(\"security_enable_min\"); remove(\"security_disable_hour\"); remove(\"security_disable_min\") }\r\n                    // update buttons to default label\r\n                    dialogView.findViewById<android.widget.Button?>(R.id.btn_security_enable_time)?.text = getString(R.string.set_time)\r\n                    dialogView.findViewById<android.widget.Button?>(R.id.btn_security_disable_time)?.text = getString(R.string.set_time)\r\n                    try { ToastHelper.show(this@ScadaActivity, \"Security schedule cleared\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                } catch (e: Exception) { android.util.Log.w(\"ScadaActivity\", \"Failed clearing security schedule\", e) }\r\n            }\r\n        } catch (_: Exception) {}\r\n\r\n        // Play tone preview handler\r\n        val btnPlayTone = dialogView.findViewById<android.widget.Button>(R.id.btn_play_tone)\r\n        var previewPlayer: android.media.MediaPlayer? = null\r\n        btnPlayTone.setOnClickListener {\r\n            try {\r\n                if (previewPlayer == null) {\r\n                    val afd = resources.openRawResourceFd(R.raw.alarm_tone)\r\n                    previewPlayer = android.media.MediaPlayer()\r\n                    previewPlayer?.setAudioAttributes(\r\n                        android.media.AudioAttributes.Builder()\r\n                            .setUsage(android.media.AudioAttributes.USAGE_ALARM)\r\n                            .setContentType(android.media.AudioAttributes.CONTENT_TYPE_SONIFICATION)\r\n                            .build()\r\n                    )\r\n                    previewPlayer?.setDataSource(afd.fileDescriptor, afd.startOffset, afd.length)\r\n                    afd.close()\r\n                    previewPlayer?.isLooping = false\r\n                    previewPlayer?.prepare()\r\n                    previewPlayer?.start()\r\n                    btnPlayTone.text = getString(R.string.stop)\r\n                } else {\r\n                    try { previewPlayer?.stop() } catch (_: Exception) {}\r\n                    try { previewPlayer?.release() } catch (_: Exception) {}\r\n                    previewPlayer = null\r\n                    btnPlayTone.text = getString(R.string.play_tone)\r\n                }\r\n            } catch (e: Exception) {\r\n                android.util.Log.e(\"ScadaActivity\", \"Failed to play preview tone\", e)\r\n                try { ToastHelper.show(this@ScadaActivity, \"Unable to play tone\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                try { previewPlayer?.release() } catch (_: Exception) {}\r\n                previewPlayer = null\r\n                btnPlayTone.text = getString(R.string.play_tone)\r\n            }\r\n        }\r\n\r\n        // Ensure we stop preview if dialog dismissed\r\n        dialog.setOnDismissListener {\r\n            try { previewPlayer?.stop() } catch (_: Exception) {}\r\n            try { previewPlayer?.release() } catch (_: Exception) {}\r\n            previewPlayer = null\r\n        }\r\n\r\n        // Reset alarm channel handler: delete and recreate app alarm channels using bundled tone\r\n        val btnResetChannel = dialogView.findViewById<android.widget.Button>(R.id.btn_reset_channel)\r\n        btnResetChannel.setOnClickListener {\r\n            try {\r\n                val notificationManager = getSystemService(Context.NOTIFICATION_SERVICE) as android.app.NotificationManager\r\n                val defaultChannelId = getString(R.string.default_notification_channel_id)\r\n                val securityChannelId = \"security_alerts\"\r\n\r\n                if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {\r\n                    try { notificationManager.deleteNotificationChannel(defaultChannelId) } catch (_: Exception) {}\r\n                    try { notificationManager.deleteNotificationChannel(securityChannelId) } catch (_: Exception) {}\r\n                }\r\n\r\n                if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {\r\n                    // Default channel: silent, low importance\r\n                    val defaultChannel = android.app.NotificationChannel(defaultChannelId, \"App Notifications\", android.app.NotificationManager.IMPORTANCE_LOW).apply {\r\n                        description = \"General app notifications (silent)\"\r\n                        setSound(null, null)\r\n                        enableVibration(false)\r\n                        lockscreenVisibility = android.app.Notification.VISIBILITY_PRIVATE\r\n                    }\r\n                    notificationManager.createNotificationChannel(defaultChannel)\r\n\r\n                    // Security channel: audible, high importance\r\n                    val soundUri = android.net.Uri.parse(\"android.resource://$packageName/${R.raw.alarm_tone}\")\r\n                    val audioAttrs = android.media.AudioAttributes.Builder()\r\n                        .setUsage(android.media.AudioAttributes.USAGE_ALARM)\r\n                        .setContentType(android.media.AudioAttributes.CONTENT_TYPE_SONIFICATION)\r\n                        .setFlags(android.media.AudioAttributes.FLAG_AUDIBILITY_ENFORCED)\r\n                        .build()\r\n\r\n                    val secChannel = android.app.NotificationChannel(securityChannelId, \"Security Alerts\", android.app.NotificationManager.IMPORTANCE_HIGH).apply {\r\n                        description = \"Notifications for security breaches\"\r\n                        setSound(soundUri, audioAttrs)\r\n                        enableLights(true)\r\n                        enableVibration(true)\r\n                    }\r\n                    notificationManager.createNotificationChannel(secChannel)\r\n                }\r\n\r\n                try { ToastHelper.show(this@ScadaActivity, \"Alarm channels reset (default silent, security audible)\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n            } catch (e: Exception) {\r\n                android.util.Log.e(\"ScadaActivity\", \"Failed to reset alarm channels\", e)\r\n                try { ToastHelper.show(this@ScadaActivity, \"Failed to reset channels\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n            }\r\n        }\r\n\r\n        dialog.show()\r\n\r\n        // Pre-select the radio group based on stored app pref\r\n        try {\r\n            val backendPref = appPrefs.getString(\"lights_control_backend\", \"firebase\") ?: \"firebase\"\r\n            val rg = dialogView.findViewById<android.widget.RadioGroup?>(R.id.rg_lights_control)\r\n            when (backendPref) {\r\n                \"drive\" -> rg?.check(R.id.rb_control_drive)\r\n                else -> rg?.check(R.id.rb_control_firebase)\r\n            }\r\n        } catch (_: Exception) {}\r\n\r\n        // Save backend explicit button: persist selected backend and apply immediately\r\n        try {\r\n            val btnSaveBackend = dialogView.findViewById<android.widget.Button>(R.id.btn_save_backend)\r\n            val btnReloadBackend = dialogView.findViewById<android.widget.Button>(R.id.btn_reload_backend)\r\n            btnSaveBackend.setOnClickListener {\r\n                try {\r\n                    val rg = dialogView.findViewById<android.widget.RadioGroup?>(R.id.rg_lights_control)\r\n                    val selected = when (rg?.checkedRadioButtonId) {\r\n                        R.id.rb_control_drive -> \"drive\"\r\n                        else -> \"firebase\"\r\n                    }\r\n                    appPrefs.edit { putString(\"lights_control_backend\", selected) }\r\n                    try { ToastHelper.show(this@ScadaActivity, getString(R.string.lights_backend_saved, selected), android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                    applyLightsBackendSelection()\r\n                } catch (e: Exception) {\r\n                    Log.w(\"ScadaActivity\", \"Failed saving backend\", e)\r\n                    try { ToastHelper.show(this@ScadaActivity, \"Failed to save backend\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                }\r\n            }\r\n            btnReloadBackend.setOnClickListener {\r\n                try {\r\n                    try { ToastHelper.show(this@ScadaActivity, \"Reloading backend selection...\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                    applyLightsBackendSelection()\r\n                } catch (e: Exception) {\r\n                    Log.w(\"ScadaActivity\", \"Failed reloading backend\", e)\r\n                }\r\n            }\r\n        } catch (_: Exception) {}\r\n    }\r\n\r\n    // Ensure alarm status text/dot and lights backend selection helpers exist.\r\n    private fun updateAlarmStatus() {\r\n        try {\r\n            val prefs = getSharedPreferences(\"alarm_prefs\", Context.MODE_PRIVATE)\r\n            val highAmpsThreshold = prefs.getFloat(\"high_amps_threshold\", 6.0f).toDouble()\r\n            val lowPressureThreshold = prefs.getFloat(\"low_pressure_threshold\", 1.0f).toDouble()\r\n\r\n            // Extract numeric parts from displayed text (e.g. \"6.2 A\" or \"1.2 bar\")\r\n            val ampsText = try { ampsTextView.text.toString() } catch (_: Exception) { \"\" }\r\n            val pressureText = try { geyserPressureTextView.text.toString() } catch (_: Exception) { \"\" }\r\n            val ampsVal = Regex(\"([-+]?[0-9]*\\\\.?[0-9]+)\").find(ampsText)?.value?.toDoubleOrNull()\r\n            val pressureVal = Regex(\"([-+]?[0-9]*\\\\.?[0-9]+)\").find(pressureText)?.value?.toDoubleOrNull()\r\n\r\n            var alarmActive = false\r\n            if (ampsVal != null && ampsVal > highAmpsThreshold) alarmActive = true\r\n            if (pressureVal != null && pressureVal < lowPressureThreshold) alarmActive = true\r\n\r\n            runOnUiThread {\r\n                try {\r\n                    if (alarmActive) {\r\n                        try { alarmActiveStatus.text = getString(R.string.alarm_active) } catch (_: Exception) { alarmActiveStatus.text = \"ALARM\" }\r\n                        val red = \"#B71C1C\".toColorInt()\r\n                        alarmActiveStatus.setTextColor(red)\r\n                        alarmStatusDot.imageTintList = ColorStateList.valueOf(red)\r\n                        Log.d(\"ScadaActivity\", \"Alarm active (amps=$ampsVal, pressure=$pressureVal)\")\r\n                        // Attempt to trigger the NotificationService test action (safe no-op if service missing)\r\n                        try {\r\n                            val intent = Intent(this, NotificationService::class.java)\r\n                            intent.action = \"com.security.app.ACTION_TEST_ALARMS\"\r\n                            startService(intent)\r\n                        } catch (e: Exception) {\r\n                            Log.w(\"ScadaActivity\", \"Failed to start NotificationService\", e)\r\n                        }\r\n                    } else {\r\n                        try { alarmActiveStatus.text = getString(R.string.alarm_inactive) } catch (_: Exception) { alarmActiveStatus.text = \"OK\" }\r\n                        val green = \"#4CAF50\".toColorInt()\r\n                        alarmActiveStatus.setTextColor(green)\r\n                        alarmStatusDot.imageTintList = ColorStateList.valueOf(green)\r\n                    }\r\n                } catch (e: Exception) {\r\n                    Log.w(\"ScadaActivity\", \"UI update in updateAlarmStatus failed\", e)\r\n                }\r\n            }\r\n        } catch (e: Exception) {\r\n            Log.w(\"ScadaActivity\", \"updateAlarmStatus failed\", e)\r\n        }\r\n    }\r\n\r\n    private fun applyLightsBackendSelection() {\r\n        try {\r\n            val appPrefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n            val backend = appPrefs.getString(\"lights_control_backend\", \"firebase\") ?: \"firebase\"\r\n            Log.d(\"ScadaActivity\", \"applyLightsBackendSelection backend=$backend\")\r\n            if (backend == \"drive\") {\r\n                try {\r\n                    // If the Drive service is already initialized, avoid triggering sign-in again\r\n                    // which would cause initializeDriveService() -> applyLightsBackendSelection() recursion.\r\n                    if (driveService != null) {\r\n                        startLightsPolling()\r\n                    } else {\r\n                        // Drive not yet initialized: ensure we have a signed-in account which will\r\n                        // initialize Drive (initializeDriveService) once available.\r\n                        try { ensureFreshGoogleSignIn() } catch (e: Exception) { Log.w(\"ScadaActivity\", \"ensureFreshGoogleSignIn failed\", e) }\r\n                    }\r\n                } catch (e: Exception) {\r\n                    Log.w(\"ScadaActivity\", \"startLightsPolling failed\", e)\r\n                }\r\n            } else {\r\n                try { drivePollingJob?.cancel() } catch (e: Exception) { Log.w(\"ScadaActivity\", \"cancel drivePollingJob\", e) }\r\n                try { fetchLightsStatusOnce() } catch (e: Exception) { Log.w(\"ScadaActivity\", \"fetchLightsStatusOnce failed\", e) }\r\n            }\r\n        } catch (e: Exception) {\r\n            Log.w(\"ScadaActivity\", \"applyLightsBackendSelection failed\", e)\r\n        }\r\n    }\r\n\r\n    // After views are set up in onCreate or when data refresh completes, update the badge\r\n    private fun updateScadaStatusBadge(isOnline: Boolean) {\r\n        val badge: TextView? = findViewById(R.id.scadaStatusBadge)\r\n        if (badge != null) {\r\n            if (isOnline) {\r\n                badge.text = \"Online\"\r\n                badge.setBackgroundResource(R.drawable.status_badge_background)\r\n                badge.setTextColor(ContextCompat.getColor(this, android.R.color.white))\r\n            } else {\r\n                badge.text = \"Offline\"\r\n                // Use a red background variant if available; fallback by tinting via background swap\r\n                badge.setBackgroundResource(R.drawable.status_badge_background)\r\n                badge.background.setTint(ContextCompat.getColor(this, android.R.color.holo_red_light))\r\n                badge.setTextColor(ContextCompat.getColor(this, android.R.color.white))\r\n            }\r\n        }\r\n    }\r\n\r\n    private fun updatePresenceUI(triggeredByUser: Boolean) {\r\n        // Run in background to avoid blocking UI\r\n        CoroutineScope(Dispatchers.IO).launch {\r\n            val gateway = getGatewayIp()\r\n            val atHome = gateway == \"192.168.8.1\"\r\n            val color: Int\r\n            val text: String\r\n            if (atHome) {\r\n                color = \"#4CAF50\".toColorInt()\r\n                text = \"At home\"\r\n            } else {\r\n                color = \"#B0BEC5\".toColorInt()\r\n                text = \"Away\"\r\n            }\r\n            try {\r\n                withContext(Dispatchers.Main) {\r\n                    try {\r\n                        setupPresenceText.text = text\r\n                        setupPresenceDot.imageTintList = ColorStateList.valueOf(color)\r\n                        if (triggeredByUser) {\r\n                            val gwText = gateway ?: \"unknown\"\r\n                            val msg = \"Gateway: $gwText — $text\"\r\n                            try { ToastHelper.show(this@ScadaActivity, msg, android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                        } else {\r\n                            // no-op else branch to ensure `if` is not treated as an expression missing an else\r\n                        }\r\n                    } catch (e: Exception) {\r\n                        Log.w(\"ScadaActivity\", \"Failed to update presence UI\", e)\r\n                    }\r\n                }\r\n            } catch (e: Exception) {\r\n                Log.w(\"ScadaActivity\", \"updatePresenceUI outer failure\", e)\r\n            }\r\n        }\r\n    }\r\n\r\n    // Obtain gateway IP using ConnectivityManager + LinkProperties (safe alternative to dhcpInfo)\r\n    private fun getGatewayIp(): String? {\r\n        try {\r\n            val cm = getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager\r\n            val active: Network? = cm.activeNetwork\r\n            if (active == null) return null\r\n            val lp: LinkProperties? = cm.getLinkProperties(active)\r\n            if (lp == null) return null\r\n            val routes = lp.routes\r\n            for (route in routes) {\r\n                try {\r\n                    val gw = route.gateway\r\n                    if (gw != null) {\r\n                        val host = gw.hostAddress\r\n                        if (!host.isNullOrEmpty() && host != \"0.0.0.0\") return host\r\n                    }\r\n                } catch (_: Exception) {}\r\n            }\r\n            return null\r\n        } catch (e: Exception) {\r\n            Log.w(\"ScadaActivity\", \"getGatewayIp failed\", e)\r\n            return null\r\n        }\r\n    }\r\n\r\n    // --- New helpers: Sun position + Tide fetch ---\r\n    private fun updateSunAndTides() {\r\n        // Launch coroutine to compute sun position and fetch sunrise/sunset + tides\r\n        CoroutineScope(Dispatchers.Main).launch {\r\n            try {\r\n                // 1) fetch sunrise/sunset from Open-Meteo daily endpoint\r\n                val sunPair = withContext(Dispatchers.IO) { fetchSunriseSunset(SWAK_LAT.toDouble(), SWAK_LON.toDouble()) }\r\n                val sunriseStr = sunPair?.first ?: \"--:--\"\r\n                val sunsetStr = sunPair?.second ?: \"--:--\"\r\n\r\n                // 2) compute current sun elevation/azimuth locally\r\n                val (altDeg, azDeg) = computeSunPosition(SWAK_LAT.toDouble(), SWAK_LON.toDouble(), System.currentTimeMillis())\r\n                val altFmt = String.format(Locale.getDefault(), \"%.0f°\", altDeg)\r\n                val azFmt = String.format(Locale.getDefault(), \"%.0f°\", azDeg)\r\n\r\n                // 3) update sun UI (show only times: sunrise / sunset)\r\n                try {\r\n                    if (::sunInfoTextView.isInitialized) sunInfoTextView.text = \"${sunriseStr} / ${sunsetStr}\"\r\n                } catch (_: Exception) {}\r\n\r\n                // 4) fetch tide (hourly water level) and compute next high/low\r\n                val tideText = withContext(Dispatchers.IO) { fetchNextTideInfo(SWAK_LAT.toDouble(), SWAK_LON.toDouble()) } ?: \"Tide: N/A\"\r\n                try { if (::tideInfoTextView.isInitialized) tideInfoTextView.text = tideText } catch (_: Exception) {}\r\n\r\n            } catch (e: Exception) {\r\n                Log.w(\"ScadaActivity\", \"updateSunAndTides error\", e)\r\n                try { if (::sunInfoTextView.isInitialized) sunInfoTextView.text = \"--:-- / --:--\" } catch (_: Exception) {}\r\n                try { if (::tideInfoTextView.isInitialized) tideInfoTextView.text = \"Tide: N/A\" } catch (_: Exception) {}\r\n            }\r\n        }\r\n    }\r\n\r\n    // Fetch sunrise/sunset (local time) using Open-Meteo daily API\r\n    private fun fetchSunriseSunset(lat: Double, lon: Double): Pair<String, String>? {\r\n        return try {\r\n            val urlStr = \"https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=sunrise,sunset&timezone=auto\"\r\n            val url = URL(urlStr)\r\n            val conn = url.openConnection() as HttpURLConnection\r\n            conn.requestMethod = \"GET\"\r\n            conn.connectTimeout = 8000\r\n            conn.readTimeout = 8000\r\n            conn.connect()\r\n            val code = conn.responseCode\r\n            if (code != 200) return null\r\n            val reader = BufferedReader(InputStreamReader(conn.inputStream))\r\n            val sb = StringBuilder()\r\n            var line: String? = reader.readLine()\r\n            while (line != null) { sb.append(line); line = reader.readLine() }\r\n            reader.close()\r\n            val jo = JSONObject(sb.toString())\r\n            val daily = jo.optJSONObject(\"daily\") ?: return null\r\n            val sunriseArr = daily.optJSONArray(\"sunrise\") ?: return null\r\n            val sunsetArr = daily.optJSONArray(\"sunset\") ?: return null\r\n            val sunrise = sunriseArr.optString(0, \"\")\r\n            val sunset = sunsetArr.optString(0, \"\")\r\n            // sunrise/sunset are returned in ISO format with local date/time; extract time portion\r\n            val sTime = try { sunrise.split(\"T\").getOrNull(1)?.split(\":\")?.let { parts -> \"${parts[0]}:${parts[1]}\" } ?: sunrise } catch (_: Exception) { sunrise }\r\n            val ssTime = try { sunset.split(\"T\").getOrNull(1)?.split(\":\")?.let { parts -> \"${parts[0]}:${parts[1]}\" } ?: sunset } catch (_: Exception) { sunset }\r\n            Pair(sTime, ssTime)\r\n        } catch (e: Exception) {\r\n            Log.w(\"ScadaActivity\", \"fetchSunriseSunset failed\", e)\r\n            null\r\n        }\r\n    }\r\n\r\n    // Fetch hourly water level from Open-Meteo Marine API and compute next high/low tide\r\n    // Returns a short human-readable string like \"High 14:20 (1.2m)\"\r\n    private fun fetchNextTideInfo(lat: Double, lon: Double): String? {\r\n        return try {\r\n            val sg = fetchTideFromStormglass(lat, lon)\r\n            if (!sg.isNullOrEmpty()) {\r\n                Log.d(\"ScadaActivity\", \"fetchNextTideInfo: using Stormglass result\")\r\n                sg\r\n            } else {\r\n                Log.w(\"ScadaActivity\", \"fetchNextTideInfo: Stormglass returned no data\")\r\n                null\r\n            }\r\n        } catch (e: Exception) {\r\n            Log.w(\"ScadaActivity\", \"fetchNextTideInfo failed\", e)\r\n            null\r\n        }\r\n    }\r\n\r\n    // Try Stormglass v2 extremes API as primary tide source.\r\n    // Stormglass v2 extremes endpoint (common pattern): /v2/tide/extremes?lat=...&lng=...&start=...&end=...\r\n    private fun fetchTideFromStormglass(lat: Double, lon: Double): String? {\r\n        try {\r\n            val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n            var apiKey = prefs.getString(\"stormglass_api_key\", null)\r\n            if (apiKey.isNullOrEmpty()) {\r\n                // Prefer the embedded key when no preference is set\r\n                apiKey = EMBEDDED_STORMGLASS_API_KEY.takeIf { it.isNotEmpty() }\r\n                if (apiKey.isNullOrEmpty()) {\r\n                    Log.d(\"ScadaActivity\", \"fetchTideFromStormglass: no API key configured (stormglass_api_key) and no embedded key\")\r\n                    return null\r\n                } else {\r\n                    Log.d(\"ScadaActivity\", \"fetchTideFromStormglass: using embedded Stormglass API key\")\r\n                }\r\n            }\r\n\r\n            // Compute UTC start/end (use date strings yyyy-MM-dd because the /v2/tide/extremes/point\r\n            // endpoint accepts human-readable dates and the plain key header form works with it).\r\n            val now = System.currentTimeMillis()\r\n            val sdfDate = SimpleDateFormat(\"yyyy-MM-dd\", Locale.US)\r\n            sdfDate.timeZone = TimeZone.getTimeZone(\"UTC\")\r\n            val startDate = sdfDate.format(java.util.Date(now))\r\n            val endDate = sdfDate.format(java.util.Date(now + 48 * 3600L * 1000L))\r\n\r\n            // Use the /v2/tide/extremes/point path (works per curl sample). Stormglass accepts\r\n            // Authorization: <key> (no 'Bearer') for many accounts; the code will still try 'Bearer' if needed.\r\n            val urlStr = \"https://api.stormglass.io/v2/tide/extremes/point?lat=${lat}&lng=${lon}&start=${startDate}&end=${endDate}\"\r\n            Log.d(\"ScadaActivity\", \"fetchTideFromStormglass url=$urlStr\")\r\n\r\n            // Try with Authorization: {key} first, then 'Bearer {key}' if 401\r\n            var lastErrBody = \"\"\r\n            for (attempt in 1..2) {\r\n                 val url = URL(urlStr)\r\n                 val conn = url.openConnection() as HttpURLConnection\r\n                 conn.requestMethod = \"GET\"\r\n                 conn.connectTimeout = 10000\r\n                 conn.readTimeout = 10000\r\n                 // Header formats\r\n                 val headerVal = if (attempt == 1) apiKey else \"Bearer $apiKey\"\r\n                 conn.setRequestProperty(\"Authorization\", headerVal)\r\n                 conn.setRequestProperty(\"Accept\", \"application/json\")\r\n                 try { conn.connect() } catch (e: Exception) { Log.w(\"ScadaActivity\", \"Stormglass connect failed (attempt $attempt)\", e); continue }\r\n                val code = try { conn.responseCode } catch (_: Exception) { -1 }\r\n                val body = try {\r\n                    if (code == 200) conn.inputStream.bufferedReader().use { it.readText() } else conn.errorStream?.bufferedReader()?.use { it.readText() } ?: \"\"\r\n                } catch (e: Exception) {\r\n                    Log.w(\"ScadaActivity\", \"Failed reading Stormglass response body\", e)\r\n                    \"\"\r\n                }\r\n                Log.d(\"ScadaActivity\", \"fetchTideFromStormglass HTTP $code (attempt $attempt); body.len=${body.length}\")\r\n                if (code != 200) {\r\n                    lastErrBody = body\r\n                    // If unauthorized on first attempt, try Bearer form once more\r\n                    if (code == 401 && attempt == 1) { continue }\r\n                    // Return a readable error so the UI can show it\r\n                    try {\r\n                        val errJo = if (body.isNotEmpty()) JSONObject(body) else null\r\n                        if (errJo != null && errJo.has(\"errors\")) {\r\n                            val errObj = errJo.opt(\"errors\")\r\n                            return \"Stormglass error HTTP $code: ${errObj?.toString() ?: errObj}\"\r\n                        }\r\n                    } catch (_: Exception) {}\r\n                    return \"Stormglass HTTP $code: ${body.take(512)}\"\r\n                }\r\n                Log.d(\"ScadaActivity\", \"fetchTideFromStormglass response len=${body.length}\")\r\n                 // Parse flexible JSON: many Stormglass responses include 'data' array\r\n                 val jo = JSONObject(body)\r\n                // If the response contains an errors object, return it so the UI shows the reason\r\n                if (jo.has(\"errors\")) {\r\n                    try { return \"Stormglass error: ${jo.opt(\"errors\").toString()}\" } catch (_: Exception) { return \"Stormglass error: ${jo.opt(\"errors\")}\" }\r\n                }\r\n                 // If top-level 'data' is an array of extremes use it\r\n                 val candidateArr = when {\r\n                     jo.has(\"data\") && jo.opt(\"data\") is org.json.JSONArray -> jo.optJSONArray(\"data\")\r\n                     jo.has(\"extremes\") && jo.opt(\"extremes\") is org.json.JSONArray -> jo.optJSONArray(\"extremes\")\r\n                     jo.has(\"hours\") && jo.opt(\"hours\") is org.json.JSONArray -> jo.optJSONArray(\"hours\")\r\n                     else -> null\r\n                 }\r\n                 if (candidateArr != null) {\r\n                    // If the array is empty, return meta information so the UI can show why no data was returned\r\n                    if (candidateArr.length() == 0) {\r\n                        try {\r\n                            val meta = jo.optJSONObject(\"meta\")\r\n                            if (meta != null) {\r\n                                val station = meta.optJSONObject(\"station\")?.optString(\"name\") ?: meta.optString(\"station\", \"(no-station)\")\r\n                                val dist = meta.optJSONObject(\"station\")?.optInt(\"distance\") ?: meta.optInt(\"distance\", -1)\r\n                                val quota = meta.optInt(\"dailyQuota\", -1)\r\n                                val cost = meta.optInt(\"cost\", -1)\r\n                                return \"Stormglass: no tide data for dates $startDate..$endDate (station=${station}, distance=${dist}km, dailyQuota=${quota}, cost=${cost})\"\r\n                            }\r\n                        } catch (_: Exception) {}\r\n                        return \"Stormglass: no tide data returned for dates $startDate..$endDate\"\r\n                    }\r\n                    // Stormglass typically returns objects with keys like 'time' or 't' and 'height'\r\n                    return parseHeightsArrayToHighLow(candidateArr)\r\n                }\r\n\r\n                // Some responses use an object with a 'data' object keyed by source — try to find first array of objects\r\n                val joKeysIt = jo.keys()\r\n                while (joKeysIt.hasNext()) {\r\n                    val k = joKeysIt.next()\r\n                    val opt = jo.opt(k)\r\n                    if (opt is org.json.JSONArray && opt.length() > 0 && opt.optJSONObject(0) != null) {\r\n                        Log.d(\"ScadaActivity\", \"fetchTideFromStormglass: using array key=$k as candidate\")\r\n                        return parseHeightsArrayToHighLow(opt as org.json.JSONArray)\r\n                    }\r\n                }\r\n                // Nothing found — return the raw response keys for debugging\r\n                Log.w(\"ScadaActivity\", \"fetchTideFromStormglass: no usable array found in response; lastErr=${lastErrBody.take(512)}\")\r\n                val keysList = mutableListOf<String>()\r\n                val it = jo.keys()\r\n                while (it.hasNext()) keysList.add(it.next())\r\n                return \"Stormglass: no usable tide array found. Response keys=${keysList.joinToString(\",\")}\"\r\n             }\r\n             return null\r\n         } catch (e: Exception) {\r\n             Log.w(\"ScadaActivity\", \"fetchTideFromStormglass failed\", e)\r\n             return null\r\n         }\r\n     }\r\n\r\n    // Show a simple prompt to view/edit the Stormglass API key (embedded key used if prefs empty)\r\n    private fun showStormglassKeyDialog() {\r\n         try {\r\n            Log.d(\"ScadaActivity\", \"showStormglassKeyDialog called\")\r\n             val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n             val currentStorm = prefs.getString(\"stormglass_api_key\", \"\") ?: \"\"\r\n             val layout = android.widget.LinearLayout(this)\r\n             layout.orientation = android.widget.LinearLayout.VERTICAL\r\n             val stormInput = android.widget.EditText(this)\r\n             stormInput.hint = \"Stormglass API key\"\r\n             stormInput.setText(currentStorm)\r\n             val lp = android.widget.LinearLayout.LayoutParams(android.widget.LinearLayout.LayoutParams.MATCH_PARENT, android.widget.LinearLayout.LayoutParams.WRAP_CONTENT)\r\n             lp.setMargins(8,8,8,8)\r\n             layout.addView(stormInput, lp)\r\n\r\n            androidx.appcompat.app.AlertDialog.Builder(this)\r\n                .setTitle(\"Stormglass API Key\")\r\n                .setMessage(\"Enter your Stormglass API key. If left blank, the embedded key from the repo will be used.\")\r\n                .setView(layout)\r\n                .setPositiveButton(\"Save\") { _, _ ->\r\n                    val storm = stormInput.text.toString().trim()\r\n                    prefs.edit { putString(\"stormglass_api_key\", storm) }\r\n                    try { ToastHelper.show(this@ScadaActivity, \"Stormglass key saved\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                }\r\n                .setNegativeButton(\"Cancel\", null)\r\n                .show()\r\n        } catch (e: Exception) {\r\n            Log.w(\"ScadaActivity\", \"showStormglassKeyDialog failed\", e)\r\n        }\r\n    }\r\n\r\n    // Fallback: query WorldTides for heights (kept as flexible parser)\r\n    private fun fetchTideFromWorldTides(lat: Double, lon: Double): String? {\r\n        // WorldTides support removed — Stormglass is the sole tide provider.\r\n        // If WorldTides is needed later, re-add a dedicated fetch function here.\r\n        return null\r\n    }\r\n\r\n    // Parse a generic 'heights' JSONArray (flexible key names) and return a \"High HH:MM (1.2m)\\nLow ...\" string\r\n    private fun parseHeightsArrayToHighLow(arr: JSONArray): String? {\r\n        try {\r\n            val data = mutableListOf<Pair<Long, Double>>()\r\n            for (i in 0 until arr.length()) {\r\n                val el = arr.optJSONObject(i) ?: continue\r\n                var tMillis: Long? = null\r\n                if (el.has(\"dt\")) {\r\n                    val dtVal = el.optLong(\"dt\", 0L)\r\n                    if (dtVal > 1000000000L) tMillis = dtVal * 1000L\r\n                }\r\n                if (tMillis == null && el.has(\"timestamp\")) {\r\n                    val ts = el.optLong(\"timestamp\", 0L)\r\n                    if (ts > 1000000000L) tMillis = ts * 1000L\r\n                }\r\n                if (tMillis == null && el.has(\"date\")) {\r\n                    val ds = el.optString(\"date\", \"\")\r\n                    tMillis = parseIsoDateToMillis(ds)\r\n                }\r\n                if (tMillis == null && el.has(\"time\")) {\r\n                    val ds = el.optString(\"time\", \"\")\r\n                    tMillis = parseIsoDateToMillis(ds)\r\n                }\r\n                var h: Double = Double.NaN\r\n                if (el.has(\"height\")) h = el.optDouble(\"height\", Double.NaN)\r\n                if (h.isNaN() && el.has(\"h\")) h = el.optDouble(\"h\", Double.NaN)\r\n                if (h.isNaN() && el.has(\"height_m\")) h = el.optDouble(\"height_m\", Double.NaN)\r\n                if (h.isNaN() && el.has(\"value\")) h = el.optDouble(\"value\", Double.NaN)\r\n                if (tMillis != null && !h.isNaN()) data.add(Pair(tMillis, h))\r\n            }\r\n            if (data.isEmpty()) return null\r\n            data.sortBy { it.first }\r\n            val now = System.currentTimeMillis()\r\n            val idxNow = data.indexOfFirst { it.first > now }\r\n            val searchStart = if (idxNow >= 0) idxNow else 0\r\n            var nextHighIdx: Int? = null\r\n            var nextLowIdx: Int? = null\r\n            for (i in searchStart until data.size - 1) {\r\n                val prev = data.getOrNull(i - 1)?.second ?: continue\r\n                val cur = data[i].second\r\n                val next = data.getOrNull(i + 1)?.second ?: continue\r\n                if (cur > prev && cur > next && nextHighIdx == null) nextHighIdx = i\r\n                if (cur < prev && cur < next && nextLowIdx == null) nextLowIdx = i\r\n                if (nextHighIdx != null && nextLowIdx != null) break\r\n            }\r\n            val sb = StringBuilder()\r\n            if (nextHighIdx != null) {\r\n                val (t, lvl) = data[nextHighIdx]\r\n                val cal = java.util.Calendar.getInstance()\r\n                cal.timeInMillis = t\r\n                val hh = cal.get(java.util.Calendar.HOUR_OF_DAY)\r\n                val mm = cal.get(java.util.Calendar.MINUTE)\r\n                sb.append(\"High ${String.format(Locale.getDefault(), \"%02d:%02d\", hh, mm)} (${String.format(Locale.getDefault(), \"%.2fm\", lvl)})\")\r\n            }\r\n            if (nextLowIdx != null) {\r\n                if (sb.isNotEmpty()) sb.append(\"\\n\")\r\n                val (t, lvl) = data[nextLowIdx]\r\n                val cal = java.util.Calendar.getInstance()\r\n                cal.timeInMillis = t\r\n                val hh = cal.get(java.util.Calendar.HOUR_OF_DAY)\r\n                val mm = cal.get(java.util.Calendar.MINUTE)\r\n                sb.append(\"Low ${String.format(Locale.getDefault(), \"%02d:%02d\", hh, mm)} (${String.format(Locale.getDefault(), \"%.2fm\", lvl)})\")\r\n            }\r\n            return if (sb.isEmpty()) null else sb.toString()\r\n        } catch (e: Exception) {\r\n            Log.w(\"ScadaActivity\", \"parseHeightsArrayToHighLow failed\", e)\r\n            return null\r\n        }\r\n    }\r\n\r\n    // Small helper to parse common ISO date/time strings to millis (UTC-aware)\r\n    private fun parseIsoDateToMillis(s: String): Long? {\r\n        val trimmed = s.trim()\r\n        if (trimmed.isEmpty()) return null\r\n        val patterns = listOf(\"yyyy-MM-dd'T'HH:mm:ss'Z'\", \"yyyy-MM-dd'T'HH:mm:ssX\", \"yyyy-MM-dd'T'HH:mm'Z'\", \"yyyy-MM-dd'T'HH:mmX\", \"yyyy-MM-dd HH:mm:ss\")\r\n        for (p in patterns) {\r\n            try {\r\n                val sdf = SimpleDateFormat(p, Locale.US)\r\n                sdf.timeZone = TimeZone.getTimeZone(\"UTC\")\r\n                val d = sdf.parse(trimmed)\r\n                if (d != null) return d.time\r\n            } catch (_: Exception) {}\r\n        }\r\n        try {\r\n            val n = trimmed.toLongOrNull()\r\n            if (n != null && n > 1000000000L) return if (trimmed.length == 10) n * 1000L else n\r\n        } catch (_: Exception) {}\r\n        return null\r\n    }\r\n\r\n    // Compute approximate sun position (altitude, azimuth in degrees) using simple astronomy formulas\r\n    private fun computeSunPosition(lat: Double, lon: Double, timeMillis: Long): Pair<Double, Double> {\r\n        try {\r\n            val jd = julianDate(timeMillis)\r\n            val n = jd - 2451545.0\r\n            val L = (280.460 + 0.9856474 * n) % 360.0\r\n            val g = Math.toRadians((357.528 + 0.9856003 * n) % 360.0)\r\n            val lambda = Math.toRadians((L + 1.915 * sin(g) + 0.020 * sin(2 * g)) % 360.0)\r\n            val epsilon = Math.toRadians(23.439 - 0.0000004 * n)\r\n            val sinDec = sin(epsilon) * sin(lambda)\r\n            val dec = asin(sinDec)\r\n            val ra = atan2(cos(epsilon) * sin(lambda), cos(lambda))\r\n            val gmst = (280.46061837 + 360.98564736629 * (jd - 2451545.0)) % 360.0\r\n            val lst = Math.toRadians((gmst + lon) % 360.0)\r\n            val hourAngle = lst - ra\r\n            val latRad = Math.toRadians(lat)\r\n            val altitude = asin(sin(latRad) * sin(dec) + cos(latRad) * cos(dec) * cos(hourAngle))\r\n            val azimuth = atan2(-sin(hourAngle), tan(dec) * cos(latRad) - sin(latRad) * cos(hourAngle))\r\n            val altDeg = Math.toDegrees(altitude)\r\n            val azDeg = (Math.toDegrees(azimuth) + 360.0) % 360.0\r\n            return Pair(altDeg, azDeg)\r\n        } catch (e: Exception) {\r\n            Log.w(\"ScadaActivity\", \"computeSunPosition failed\", e)\r\n            return Pair(0.0, 0.0)\r\n        }\r\n    }\r\n\r\n    private fun julianDate(timeMillis: Long): Double {\r\n        val dt = timeMillis.toDouble() / 1000.0\r\n        val jd = dt / 86400.0 + 2440587.5\r\n        return jd\r\n    }\r\n\r\n    // Debug helper — dumps current auth token/claims and attempts a safe test write to diagnostics/test_client_write\r\n    fun debugFirestoreAuthAndWrite() {\r\n        try {\r\n            val user = auth.currentUser\r\n            android.util.Log.d(\"ScadaDebug\", \"currentUser uid=${'$'}{user?.uid} email=${'$'}{user?.email} displayName=${'$'}{user?.displayName}\")\r\n\r\n            user?.getIdToken(true)?.addOnSuccessListener { result ->\r\n                val token = result.token\r\n                android.util.Log.d(\"ScadaDebug\", \"ID token (truncated): ${'$'}{token?.take(256)}\")\r\n                try { android.util.Log.d(\"ScadaDebug\", \"Token claims: ${'$'}{result.claims}\") } catch (_: Exception) {}\r\n            }?.addOnFailureListener { e ->\r\n                android.util.Log.w(\"ScadaDebug\", \"Failed to get ID token\", e)\r\n            }\r\n\r\n            val testDoc = FirebaseFirestore.getInstance().collection(\"diagnostics\").document(\"test_client_write\")\r\n            val payload = hashMapOf<String, Any>(\r\n                \"by\" to (user?.email ?: user?.uid ?: \"unknown\"),\r\n                \"ts\" to com.google.firebase.firestore.FieldValue.serverTimestamp(),\r\n                \"note\" to \"client debug write\"\r\n            )\r\n            testDoc.set(payload)\r\n                .addOnSuccessListener {\r\n                    android.util.Log.i(\"ScadaDebug\", \"Test write succeeded\")\r\n                }\r\n                .addOnFailureListener { e ->\r\n                    android.util.Log.e(\"ScadaDebug\", \"Test write FAILED\", e)\r\n                    if (e is com.google.firebase.firestore.FirebaseFirestoreException) {\r\n                        android.util.Log.e(\"ScadaDebug\", \"FirestoreException: code=${'$'}{e.code} msg=${'$'}{e.message}\")\r\n                    }\r\n                }\r\n        } catch (e: Exception) {\r\n            android.util.Log.e(\"ScadaDebug\", \"debugFirestoreAuthAndWrite failed\", e)\r\n        }\r\n    }\r\n\r\n    // Auto-invoke debug helper in debug builds (deferred to allow onCreate to initialize Firebase)\r\n    fun autoInvokeDebugIfNeeded() {\r\n        try {\r\n            val isDebuggable = try {\r\n                (applicationInfo.flags and android.content.pm.ApplicationInfo.FLAG_DEBUGGABLE) != 0\r\n            } catch (_: Exception) { false }\r\n            if (isDebuggable) {\r\n                android.util.Log.d(\"ScadaDebug\", \"Scheduling auto-invoke debugFirestoreAuthAndWrite() (debuggable app)\")\r\n                android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({\r\n                    try { debugFirestoreAuthAndWrite() } catch (_: Exception) {}\r\n                }, 2000)\r\n            }\r\n        } catch (_: Exception) {}\r\n    }\r\n\r\n}\r\n\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/security/app/ScadaActivity.kt b/app/src/main/java/com/security/app/ScadaActivity.kt
--- a/app/src/main/java/com/security/app/ScadaActivity.kt	(revision 44d69ffda4d1488978c0d0db75712de451938b41)
+++ b/app/src/main/java/com/security/app/ScadaActivity.kt	(date 1766912942452)
@@ -50,9 +50,22 @@
 import java.text.SimpleDateFormat
 import java.util.TimeZone
 import kotlin.math.*
+import com.google.firebase.messaging.FirebaseMessaging
+import android.os.Handler
+import android.os.Looper
 
 class ScadaActivity : BaseActivity() {
 
+    // FCM status handler and runnable for periodic checks
+    private val fcmStatusHandler = Handler(Looper.getMainLooper())
+    private val fcmStatusRunnable = object : Runnable {
+        override fun run() {
+            try { checkFcmStatus() } catch (_: Exception) {}
+            // schedule next check in 1 hour
+            fcmStatusHandler.postDelayed(this, 60 * 60 * 1000L)
+        }
+    }
+
     private lateinit var ampsTextView: TextView
     private lateinit var kwTextView: TextView
     private lateinit var diagnosticsText: TextView
@@ -164,6 +177,10 @@
     // Drive polling job (so we can cancel it when switching backends)
     private var drivePollingJob: kotlinx.coroutines.Job? = null
 
+    // Dashboard lights controller buttons (duplicated controller on the dashboard page)
+    private var dashLightsOnBtn: android.widget.Button? = null
+    private var dashLightsOffBtn: android.widget.Button? = null
+
     // Google Drive API
     private lateinit var googleSignInClient: GoogleSignInClient
     private var driveService: Drive? = null
@@ -178,6 +195,18 @@
         Log.d("ScadaActivity", "onCreate called")
         super.onCreate(savedInstanceState)
         setContentView(R.layout.activity_scada)
+        // Kick off initial FCM status check soon after UI binds
+        try { fcmStatusHandler.postDelayed(fcmStatusRunnable, 5_000L) } catch (_: Exception) {}
+
+        // Handle dashboard intent for lights quick action
+        try {
+            val action = intent?.getStringExtra("lights_action")
+            if (action == "on") {
+                try { LightsService().writeOutsideLights(this@ScadaActivity, true) } catch (e: Exception) { Log.w("ScadaActivity", "writeOutsideLights(true) failed: ${e.message}") }
+            } else if (action == "off") {
+                try { LightsService().writeOutsideLights(this@ScadaActivity, false) } catch (e: Exception) { Log.w("ScadaActivity", "writeOutsideLights(false) failed: ${e.message}") }
+            }
+        } catch (e: Exception) { Log.w("ScadaActivity", "Reading lights_action failed: ${e.message}") }
 
         // Initialize Activity Result launcher for Google Sign-In
         signInLauncher = registerForActivityResult(ActivityResultContracts.StartActivityForResult()) { result: ActivityResult ->
@@ -224,6 +253,28 @@
         alarmStatusDot = findViewById(R.id.alarmStatusDot)
         dvrStatusDot = findViewById(R.id.dvrStatusDot)
 
+        // Hook up dashboard lights controller (if present in the layout)
+        try {
+            dashLightsOnBtn = findViewById(R.id.dashboardLightsOnButton)
+            dashLightsOffBtn = findViewById(R.id.dashboardLightsOffButton)
+            dashLightsOnBtn?.apply {
+                isEnabled = true
+                setOnClickListener {
+                    LightsService().writeOutsideLights(this@ScadaActivity, true)
+                    try { startLightsPolling() } catch (_: Exception) {}
+                }
+            }
+            dashLightsOffBtn?.apply {
+                isEnabled = true
+                setOnClickListener {
+                    LightsService().writeOutsideLights(this@ScadaActivity, false)
+                    try { startLightsPolling() } catch (_: Exception) {}
+                }
+            }
+        } catch (e: Exception) {
+            Log.w("ScadaActivity", "Dashboard lights controller wiring skipped", e)
+        }
+
         // New: bind sun/tide views (layout added)
         try {
             sunInfoTextView = findViewById(R.id.sunInfo)
@@ -326,157 +377,34 @@
         // Setup lights control buttons
         val lightsOnButton = findViewById<android.widget.Button>(R.id.lightsOnButton)
         val lightsOffButton = findViewById<android.widget.Button>(R.id.lightsOffButton)
-        // Enable buttons immediately so users can send Firebase/bridge commands even when Drive isn't signed-in.
         lightsOnButton.isEnabled = true
         lightsOffButton.isEnabled = true
         Log.d("ScadaActivity", "Lights buttons enabled at startup")
-        // New: Firestore-based lights commands (replace Drive-based flow)
-        val dbFs = FirebaseFirestore.getInstance()
-        // Bridge expects Flights_commands/current_command — write there as well for compatibility with the local bridge
-        val bridgeCmdDoc = dbFs.collection("Flights_commands").document("current_command")
-
-        // Helper that writes a bridge-compatible payload to Flights_commands/current_command
-        fun writeBridgeCommand(desired: Boolean, onSuccess: (() -> Unit)? = null, onFailure: ((Exception) -> Unit)? = null) {
-            try {
-                val bridgePayload = hashMapOf<String, Any>(
-                    "desired" to desired,
-                    "desired_ts" to com.google.firebase.firestore.FieldValue.serverTimestamp(),
-                    "command" to if (desired) "on" else "off",
-                    "command_ts" to com.google.firebase.firestore.FieldValue.serverTimestamp(),
-                    "command_source" to "android_app"
-                )
-
-                bridgeCmdDoc.set(bridgePayload, com.google.firebase.firestore.SetOptions.merge())
-                    .addOnSuccessListener {
-                        Log.d("ScadaActivity", "Wrote bridge command doc (desired=$desired)")
-                        // Read back the document to confirm the write landed and log/notify user for debugging
-                        try {
-                            bridgeCmdDoc.get()
-                                .addOnSuccessListener { bdoc ->
-                                    Log.d("ScadaActivity", "bridgeCmdDoc after write: ${bdoc.data}")
-                                    val sb = bdoc.data?.toString() ?: "(no bridge doc)"
-                                    try { ToastHelper.show(this@ScadaActivity, getString(R.string.bridge_doc_readback, sb), android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}
-                                }
-                                .addOnFailureListener { e -> Log.w("ScadaDiag", "Failed reading bridgeCmdDoc", e) }
-                        } catch (e: Exception) {
-                            Log.w("ScadaDiag", "Readback failed", e)
-                        }
-                        onSuccess?.invoke()
-                    }
-                    .addOnFailureListener { e ->
-                        Log.e("ScadaActivity", "Failed writing bridge command doc", e)
-                        // Log current auth state for diagnosis
-                        try {
-                            val currentUser = auth?.currentUser
-                            Log.d("ScadaActivity", "Firebase auth currentUser uid=${currentUser?.uid} email=${currentUser?.email}")
-                        } catch (_: Exception) {}
-
-                        // Enhanced handling: if PERMISSION_DENIED, prompt user to re-authenticate
-                        val isPermError = try {
-                            (e is com.google.firebase.firestore.FirebaseFirestoreException && e.code == com.google.firebase.firestore.FirebaseFirestoreException.Code.PERMISSION_DENIED)
-                                    || (e?.message?.contains("PERMISSION_DENIED", ignoreCase = true) == true)
-                        } catch (_: Exception) { false }
 
-                        if (isPermError) {
-                            runOnUiThread {
-                                try {
-                                    androidx.appcompat.app.AlertDialog.Builder(this@ScadaActivity)
-                                        .setTitle(R.string.error_short)
-                                        .setMessage("Permission error sending bridge command:\n${e?.message}\n\nWould you like to sign in to Google to restore permissions?")
-                                        .setPositiveButton(android.R.string.ok, { _, _ -> try { ensureFreshGoogleSignIn() } catch (_: Exception) {} })
-                                        .setNegativeButton(android.R.string.cancel, null)
-                                        .show()
-                                } catch (_: Exception) {
-                                    try { ToastHelper.show(this@ScadaActivity, "Permission error: ${e?.message}", android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}
-                                }
-                            }
-                        } else {
-                            onFailure?.invoke(e)
-                        }
-                    }
-            } catch (e: Exception) {
-                Log.e("ScadaActivity", "Exception preparing bridge payload", e)
-                onFailure?.invoke(e)
-            }
-        }
-
+        // Use centralized LightsService for bridge writes (removes duplication)
         lightsOnButton.setOnClickListener {
-             Log.d("ScadaActivity", "Lights ON clicked — writing bridge command")
-             writeBridgeCommand(true,
-                 onSuccess = {
-                     ToastHelper.show(this@ScadaActivity, getString(R.string.bridge_command_on_sent), android.widget.Toast.LENGTH_SHORT)
-                     try { startLightsPolling() } catch (_: Exception) {}
-                 },
-                 onFailure = { e ->
-                     Log.e("ScadaActivity", "Lights ON write failed", e)
-                     try {
-                         val currentUser = auth?.currentUser
-                         Log.d("ScadaActivity", "auth.currentUser uid=${currentUser?.uid} email=${currentUser?.email}")
-                     } catch (_: Exception) {}
-                     val errMsg = try { e?.message ?: e.toString() } catch (_: Exception) { "Unknown error" }
-                     val isPerm = try {
-                         (e is com.google.firebase.firestore.FirebaseFirestoreException && e.code == com.google.firebase.firestore.FirebaseFirestoreException.Code.PERMISSION_DENIED)
-                                 || errMsg.contains("PERMISSION_DENIED", ignoreCase = true)
-                     } catch (_: Exception) { false }
-                     if (isPerm) {
-                         runOnUiThread {
-                             try {
-                                 androidx.appcompat.app.AlertDialog.Builder(this@ScadaActivity)
-                                     .setTitle(R.string.error_short)
-                                     .setMessage("Permission error sending bridge command:\n$errMsg\n\nWould you like to sign in to Google to restore permissions?")
-                                     .setPositiveButton(android.R.string.ok, { _, _ -> try { ensureFreshGoogleSignIn() } catch (_: Exception) {} })
-                                     .setNegativeButton(android.R.string.cancel, null)
-                                     .show()
-                             } catch (_: Exception) {
-                                 try { ToastHelper.show(this@ScadaActivity, "Permission error: $errMsg", android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}
-                             }
-                         }
-                     } else {
-                         try { ToastHelper.show(this@ScadaActivity, getString(R.string.failed_send_bridge_command, errMsg), android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}
-                         try { ensureFreshGoogleSignIn() } catch (_: Exception) {}
-                     }
-                 }
-             )
-         }
-
-         lightsOffButton.setOnClickListener {
-             Log.d("ScadaActivity", "Lights OFF clicked — writing bridge command")
-             writeBridgeCommand(false,
-                 onSuccess = {
-                     ToastHelper.show(this@ScadaActivity, getString(R.string.bridge_command_off_sent), android.widget.Toast.LENGTH_SHORT)
-                     try { startLightsPolling() } catch (_: Exception) {}
-                 },
-                 onFailure = { e ->
-                     Log.e("ScadaActivity", "Lights OFF write failed", e)
-                     try {
-                         val currentUser = auth?.currentUser
-                         Log.d("ScadaActivity", "auth.currentUser uid=${currentUser?.uid} email=${currentUser?.email}")
-                     } catch (_: Exception) {}
-                     val errMsg = try { e?.message ?: e.toString() } catch (_: Exception) { "Unknown error" }
-                     val isPerm = try {
-                         (e is com.google.firebase.firestore.FirebaseFirestoreException && e.code == com.google.firebase.firestore.FirebaseFirestoreException.Code.PERMISSION_DENIED)
-                                 || errMsg.contains("PERMISSION_DENIED", ignoreCase = true)
-                     } catch (_: Exception) { false }
-                     if (isPerm) {
-                         runOnUiThread {
-                             try {
-                                 androidx.appcompat.app.AlertDialog.Builder(this@ScadaActivity)
-                                     .setTitle(R.string.error_short)
-                                     .setMessage("Permission error sending bridge command:\n$errMsg\n\nWould you like to sign in to Google to restore permissions?")
-                                     .setPositiveButton(android.R.string.ok, { _, _ -> try { ensureFreshGoogleSignIn() } catch (_: Exception) {} })
-                                     .setNegativeButton(android.R.string.cancel, null)
-                                     .show()
-                             } catch (_: Exception) {
-                                 try { ToastHelper.show(this@ScadaActivity, "Permission error: $errMsg", android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}
-                             }
-                         }
-                     } else {
-                         try { ToastHelper.show(this@ScadaActivity, getString(R.string.failed_send_bridge_command, errMsg), android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}
-                         try { ensureFreshGoogleSignIn() } catch (_: Exception) {}
-                     }
-                 }
-             )
-         }
+            Log.d("ScadaActivity", "Lights ON clicked — using LightsService")
+            val ok = LightsService().writeOutsideLights(this@ScadaActivity, true)
+            if (ok) {
+                try { ToastHelper.show(this@ScadaActivity, getString(R.string.bridge_command_on_sent), android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}
+            } else {
+                try { ToastHelper.show(this@ScadaActivity, getString(R.string.failed_send_bridge_command, "service write failed"), android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}
+            }
+            try { fetchLightsStatusOnce() } catch (_: Exception) {}
+        }
+        lightsOffButton.setOnClickListener {
+            Log.d("ScadaActivity", "Lights OFF clicked — using LightsService")
+            val ok = LightsService().writeOutsideLights(this@ScadaActivity, false)
+            if (ok) {
+                try { ToastHelper.show(this@ScadaActivity, getString(R.string.bridge_command_off_sent), android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}
+            } else {
+                try { ToastHelper.show(this@ScadaActivity, getString(R.string.failed_send_bridge_command, "service write failed"), android.widget.Toast.LENGTH_LONG) } catch (_: Exception) {}
+            }
+            try { fetchLightsStatusOnce() } catch (_: Exception) {}
+        }
+
+        // Expose lights control for intent quick action
+        // (removed local function; now call class-level toggleOutsideLights)
 
         // Setup click listeners for graphs
         setupGraphClickListeners()
@@ -536,6 +464,115 @@
         try { ToastHelper.show(this@ScadaActivity, "Data refreshed", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}
     }
 
+    override fun onResume() {
+        super.onResume()
+        // Run an immediate check and (re)start hourly checks while the Activity is in foreground
+        try {
+            checkFcmStatus()
+            fcmStatusHandler.removeCallbacks(fcmStatusRunnable)
+            fcmStatusHandler.postDelayed(fcmStatusRunnable, 60 * 60 * 1000L)
+        } catch (_: Exception) {}
+    }
+
+    override fun onPause() {
+        // Stop periodic checks when not visible to prevent misleading stale status
+        try { fcmStatusHandler.removeCallbacks(fcmStatusRunnable) } catch (_: Exception) {}
+        super.onPause()
+    }
+
+    override fun onDestroy() {
+        // Remove FCM status callbacks
+        try { fcmStatusHandler.removeCallbacks(fcmStatusRunnable) } catch (_: Exception) {}
+        super.onDestroy()
+    }
+
+    private fun hasActiveNetwork(): Boolean {
+        return try {
+            val cm = getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager
+            val n = cm.activeNetwork ?: return false
+            val caps = cm.getNetworkCapabilities(n) ?: return false
+            // Treat transport presence as connectivity
+            caps.hasTransport(android.net.NetworkCapabilities.TRANSPORT_WIFI) ||
+            caps.hasTransport(android.net.NetworkCapabilities.TRANSPORT_CELLULAR) ||
+            caps.hasTransport(android.net.NetworkCapabilities.TRANSPORT_ETHERNET)
+        } catch (_: Exception) { false }
+    }
+
+    private fun checkFcmStatus() {
+        val deviceOnline = hasActiveNetwork()
+        try {
+            FirebaseMessaging.getInstance().token
+                .addOnCompleteListener { task ->
+                    val tokenOk = task.isSuccessful && !task.result.isNullOrBlank()
+                    val isOnline = deviceOnline && tokenOk
+                    val statusText = if (isOnline) "FCM: Online" else "FCM: Offline"
+                    // Update System Health diagnosticsText line without clobbering other info
+                    try {
+                        val current = diagnosticsText.text?.toString() ?: ""
+                        val lines = current.split('\n')
+                        val rebuilt = StringBuilder()
+                        var injected = false
+                        for (line in lines) {
+                            if (line.trim().startsWith("FCM:")) {
+                                rebuilt.append(statusText).append('\n')
+                                injected = true
+                            } else {
+                                if (line.isNotEmpty()) rebuilt.append(line).append('\n')
+                            }
+                        }
+                        if (!injected) {
+                            if (rebuilt.isNotEmpty() && rebuilt.last() != '\n') rebuilt.append('\n')
+                            rebuilt.append(statusText)
+                        }
+                        diagnosticsText.text = rebuilt.toString().trimEnd()
+                    } catch (_: Exception) {}
+                }
+                .addOnFailureListener {
+                    val statusText = "FCM: Offline"
+                    try {
+                        val current = diagnosticsText.text?.toString() ?: ""
+                        val lines = current.split('\n')
+                        val rebuilt = StringBuilder()
+                        var injected = false
+                        for (line in lines) {
+                            if (line.trim().startsWith("FCM:")) {
+                                rebuilt.append(statusText).append('\n')
+                                injected = true
+                            } else {
+                                if (line.isNotEmpty()) rebuilt.append(line).append('\n')
+                            }
+                        }
+                        if (!injected) {
+                            if (rebuilt.isNotEmpty() && rebuilt.last() != '\n') rebuilt.append('\n')
+                            rebuilt.append(statusText)
+                        }
+                        diagnosticsText.text = rebuilt.toString().trimEnd()
+                    } catch (_: Exception) {}
+                }
+        } catch (_: Exception) {
+            val statusText = "FCM: Offline"
+            try {
+                val current = diagnosticsText.text?.toString() ?: ""
+                val lines = current.split('\n')
+                val rebuilt = StringBuilder()
+                var injected = false
+                for (line in lines) {
+                    if (line.trim().startsWith("FCM:")) {
+                        rebuilt.append(statusText).append('\n')
+                        injected = true
+                    } else {
+                        if (line.isNotEmpty()) rebuilt.append(line).append('\n')
+                    }
+                }
+                if (!injected) {
+                    if (rebuilt.isNotEmpty() && rebuilt.last() != '\n') rebuilt.append('\n')
+                    rebuilt.append(statusText)
+                }
+                diagnosticsText.text = rebuilt.toString().trimEnd()
+            } catch (_: Exception) {}
+        }
+    }
+
     private fun setupGraphClickListeners() {
         // Weather section click - show weather graphs
         findViewById<android.widget.LinearLayout>(R.id.weatherSection).setOnClickListener {
@@ -1195,6 +1232,28 @@
         }
     }
 
+    /**
+     * Unified handler retained for backward references; now delegates to LightsService.
+     */
+    private fun toggleOutsideLights(desiredOn: Boolean) {
+        try {
+            val ok = LightsService().writeOutsideLights(this@ScadaActivity, desiredOn)
+            if (ok) {
+                runOnUiThread {
+                    val msg = if (desiredOn) getString(R.string.bridge_command_on_sent) else getString(R.string.bridge_command_off_sent)
+                    android.widget.Toast.makeText(this, msg, android.widget.Toast.LENGTH_SHORT).show()
+                }
+            } else {
+                runOnUiThread {
+                    android.widget.Toast.makeText(this, getString(R.string.failed_send_bridge_command, "service write failed"), android.widget.Toast.LENGTH_LONG).show()
+                }
+            }
+            try { fetchLightsStatusOnce() } catch (_: Exception) {}
+        } catch (e: Exception) {
+            Log.w("ScadaActivity", "toggleOutsideLights via service failed", e)
+        }
+    }
+
     // ---- Stubs to satisfy references during cleanup. These are small no-ops that log actions.
     private fun setupLightsListener() {
         // Previously this started a realtime listener. For now we perform a single fetch.
@@ -1701,23 +1760,21 @@
         }
     }
 
-    // After views are set up in onCreate or when data refresh completes, update the badge
-    private fun updateScadaStatusBadge(isOnline: Boolean) {
-        val badge: TextView? = findViewById(R.id.scadaStatusBadge)
-        if (badge != null) {
-            if (isOnline) {
-                badge.text = "Online"
-                badge.setBackgroundResource(R.drawable.status_badge_background)
-                badge.setTextColor(ContextCompat.getColor(this, android.R.color.white))
-            } else {
-                badge.text = "Offline"
-                // Use a red background variant if available; fallback by tinting via background swap
-                badge.setBackgroundResource(R.drawable.status_badge_background)
-                badge.background.setTint(ContextCompat.getColor(this, android.R.color.holo_red_light))
-                badge.setTextColor(ContextCompat.getColor(this, android.R.color.white))
-            }
-        }
-    }
+    // Removed: FCM status badge update logic
+    // Previously:
+    //    val badge: TextView? = findViewById(R.id.scadaStatusBadge)
+    //    if (badge != null) {
+    //        if (fcmIsOnline) {
+    //            badge.text = "Online"
+    //            badge.setBackgroundResource(R.drawable.status_badge_background)
+    //            badge.setTextColor(ContextCompat.getColor(this, android.R.color.white))
+    //        } else {
+    //            badge.text = "Offline"
+    //            badge.setBackgroundResource(R.drawable.status_badge_background)
+    //            badge.background.setTint(ContextCompat.getColor(this, android.R.color.holo_red_light))
+    //            badge.setTextColor(ContextCompat.getColor(this, android.R.color.white))
+    //        }
+    //    }
 
     private fun updatePresenceUI(triggeredByUser: Boolean) {
         // Run in background to avoid blocking UI
Index: app/src/main/res/layout/activity_scada.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<androidx.swiperefreshlayout.widget.SwipeRefreshLayout\r\n    xmlns:android=\"http://schemas.android.com/apk/res/android\"\r\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\r\n    android:id=\"@+id/swipeRefreshLayout\"\r\n    android:layout_width=\"match_parent\"\r\n    android:layout_height=\"match_parent\">\r\n\r\n    <ScrollView\r\n        android:layout_width=\"match_parent\"\r\n        android:layout_height=\"match_parent\">\r\n\r\n        <LinearLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:orientation=\"vertical\"\r\n            android:padding=\"16dp\">\r\n\r\n            <!-- Header -->\r\n            <LinearLayout\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\"\r\n                android:gravity=\"center_vertical\"\r\n                android:layout_marginBottom=\"24dp\">\r\n\r\n                <TextView\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:text=\"� System Monitoring\"\r\n                    android:textSize=\"24sp\"\r\n                    android:textColor=\"?android:attr/textColorPrimary\"\r\n                    android:textStyle=\"bold\" />\r\n\r\n                <TextView\r\n                    android:id=\"@+id/scadaBackButton\"\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:text=\"← Back\"\r\n                    android:textSize=\"16sp\"\r\n                    android:textColor=\"?android:attr/textColorPrimary\"\r\n                    android:padding=\"8dp\" />\r\n\r\n            </LinearLayout>\r\n\r\n\r\n            <!-- Geyser System Status -->\r\n            <TextView\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:text=\"\uD83D\uDD25 Water Heating System\"\r\n                android:textSize=\"18sp\"\r\n                android:textColor=\"?android:attr/textColorPrimary\"\r\n                android:textStyle=\"bold\"\r\n                android:layout_marginBottom=\"12dp\" />\r\n\r\n            <!-- Water Temperature Gauge -->\r\n            <androidx.cardview.widget.CardView\r\n                android:id=\"@+id/geyserSection\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:layout_marginBottom=\"16dp\"\r\n                app:cardBackgroundColor=\"#1A237E\"\r\n                app:cardCornerRadius=\"12dp\"\r\n                app:cardElevation=\"4dp\"\r\n                android:clickable=\"true\"\r\n                android:focusable=\"true\"\r\n                android:foreground=\"?android:attr/selectableItemBackground\">\r\n\r\n                <LinearLayout\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:orientation=\"horizontal\"\r\n                    android:padding=\"16dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"0dp\"\r\n                        android:layout_weight=\"1\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:orientation=\"vertical\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83C\uDF21\uFE0F Geyser Temperature\"\r\n                            android:textSize=\"16sp\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textStyle=\"bold\"\r\n                            android:layout_marginBottom=\"4dp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/waterTempValue\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"--°C\"\r\n                            android:textSize=\"32sp\"\r\n                            android:textColor=\"#9FA8DA\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/waterTempStatus\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Normal Range\"\r\n                            android:textSize=\"14sp\"\r\n                            android:textColor=\"#4CAF50\" />\r\n\r\n                    </LinearLayout>\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Min: 0°C\"\r\n                            android:textSize=\"12sp\"\r\n                            android:textColor=\"#9FA8DA\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Max: 80°C\"\r\n                            android:textSize=\"12sp\"\r\n                            android:textColor=\"#9FA8DA\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/waterTempTrend\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"→\"\r\n                            android:textSize=\"20sp\"\r\n                            android:textColor=\"#9FA8DA\"\r\n                            android:layout_marginTop=\"4dp\" />\r\n\r\n                    </LinearLayout>\r\n\r\n                </LinearLayout>\r\n\r\n            </androidx.cardview.widget.CardView>\r\n\r\n            <!-- Water Pressure Gauge -->\r\n            <androidx.cardview.widget.CardView\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:layout_marginBottom=\"24dp\"\r\n                app:cardBackgroundColor=\"#1A237E\"\r\n                app:cardCornerRadius=\"12dp\"\r\n                app:cardElevation=\"4dp\">\r\n\r\n                <LinearLayout\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:orientation=\"horizontal\"\r\n                    android:padding=\"16dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"0dp\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:layout_weight=\"1\"\r\n                        android:orientation=\"vertical\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:layout_marginBottom=\"4dp\"\r\n                            android:text=\"\uD83D\uDCA7 Geyser Pressure\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textSize=\"16sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/waterPressureValue\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"-- Bar\"\r\n                            android:textColor=\"#9FA8DA\"\r\n                            android:textSize=\"32sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/waterPressureStatus\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Normal Range\"\r\n                            android:textColor=\"#4CAF50\"\r\n                            android:textSize=\"14sp\" />\r\n\r\n                    </LinearLayout>\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Min: 2 Bar\"\r\n                            android:textSize=\"12sp\"\r\n                            android:textColor=\"#9FA8DA\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Max: 6 Bar\"\r\n                            android:textSize=\"12sp\"\r\n                            android:textColor=\"#9FA8DA\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/waterPressureTrend\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"→\"\r\n                            android:textSize=\"20sp\"\r\n                            android:textColor=\"#9FA8DA\"\r\n                            android:layout_marginTop=\"4dp\" />\r\n\r\n                    </LinearLayout>\r\n\r\n                </LinearLayout>\r\n            </androidx.cardview.widget.CardView>\r\n\r\n            <!-- Additional Sensors Section -->\r\n            <TextView\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:text=\"� Equipment Status\"\r\n                android:textSize=\"18sp\"\r\n                android:textColor=\"?android:attr/textColorPrimary\"\r\n                android:textStyle=\"bold\"\r\n                android:layout_marginBottom=\"12dp\" />\r\n\r\n            <!-- System Health Grid -->\r\n            <LinearLayout\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\"\r\n                android:layout_marginBottom=\"16dp\"\r\n                android:paddingTop=\"4dp\"\r\n                android:paddingBottom=\"4dp\">\r\n\r\n                <!-- DVR Heartbeat card (left) - matches Alarm Status card (right) -->\r\n                <androidx.cardview.widget.CardView\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"80dp\"\r\n                    android:layout_marginEnd=\"6dp\"\r\n                    app:cardBackgroundColor=\"#37474F\"\r\n                    app:cardCornerRadius=\"8dp\"\r\n                    app:cardElevation=\"2dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:padding=\"10dp\"\r\n                        android:gravity=\"center_vertical\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"DVR Heartbeat\"\r\n                            android:textColor=\"#FFFFFF\"\r\n                            android:textSize=\"12sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <LinearLayout\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:orientation=\"horizontal\"\r\n                            android:gravity=\"center_vertical\"\r\n                            android:layout_marginTop=\"6dp\">\r\n\r\n                            <ImageView\r\n                                android:id=\"@+id/dvrStatusDot\"\r\n                                android:layout_width=\"14dp\"\r\n                                android:layout_height=\"14dp\"\r\n                                android:layout_marginEnd=\"8dp\"\r\n                                android:src=\"@drawable/ic_status_dot\"\r\n                                app:tint=\"#4CAF50\"\r\n                                android:contentDescription=\"DVR status\" />\r\n\r\n                            <TextView\r\n                                android:id=\"@+id/dvrHeartbeatStatus\"\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"Online\"\r\n                                android:textColor=\"#4CAF50\"\r\n                                android:textSize=\"14sp\"\r\n                                android:textStyle=\"bold\" />\r\n\r\n                        </LinearLayout>\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n                <!-- Alarm Status card (right) - Modern Material Design -->\r\n                <androidx.cardview.widget.CardView\r\n                    android:id=\"@+id/alarmStatusCard\"\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"80dp\"\r\n                    android:layout_marginStart=\"6dp\"\r\n                    app:cardBackgroundColor=\"#2C3E50\"\r\n                    app:cardCornerRadius=\"12dp\"\r\n                    app:cardElevation=\"4dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:padding=\"10dp\"\r\n                        android:gravity=\"center_vertical\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"⚙\uFE0F Setup\"\r\n                            android:textColor=\"#ECEFF1\"\r\n                            android:textSize=\"13sp\"\r\n                            android:textStyle=\"bold\"\r\n                            android:letterSpacing=\"0.05\" />\r\n\r\n                        <!-- Row with dot + label to match DVR alignment -->\r\n                        <LinearLayout\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:orientation=\"horizontal\"\r\n                            android:gravity=\"center_vertical\"\r\n                            android:layout_marginTop=\"6dp\">\r\n\r\n                            <ImageView\r\n                                android:id=\"@+id/alarmStatusDot\"\r\n                                android:layout_width=\"14dp\"\r\n                                android:layout_height=\"14dp\"\r\n                                android:layout_marginEnd=\"8dp\"\r\n                                android:src=\"@drawable/ic_status_dot\"\r\n                                app:tint=\"#4CAF50\"\r\n                                android:contentDescription=\"Alarm status\" />\r\n\r\n                            <TextView\r\n                                android:id=\"@+id/alarmActiveStatus\"\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"Active\"\r\n                                android:textColor=\"#4CAF50\"\r\n                                android:textSize=\"14sp\"\r\n                                android:textStyle=\"bold\" />\r\n\r\n                        </LinearLayout>\r\n\r\n                        <!-- Presence indicator row: shows whether the device is on the home network -->\r\n                        <LinearLayout\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:orientation=\"horizontal\"\r\n                            android:gravity=\"center_vertical\"\r\n                            android:layout_marginTop=\"8dp\">\r\n\r\n                            <ImageView\r\n                                android:id=\"@+id/setupPresenceDot\"\r\n                                android:layout_width=\"10dp\"\r\n                                android:layout_height=\"10dp\"\r\n                                android:layout_marginEnd=\"8dp\"\r\n                                android:src=\"@drawable/ic_status_dot\"\r\n                                app:tint=\"#4CAF50\"\r\n                                android:contentDescription=\"Presence dot\" />\r\n\r\n                            <TextView\r\n                                android:id=\"@+id/setupPresenceText\"\r\n                                android:layout_width=\"0dp\"\r\n                                android:layout_weight=\"1\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"At home\"\r\n                                android:textColor=\"#ECEFF1\"\r\n                                android:textSize=\"12sp\" />\r\n\r\n                            <Button\r\n                                android:id=\"@+id/checkNetworkButton\"\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"Check network\"\r\n                                android:textSize=\"11sp\"\r\n                                android:backgroundTint=\"#607D8B\"\r\n                                android:textColor=\"#FFFFFF\" />\r\n\r\n                        </LinearLayout>\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n            </LinearLayout>\r\n\r\n            <!-- DVR Temperature Monitoring -->\r\n            <LinearLayout\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\"\r\n                android:layout_marginBottom=\"16dp\">\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:id=\"@+id/dvrSection\"\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"80dp\"\r\n                    app:cardBackgroundColor=\"#37474F\"\r\n                    app:cardCornerRadius=\"8dp\"\r\n                    android:clickable=\"true\"\r\n                    android:focusable=\"true\"\r\n                    android:foreground=\"?android:attr/selectableItemBackground\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"8dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83C\uDF21\uFE0F DVR Enclosure Temperature\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textSize=\"10sp\"\r\n                            android:textStyle=\"bold\"\r\n                            android:maxLines=\"1\"\r\n                            android:ellipsize=\"end\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/dvrTemp\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"--°C\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textSize=\"14sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/dvrTempStatus\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Normal\"\r\n                            android:textColor=\"#4CAF50\"\r\n                            android:textSize=\"9sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n            </LinearLayout>\r\n\r\n            <!-- Weather Monitoring Section -->\r\n            <TextView\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:text=\"\uD83C\uDF24\uFE0F Weather Station\"\r\n                android:textSize=\"18sp\"\r\n                android:textColor=\"?android:attr/textColorPrimary\"\r\n                android:textStyle=\"bold\"\r\n                android:layout_marginBottom=\"12dp\" />\r\n\r\n            <!-- Weather Grid -->\r\n            <LinearLayout\r\n                android:id=\"@+id/weatherSection\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\"\r\n                android:layout_marginBottom=\"16dp\"\r\n                android:clickable=\"true\"\r\n                android:focusable=\"true\"\r\n                android:background=\"?android:attr/selectableItemBackground\">\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"100dp\"\r\n                    android:layout_marginEnd=\"4dp\"\r\n                    app:cardBackgroundColor=\"#0D47A1\"\r\n                    app:cardCornerRadius=\"8dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"8dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83C\uDF21\uFE0F\"\r\n                            android:textSize=\"20sp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/indoorTemp\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"--°C\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textSize=\"12sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Indoor\"\r\n                            android:textColor=\"#BBDEFB\"\r\n                            android:textSize=\"12sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"100dp\"\r\n                    android:layout_marginStart=\"2dp\"\r\n                    android:layout_marginEnd=\"2dp\"\r\n                    app:cardBackgroundColor=\"#1565C0\"\r\n                    app:cardCornerRadius=\"8dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"8dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83C\uDF24\uFE0F\"\r\n                            android:textSize=\"20sp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/outdoorTemp\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"--°C\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textSize=\"11sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/outdoorHumidity\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"--%\"\r\n                            android:textColor=\"#81C784\"\r\n                            android:textSize=\"10sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Outdoor\"\r\n                            android:textColor=\"#BBDEFB\"\r\n                            android:textSize=\"8sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"100dp\"\r\n                    android:layout_marginStart=\"4dp\"\r\n                    app:cardBackgroundColor=\"#1976D2\"\r\n                    app:cardCornerRadius=\"8dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"8dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83D\uDCA8\"\r\n                            android:textSize=\"20sp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/windSpeed\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"-- km/h\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textSize=\"9sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <ImageView\r\n                            android:id=\"@+id/windDirectionArrow\"\r\n                            android:layout_width=\"24dp\"\r\n                            android:layout_height=\"24dp\"\r\n                            android:layout_marginTop=\"2dp\"\r\n                            android:src=\"@drawable/ic_wind_arrow\"\r\n                            app:tint=\"#FFFFFF\"\r\n                            android:contentDescription=\"Wind direction\"\r\n                            android:visibility=\"visible\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Wind\"\r\n                            android:textColor=\"#BBDEFB\"\r\n                            android:textSize=\"9sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n            </LinearLayout>\r\n\r\n            <!-- Extra weather row: Sun position and Tide information -->\r\n            <LinearLayout\r\n                android:id=\"@+id/weatherExtraRow\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\"\r\n                android:layout_marginBottom=\"16dp\">\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"80dp\"\r\n                    android:layout_marginEnd=\"4dp\"\r\n                    app:cardBackgroundColor=\"#0288D1\"\r\n                    app:cardCornerRadius=\"8dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"8dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"☀\uFE0F\"\r\n                            android:textSize=\"18sp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/sunInfo\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"--:-- / --:--\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textSize=\"12sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Sunrise / Sunset\"\r\n                            android:textColor=\"#BBDEFB\"\r\n                            android:textSize=\"9sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"80dp\"\r\n                    android:layout_marginStart=\"4dp\"\r\n                    app:cardBackgroundColor=\"#00796B\"\r\n                    app:cardCornerRadius=\"8dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"8dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83C\uDF0A\"\r\n                            android:textSize=\"12sp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/tideInfo\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Tide: N/A\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textSize=\"10sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Next high/low\"\r\n                            android:textColor=\"#BBDEFB\"\r\n                            android:textSize=\"9sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n            </LinearLayout>\r\n\r\n            <!-- Power Monitoring Section -->\r\n            <TextView\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:text=\"⚡ Electrical System\"\r\n                android:textSize=\"18sp\"\r\n                android:textColor=\"?android:attr/textColorPrimary\"\r\n                android:textStyle=\"bold\"\r\n                android:layout_marginBottom=\"12dp\" />\r\n\r\n            <androidx.cardview.widget.CardView\r\n                android:id=\"@+id/powerSection\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:layout_marginBottom=\"16dp\"\r\n                app:cardBackgroundColor=\"#E65100\"\r\n                android:clickable=\"true\"\r\n                android:focusable=\"true\"\r\n                android:foreground=\"?android:attr/selectableItemBackground\"\r\n                app:cardCornerRadius=\"12dp\"\r\n                app:cardElevation=\"4dp\">\r\n\r\n                <LinearLayout\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:orientation=\"horizontal\"\r\n                    android:padding=\"16dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"0dp\"\r\n                        android:layout_weight=\"1\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:orientation=\"vertical\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"⚡ Current Draw (Amps)\"\r\n                            android:textSize=\"16sp\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textStyle=\"bold\"\r\n                            android:layout_marginBottom=\"4dp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/currentAmps\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"-- A\"\r\n                            android:textSize=\"28sp\"\r\n                            android:textColor=\"#FFCC80\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/powerStatus\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Normal Usage\"\r\n                            android:textSize=\"14sp\"\r\n                            android:textColor=\"#4CAF50\" />\r\n\r\n                    </LinearLayout>\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Power (kW)\"\r\n                            android:textSize=\"12sp\"\r\n                            android:textColor=\"#FFCC80\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/currentPower\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"-- kW\"\r\n                            android:textSize=\"16sp\"\r\n                            android:textColor=\"#FFCC80\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/dailyPower\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"-- kWh\"\r\n                            android:textSize=\"14sp\"\r\n                            android:textColor=\"#FFCC80\"\r\n                            android:layout_marginTop=\"4dp\" />\r\n\r\n                    </LinearLayout>\r\n\r\n\r\n                </LinearLayout>\r\n\r\n            </androidx.cardview.widget.CardView>\r\n\r\n            <!-- PLC Controls Section -->\r\n            <!--\r\n            <TextView\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:text=\"\uD83C\uDFE0 House Controls\"\r\n                android:textSize=\"18sp\"\r\n                android:textColor=\"?android:attr/textColorPrimary\"\r\n                android:textStyle=\"bold\"\r\n                android:layout_marginBottom=\"12dp\" />\r\n\r\n            <androidx.cardview.widget.CardView\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:layout_marginBottom=\"16dp\"\r\n                app:cardBackgroundColor=\"#2C2C2C\"\r\n                app:cardCornerRadius=\"12dp\"\r\n                app:cardElevation=\"4dp\">\r\n\r\n                <LinearLayout\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:orientation=\"vertical\"\r\n                    android:padding=\"16dp\">\r\n\r\n                    <TextView\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:text=\"\uD83D\uDCF1 Main Controller\"\r\n                        android:textSize=\"16sp\"\r\n                        android:textColor=\"?android:attr/textColorPrimary\"\r\n                        android:textStyle=\"bold\"\r\n                        android:layout_marginBottom=\"8dp\" />\r\n\r\n                    <TextView\r\n                        android:id=\"@+id/plcStatus\"\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:text=\"\uD83D\uDFE2 Controller Online - Ready for Integration\"\r\n                        android:textSize=\"14sp\"\r\n                        android:textColor=\"?android:attr/textColorSecondary\"\r\n                        android:layout_marginBottom=\"12dp\" />\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:orientation=\"horizontal\"\r\n                        android:gravity=\"center\">\r\n\r\n                        <androidx.cardview.widget.CardView\r\n                            android:layout_width=\"0dp\"\r\n                            android:layout_weight=\"1\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:layout_marginEnd=\"4dp\"\r\n                            app:cardBackgroundColor=\"#37474F\"\r\n                            app:cardCornerRadius=\"8dp\">\r\n\r\n                            <TextView\r\n                                android:layout_width=\"match_parent\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"Connect Controller\"\r\n                                android:textColor=\"?android:attr/textColorPrimary\"\r\n                                android:textSize=\"14sp\"\r\n                                android:gravity=\"center\"\r\n                                android:padding=\"12dp\" />\r\n\r\n                        </androidx.cardview.widget.CardView>\r\n\r\n                        <androidx.cardview.widget.CardView\r\n                            android:layout_width=\"0dp\"\r\n                            android:layout_weight=\"1\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:layout_marginStart=\"4dp\"\r\n                            app:cardBackgroundColor=\"#37474F\"\r\n                            app:cardCornerRadius=\"8dp\">\r\n\r\n                            <TextView\r\n                                android:layout_width=\"match_parent\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"View Data\"\r\n                                android:textColor=\"?android:attr/textColorPrimary\"\r\n                                android:textSize=\"14sp\"\r\n                                android:gravity=\"center\"\r\n                                android:padding=\"12dp\" />\r\n\r\n                        </androidx.cardview.widget.CardView>\r\n\r\n                    </LinearLayout>\r\n\r\n                </LinearLayout>\r\n            </androidx.cardview.widget.CardView>\r\n            -->\r\n\r\n            <!-- Outside Lights Control -->\r\n            <LinearLayout\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\"\r\n                android:layout_marginTop=\"16dp\"\r\n                android:layout_marginBottom=\"12dp\"\r\n                android:gravity=\"center_vertical\">\r\n\r\n                <ImageView\r\n                    android:id=\"@+id/lightsTitleIcon\"\r\n                    android:layout_width=\"20dp\"\r\n                    android:layout_height=\"20dp\"\r\n                    android:layout_marginEnd=\"8dp\"\r\n                    android:src=\"@drawable/ic_lightbulb\"\r\n                    app:tint=\"?android:attr/textColorPrimary\"\r\n                    android:contentDescription=\"Lights\" />\r\n\r\n                <TextView\r\n                    android:id=\"@+id/lightsTitleText\"\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:text=\"Outside Lights\"\r\n                    android:textSize=\"18sp\"\r\n                    android:textColor=\"?android:attr/textColorPrimary\"\r\n                    android:textStyle=\"bold\" />\r\n\r\n            </LinearLayout>\r\n\r\n            <androidx.cardview.widget.CardView\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                app:cardBackgroundColor=\"#2C2C2C\"\r\n                app:cardCornerRadius=\"8dp\"\r\n                android:layout_marginBottom=\"16dp\">\r\n\r\n                <LinearLayout\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:orientation=\"vertical\"\r\n                    android:padding=\"16dp\">\r\n\r\n                    <!-- Lights Status Display -->\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:orientation=\"horizontal\"\r\n                        android:gravity=\"center_vertical\"\r\n                        android:layout_marginBottom=\"16dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"0dp\"\r\n                            android:layout_weight=\"1\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83D\uDD0C Status:\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textSize=\"16sp\" />\r\n\r\n                        <!-- Replaced emoji TextView with an icon + text for consistent rendering -->\r\n                        <LinearLayout\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:orientation=\"horizontal\"\r\n                            android:gravity=\"center_vertical\">\r\n\r\n                            <ImageView\r\n                                android:id=\"@+id/lightsStatusIcon\"\r\n                                android:layout_width=\"20dp\"\r\n                                android:layout_height=\"20dp\"\r\n                                android:src=\"@drawable/ic_lightbulb\"\r\n                                app:tint=\"#FF5722\"\r\n                                android:contentDescription=\"Lights status icon\"\r\n                                android:layout_marginEnd=\"6dp\" />\r\n\r\n                            <TextView\r\n                                android:id=\"@+id/lightsStatusText\"\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:text=\"OFF\"\r\n                                android:textColor=\"#FF5722\"\r\n                                android:textSize=\"16sp\"\r\n                                android:textStyle=\"bold\" />\r\n\r\n                        </LinearLayout>\r\n\r\n                    </LinearLayout>\r\n\r\n                    <!-- Control Buttons -->\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:orientation=\"horizontal\"\r\n                        android:gravity=\"center\">\r\n\r\n                        <Button\r\n                            android:id=\"@+id/lightsOnButton\"\r\n                            android:layout_width=\"0dp\"\r\n                            android:layout_weight=\"1\"\r\n                            android:layout_height=\"56dp\"\r\n                            android:layout_marginEnd=\"8dp\"\r\n                            android:text=\"LIGHTS ON\"\r\n                            android:drawableStart=\"@drawable/ic_lightbulb\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:backgroundTint=\"#4CAF50\"\r\n                            android:textSize=\"12sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <Button\r\n                            android:id=\"@+id/lightsOffButton\"\r\n                            android:layout_width=\"0dp\"\r\n                            android:layout_weight=\"1\"\r\n                            android:layout_height=\"56dp\"\r\n                            android:layout_marginStart=\"8dp\"\r\n                            android:text=\"LIGHTS OFF\"\r\n                            android:drawableStart=\"@drawable/ic_lightbulb\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:backgroundTint=\"#FF5722\"\r\n                            android:textSize=\"12sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                    </LinearLayout>\r\n\r\n\r\n                    <!-- Technical Details -->\r\n                    <TextView\r\n                        android:id=\"@+id/lightsDetails\"\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:layout_marginTop=\"12dp\"\r\n                        android:text=\"Sent TXT: -- | Y21_read: 0 | Last Command: --\"\r\n                        android:textColor=\"@color/light_grey\"\r\n                        android:textSize=\"12sp\"\r\n                        android:gravity=\"center\" />\r\n\r\n                </LinearLayout>\r\n\r\n            </androidx.cardview.widget.CardView>\r\n\r\n\r\n\r\n\r\n\r\n            <!-- System Diagnostics -->\r\n            <TextView\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:text=\"\uD83D\uDC68\u200D⚕\uFE0F System Health\"\r\n                android:textSize=\"18sp\"\r\n                android:textColor=\"#FFFFFF\"\r\n                android:textStyle=\"bold\"\r\n                android:layout_marginBottom=\"12dp\" />\r\n\r\n            <androidx.cardview.widget.CardView\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                app:cardBackgroundColor=\"#2C2C2C\"\r\n                app:cardCornerRadius=\"8dp\">\r\n\r\n                <TextView\r\n                    android:id=\"@+id/diagnosticsText\"\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:text=\"Last Update: --:--\\nWater Temperature: Online\\nWater Pressure: Online\\nMain Controller: Ready\"\r\n                    android:textSize=\"14sp\"\r\n                    android:textColor=\"#B0BEC5\"\r\n                    android:padding=\"16dp\" />\r\n\r\n            </androidx.cardview.widget.CardView>\r\n\r\n            <!-- Analytics Section -->\r\n            <LinearLayout\r\n                android:id=\"@+id/analyticsSection\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\"\r\n                android:gravity=\"center\"\r\n                android:layout_marginBottom=\"16dp\"\r\n                android:padding=\"12dp\">\r\n\r\n                <LinearLayout\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:orientation=\"vertical\"\r\n                    android:gravity=\"center\">\r\n                    <TextView\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:text=\"Total Data Points\"\r\n                        android:textColor=\"?android:attr/textColorSecondary\"\r\n                        android:textSize=\"12sp\"/>\r\n                    <TextView\r\n                        android:id=\"@+id/totalPointsValue\"\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:text=\"--\"\r\n                        android:textColor=\"?android:attr/textColorPrimary\"\r\n                        android:textSize=\"18sp\"\r\n                        android:textStyle=\"bold\"/>\r\n                </LinearLayout>\r\n\r\n                <LinearLayout\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:orientation=\"vertical\"\r\n                    android:gravity=\"center\">\r\n                    <TextView\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:text=\"Data Rate\"\r\n                        android:textColor=\"?android:attr/textColorSecondary\"\r\n                        android:textSize=\"12sp\"/>\r\n                    <TextView\r\n                        android:id=\"@+id/dataRateValue\"\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:text=\"--\"\r\n                        android:textColor=\"?android:attr/textColorPrimary\"\r\n                        android:textSize=\"18sp\"\r\n                        android:textStyle=\"bold\"/>\r\n                </LinearLayout>\r\n\r\n                <LinearLayout\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:orientation=\"vertical\"\r\n                    android:gravity=\"center\">\r\n                    <TextView\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:text=\"Active Sensors\"\r\n                        android:textColor=\"?android:attr/textColorSecondary\"\r\n                        android:textSize=\"12sp\"/>\r\n                    <TextView\r\n                        android:id=\"@+id/activeSensorsValue\"\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:text=\"--\"\r\n                        android:textColor=\"?android:attr/textColorPrimary\"\r\n                        android:textSize=\"18sp\"\r\n                        android:textStyle=\"bold\"/>\r\n                </LinearLayout>\r\n            </LinearLayout>\r\n            <!-- End Analytics Section -->\r\n\r\n            <!-- Google Sign-In Button -->\r\n            <com.google.android.gms.common.SignInButton\r\n                android:id=\"@+id/googleSignInButton\"\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:layout_gravity=\"center_horizontal\"\r\n                android:layout_marginTop=\"16dp\"\r\n                android:layout_marginBottom=\"16dp\" />\r\n\r\n            <!-- Add a small status badge at the bottom of the SCADA card/container -->\r\n            <!-- Assuming the SCADA card root uses ConstraintLayout; if not, this TextView will still be added near the end -->\r\n            <TextView\r\n                android:id=\"@+id/scadaStatusBadge\"\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:text=\"Online\"\r\n                android:textSize=\"12sp\"\r\n                android:textStyle=\"bold\"\r\n                android:paddingLeft=\"10dp\"\r\n                android:paddingRight=\"10dp\"\r\n                android:paddingTop=\"6dp\"\r\n                android:paddingBottom=\"6dp\"\r\n                android:textColor=\"@android:color/white\"\r\n                android:background=\"@drawable/status_badge_background\"\r\n                android:layout_marginTop=\"8dp\"\r\n                android:layout_marginBottom=\"8dp\"\r\n                android:layout_marginEnd=\"8dp\"\r\n                android:layout_marginStart=\"8dp\"\r\n                android:gravity=\"center\"\r\n                android:contentDescription=\"SCADA status badge\"\r\n                app:layout_constraintBottom_toBottomOf=\"parent\"\r\n                app:layout_constraintEnd_toEndOf=\"parent\" />\r\n\r\n            <!-- Inside the SCADA card container, add a small status badge at the bottom -->\r\n            <androidx.constraintlayout.widget.ConstraintLayout\r\n                android:id=\"@+id/scadaCardContainer\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\">\r\n\r\n                <!-- FCM/Connectivity status badge (red variant applied via background) -->\r\n                <TextView\r\n                    android:id=\"@+id/scadaStatusBadgeFcm\"\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:text=\"FCM\"\r\n                    android:textSize=\"12sp\"\r\n                    android:textColor=\"#FFFFFF\"\r\n                    android:paddingLeft=\"8dp\"\r\n                    android:paddingTop=\"4dp\"\r\n                    android:paddingRight=\"8dp\"\r\n                    android:paddingBottom=\"4dp\"\r\n                    android:background=\"@drawable/status_badge_background_red\"\r\n                    android:visibility=\"gone\"\r\n                    app:layout_constraintBottom_toBottomOf=\"parent\"\r\n                    app:layout_constraintEnd_toEndOf=\"parent\"\r\n                    android:layout_margin=\"8dp\" />\r\n\r\n            </androidx.constraintlayout.widget.ConstraintLayout>\r\n\r\n        </LinearLayout>\r\n\r\n    </ScrollView>\r\n</androidx.swiperefreshlayout.widget.SwipeRefreshLayout>\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/res/layout/activity_scada.xml b/app/src/main/res/layout/activity_scada.xml
--- a/app/src/main/res/layout/activity_scada.xml	(revision 44d69ffda4d1488978c0d0db75712de451938b41)
+++ b/app/src/main/res/layout/activity_scada.xml	(date 1766859841933)
@@ -44,415 +44,145 @@
 
             </LinearLayout>
 
-
-            <!-- Geyser System Status -->
-            <TextView
-                android:layout_width="wrap_content"
-                android:layout_height="wrap_content"
-                android:text="🔥 Water Heating System"
-                android:textSize="18sp"
-                android:textColor="?android:attr/textColorPrimary"
-                android:textStyle="bold"
-                android:layout_marginBottom="12dp" />
-
-            <!-- Water Temperature Gauge -->
-            <androidx.cardview.widget.CardView
-                android:id="@+id/geyserSection"
-                android:layout_width="match_parent"
-                android:layout_height="wrap_content"
-                android:layout_marginBottom="16dp"
-                app:cardBackgroundColor="#1A237E"
-                app:cardCornerRadius="12dp"
-                app:cardElevation="4dp"
-                android:clickable="true"
-                android:focusable="true"
-                android:foreground="?android:attr/selectableItemBackground">
-
-                <LinearLayout
-                    android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:orientation="horizontal"
-                    android:padding="16dp">
-
-                    <LinearLayout
-                        android:layout_width="0dp"
-                        android:layout_weight="1"
-                        android:layout_height="wrap_content"
-                        android:orientation="vertical">
-
-                        <TextView
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="🌡️ Geyser Temperature"
-                            android:textSize="16sp"
-                            android:textColor="#ffffff"
-                            android:textStyle="bold"
-                            android:layout_marginBottom="4dp" />
-
-                        <TextView
-                            android:id="@+id/waterTempValue"
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="--°C"
-                            android:textSize="32sp"
-                            android:textColor="#9FA8DA"
-                            android:textStyle="bold" />
-
-                        <TextView
-                            android:id="@+id/waterTempStatus"
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="Normal Range"
-                            android:textSize="14sp"
-                            android:textColor="#4CAF50" />
-
-                    </LinearLayout>
-
-                    <LinearLayout
-                        android:layout_width="wrap_content"
-                        android:layout_height="wrap_content"
-                        android:orientation="vertical"
-                        android:gravity="center">
-
-                        <TextView
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="Min: 0°C"
-                            android:textSize="12sp"
-                            android:textColor="#9FA8DA" />
-
-                        <TextView
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="Max: 80°C"
-                            android:textSize="12sp"
-                            android:textColor="#9FA8DA" />
-
-                        <TextView
-                            android:id="@+id/waterTempTrend"
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="→"
-                            android:textSize="20sp"
-                            android:textColor="#9FA8DA"
-                            android:layout_marginTop="4dp" />
-
-                    </LinearLayout>
-
-                </LinearLayout>
-
-            </androidx.cardview.widget.CardView>
-
-            <!-- Water Pressure Gauge -->
-            <androidx.cardview.widget.CardView
-                android:layout_width="match_parent"
+            <!-- Outside Lights Control (moved to top) -->
+            <LinearLayout
+                android:layout_width="wrap_content"
                 android:layout_height="wrap_content"
-                android:layout_marginBottom="24dp"
-                app:cardBackgroundColor="#1A237E"
-                app:cardCornerRadius="12dp"
-                app:cardElevation="4dp">
-
-                <LinearLayout
-                    android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:orientation="horizontal"
-                    android:padding="16dp">
-
-                    <LinearLayout
-                        android:layout_width="0dp"
-                        android:layout_height="wrap_content"
-                        android:layout_weight="1"
-                        android:orientation="vertical">
-
-                        <TextView
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:layout_marginBottom="4dp"
-                            android:text="💧 Geyser Pressure"
-                            android:textColor="#ffffff"
-                            android:textSize="16sp"
-                            android:textStyle="bold" />
-
-                        <TextView
-                            android:id="@+id/waterPressureValue"
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="-- Bar"
-                            android:textColor="#9FA8DA"
-                            android:textSize="32sp"
-                            android:textStyle="bold" />
-
-                        <TextView
-                            android:id="@+id/waterPressureStatus"
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="Normal Range"
-                            android:textColor="#4CAF50"
-                            android:textSize="14sp" />
-
-                    </LinearLayout>
-
-                    <LinearLayout
-                        android:layout_width="wrap_content"
-                        android:layout_height="wrap_content"
-                        android:orientation="vertical"
-                        android:gravity="center">
+                android:orientation="horizontal"
+                android:layout_marginTop="0dp"
+                android:layout_marginBottom="12dp"
+                android:gravity="center_vertical">
 
-                        <TextView
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="Min: 2 Bar"
-                            android:textSize="12sp"
-                            android:textColor="#9FA8DA" />
+                <ImageView
+                    android:id="@+id/lightsTitleIcon"
+                    android:layout_width="20dp"
+                    android:layout_height="20dp"
+                    android:layout_marginEnd="8dp"
+                    android:src="@drawable/ic_lightbulb"
+                    app:tint="?android:attr/textColorPrimary"
+                    android:contentDescription="Lights" />
 
-                        <TextView
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="Max: 6 Bar"
-                            android:textSize="12sp"
-                            android:textColor="#9FA8DA" />
-
-                        <TextView
-                            android:id="@+id/waterPressureTrend"
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="→"
-                            android:textSize="20sp"
-                            android:textColor="#9FA8DA"
-                            android:layout_marginTop="4dp" />
-
-                    </LinearLayout>
-
-                </LinearLayout>
-            </androidx.cardview.widget.CardView>
-
-            <!-- Additional Sensors Section -->
-            <TextView
-                android:layout_width="wrap_content"
-                android:layout_height="wrap_content"
-                android:text="� Equipment Status"
-                android:textSize="18sp"
-                android:textColor="?android:attr/textColorPrimary"
-                android:textStyle="bold"
-                android:layout_marginBottom="12dp" />
+                <TextView
+                    android:id="@+id/lightsTitleText"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:text="Outside Lights"
+                    android:textSize="18sp"
+                    android:textColor="?android:attr/textColorPrimary"
+                    android:textStyle="bold" />
 
-            <!-- System Health Grid -->
-            <LinearLayout
+            </LinearLayout>
+
+            <androidx.cardview.widget.CardView
                 android:layout_width="match_parent"
                 android:layout_height="wrap_content"
-                android:orientation="horizontal"
-                android:layout_marginBottom="16dp"
-                android:paddingTop="4dp"
-                android:paddingBottom="4dp">
-
-                <!-- DVR Heartbeat card (left) - matches Alarm Status card (right) -->
-                <androidx.cardview.widget.CardView
-                    android:layout_width="0dp"
-                    android:layout_weight="1"
-                    android:layout_height="80dp"
-                    android:layout_marginEnd="6dp"
-                    app:cardBackgroundColor="#37474F"
-                    app:cardCornerRadius="8dp"
-                    app:cardElevation="2dp">
+                app:cardBackgroundColor="#2C2C2C"
+                app:cardCornerRadius="8dp"
+                android:layout_marginBottom="16dp">
 
-                    <LinearLayout
-                        android:layout_width="match_parent"
-                        android:layout_height="match_parent"
-                        android:orientation="vertical"
-                        android:padding="10dp"
-                        android:gravity="center_vertical">
-
-                        <TextView
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="DVR Heartbeat"
-                            android:textColor="#FFFFFF"
-                            android:textSize="12sp"
-                            android:textStyle="bold" />
+                <LinearLayout
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:orientation="vertical"
+                    android:padding="16dp">
 
-                        <LinearLayout
-                            android:layout_width="match_parent"
-                            android:layout_height="wrap_content"
-                            android:orientation="horizontal"
-                            android:gravity="center_vertical"
-                            android:layout_marginTop="6dp">
-
-                            <ImageView
-                                android:id="@+id/dvrStatusDot"
-                                android:layout_width="14dp"
-                                android:layout_height="14dp"
-                                android:layout_marginEnd="8dp"
-                                android:src="@drawable/ic_status_dot"
-                                app:tint="#4CAF50"
-                                android:contentDescription="DVR status" />
+                    <!-- Lights Status Display -->
+                    <LinearLayout
+                        android:layout_width="match_parent"
+                        android:layout_height="wrap_content"
+                        android:orientation="horizontal"
+                        android:gravity="center_vertical"
+                        android:layout_marginBottom="16dp">
 
-                            <TextView
-                                android:id="@+id/dvrHeartbeatStatus"
-                                android:layout_width="wrap_content"
-                                android:layout_height="wrap_content"
-                                android:text="Online"
-                                android:textColor="#4CAF50"
-                                android:textSize="14sp"
-                                android:textStyle="bold" />
-
-                        </LinearLayout>
-
-                    </LinearLayout>
-                </androidx.cardview.widget.CardView>
-
-                <!-- Alarm Status card (right) - Modern Material Design -->
-                <androidx.cardview.widget.CardView
-                    android:id="@+id/alarmStatusCard"
-                    android:layout_width="0dp"
-                    android:layout_weight="1"
-                    android:layout_height="80dp"
-                    android:layout_marginStart="6dp"
-                    app:cardBackgroundColor="#2C3E50"
-                    app:cardCornerRadius="12dp"
-                    app:cardElevation="4dp">
-
-                    <LinearLayout
-                        android:layout_width="match_parent"
-                        android:layout_height="match_parent"
-                        android:orientation="vertical"
-                        android:padding="10dp"
-                        android:gravity="center_vertical">
-
-                        <TextView
-                            android:layout_width="match_parent"
+                        <TextView
+                            android:layout_width="0dp"
+                            android:layout_weight="1"
                             android:layout_height="wrap_content"
-                            android:text="⚙️ Setup"
-                            android:textColor="#ECEFF1"
-                            android:textSize="13sp"
-                            android:textStyle="bold"
-                            android:letterSpacing="0.05" />
+                            android:text="🔌 Status:"
+                            android:textColor="#ffffff"
+                            android:textSize="16sp" />
 
-                        <!-- Row with dot + label to match DVR alignment -->
+                        <!-- Icon + text for status -->
                         <LinearLayout
-                            android:layout_width="match_parent"
+                            android:layout_width="wrap_content"
                             android:layout_height="wrap_content"
                             android:orientation="horizontal"
-                            android:gravity="center_vertical"
-                            android:layout_marginTop="6dp">
+                            android:gravity="center_vertical">
 
                             <ImageView
-                                android:id="@+id/alarmStatusDot"
-                                android:layout_width="14dp"
-                                android:layout_height="14dp"
-                                android:layout_marginEnd="8dp"
-                                android:src="@drawable/ic_status_dot"
-                                app:tint="#4CAF50"
-                                android:contentDescription="Alarm status" />
+                                android:id="@+id/lightsStatusIcon"
+                                android:layout_width="20dp"
+                                android:layout_height="20dp"
+                                android:src="@drawable/ic_lightbulb"
+                                app:tint="#FF5722"
+                                android:contentDescription="Lights status icon"
+                                android:layout_marginEnd="6dp" />
 
                             <TextView
-                                android:id="@+id/alarmActiveStatus"
+                                android:id="@+id/lightsStatusText"
                                 android:layout_width="wrap_content"
                                 android:layout_height="wrap_content"
-                                android:text="Active"
-                                android:textColor="#4CAF50"
-                                android:textSize="14sp"
+                                android:text="OFF"
+                                android:textColor="#FF5722"
+                                android:textSize="16sp"
                                 android:textStyle="bold" />
 
                         </LinearLayout>
 
-                        <!-- Presence indicator row: shows whether the device is on the home network -->
-                        <LinearLayout
-                            android:layout_width="match_parent"
-                            android:layout_height="wrap_content"
-                            android:orientation="horizontal"
-                            android:gravity="center_vertical"
-                            android:layout_marginTop="8dp">
+                    </LinearLayout>
+
+                    <!-- Control Buttons -->
+                    <LinearLayout
+                        android:layout_width="match_parent"
+                        android:layout_height="wrap_content"
+                        android:orientation="horizontal"
+                        android:gravity="center">
 
-                            <ImageView
-                                android:id="@+id/setupPresenceDot"
-                                android:layout_width="10dp"
-                                android:layout_height="10dp"
-                                android:layout_marginEnd="8dp"
-                                android:src="@drawable/ic_status_dot"
-                                app:tint="#4CAF50"
-                                android:contentDescription="Presence dot" />
-
-                            <TextView
-                                android:id="@+id/setupPresenceText"
-                                android:layout_width="0dp"
-                                android:layout_weight="1"
-                                android:layout_height="wrap_content"
-                                android:text="At home"
-                                android:textColor="#ECEFF1"
-                                android:textSize="12sp" />
-
-                            <Button
-                                android:id="@+id/checkNetworkButton"
-                                android:layout_width="wrap_content"
-                                android:layout_height="wrap_content"
-                                android:text="Check network"
-                                android:textSize="11sp"
-                                android:backgroundTint="#607D8B"
-                                android:textColor="#FFFFFF" />
-
-                        </LinearLayout>
-
-                    </LinearLayout>
-                </androidx.cardview.widget.CardView>
-
-            </LinearLayout>
-
-            <!-- DVR Temperature Monitoring -->
-            <LinearLayout
-                android:layout_width="match_parent"
-                android:layout_height="wrap_content"
-                android:orientation="horizontal"
-                android:layout_marginBottom="16dp">
-
-                <androidx.cardview.widget.CardView
-                    android:id="@+id/dvrSection"
-                    android:layout_width="match_parent"
-                    android:layout_height="80dp"
-                    app:cardBackgroundColor="#37474F"
-                    app:cardCornerRadius="8dp"
-                    android:clickable="true"
-                    android:focusable="true"
-                    android:foreground="?android:attr/selectableItemBackground">
-
-                    <LinearLayout
-                        android:layout_width="match_parent"
-                        android:layout_height="match_parent"
-                        android:orientation="vertical"
-                        android:gravity="center"
-                        android:padding="8dp">
-
-                        <TextView
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="🌡️ DVR Enclosure Temperature"
+                        <Button
+                            android:id="@+id/lightsOnButton"
+                            android:layout_width="0dp"
+                            android:layout_weight="1"
+                            android:layout_height="56dp"
+                            android:layout_marginEnd="8dp"
+                            android:text="LIGHTS ON"
+                            android:drawableStart="@drawable/ic_lightbulb"
                             android:textColor="#ffffff"
-                            android:textSize="10sp"
-                            android:textStyle="bold"
-                            android:maxLines="1"
-                            android:ellipsize="end" />
+                            android:backgroundTint="#4CAF50"
+                            android:textSize="12sp"
+                            android:textStyle="bold" />
 
-                        <TextView
-                            android:id="@+id/dvrTemp"
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="--°C"
+                        <Button
+                            android:id="@+id/lightsOffButton"
+                            android:layout_width="0dp"
+                            android:layout_weight="1"
+                            android:layout_height="56dp"
+                            android:layout_marginStart="8dp"
+                            android:text="LIGHTS OFF"
+                            android:drawableStart="@drawable/ic_lightbulb"
                             android:textColor="#ffffff"
-                            android:textSize="14sp"
+                            android:backgroundTint="#FF5722"
+                            android:textSize="12sp"
                             android:textStyle="bold" />
 
-                        <TextView
-                            android:id="@+id/dvrTempStatus"
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:text="Normal"
-                            android:textColor="#4CAF50"
-                            android:textSize="9sp" />
+                    </LinearLayout>
+
+
+                    <!-- Technical Details -->
+                    <TextView
+                        android:id="@+id/lightsDetails"
+                        android:layout_width="match_parent"
+                        android:layout_height="wrap_content"
+                        android:layout_marginTop="12dp"
+                        android:text="Sent TXT: -- | Y21_read: 0 | Last Command: --"
+                        android:textColor="@color/light_grey"
+                        android:textSize="12sp"
+                        android:gravity="center" />
 
-                    </LinearLayout>
-                </androidx.cardview.widget.CardView>
+                </LinearLayout>
+
+            </androidx.cardview.widget.CardView>
 
-            </LinearLayout>
-
+            <!-- 2) Weather card below the lights controller -->
             <!-- Weather Monitoring Section -->
             <TextView
                 android:layout_width="wrap_content"
@@ -706,7 +436,189 @@
 
             </LinearLayout>
 
-            <!-- Power Monitoring Section -->
+            <!-- 3) Water heating system (geyser temp + pressure) -->
+            <!-- Geyser System Status -->
+            <TextView
+                android:layout_width="wrap_content"
+                android:layout_height="wrap_content"
+                android:text="🔥 Water Heating System"
+                android:textSize="18sp"
+                android:textColor="?android:attr/textColorPrimary"
+                android:textStyle="bold"
+                android:layout_marginBottom="12dp" />
+
+            <!-- Water Temperature Gauge -->
+            <androidx.cardview.widget.CardView
+                android:id="@+id/geyserSection"
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                android:layout_marginBottom="16dp"
+                app:cardBackgroundColor="#1A237E"
+                app:cardCornerRadius="12dp"
+                app:cardElevation="4dp"
+                android:clickable="true"
+                android:focusable="true"
+                android:foreground="?android:attr/selectableItemBackground">
+
+                <LinearLayout
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:orientation="horizontal"
+                    android:padding="16dp">
+
+                    <LinearLayout
+                        android:layout_width="0dp"
+                        android:layout_weight="1"
+                        android:layout_height="wrap_content"
+                        android:orientation="vertical">
+
+                        <TextView
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="🌡️ Geyser Temperature"
+                            android:textSize="16sp"
+                            android:textColor="#ffffff"
+                            android:textStyle="bold"
+                            android:layout_marginBottom="4dp" />
+
+                        <TextView
+                            android:id="@+id/waterTempValue"
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="--°C"
+                            android:textSize="32sp"
+                            android:textColor="#9FA8DA"
+                            android:textStyle="bold" />
+
+                        <TextView
+                            android:id="@+id/waterTempStatus"
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="Normal Range"
+                            android:textSize="14sp"
+                            android:textColor="#4CAF50" />
+
+                    </LinearLayout>
+
+                    <LinearLayout
+                        android:layout_width="wrap_content"
+                        android:layout_height="wrap_content"
+                        android:orientation="vertical"
+                        android:gravity="center">
+
+                        <TextView
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="Min: 0°C"
+                            android:textSize="12sp"
+                            android:textColor="#9FA8DA" />
+
+                        <TextView
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="Max: 80°C"
+                            android:textSize="12sp"
+                            android:textColor="#9FA8DA" />
+
+                        <TextView
+                            android:id="@+id/waterTempTrend"
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="→"
+                            android:textSize="20sp"
+                            android:textColor="#9FA8DA"
+                            android:layout_marginTop="4dp" />
+
+                    </LinearLayout>
+
+                </LinearLayout>
+
+            </androidx.cardview.widget.CardView>
+
+            <!-- Water Pressure Gauge -->
+            <androidx.cardview.widget.CardView
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                android:layout_marginBottom="24dp"
+                app:cardBackgroundColor="#1A237E"
+                app:cardCornerRadius="12dp"
+                app:cardElevation="4dp">
+
+                <LinearLayout
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:orientation="horizontal"
+                    android:padding="16dp">
+
+                    <LinearLayout
+                        android:layout_width="0dp"
+                        android:layout_height="wrap_content"
+                        android:layout_weight="1"
+                        android:orientation="vertical">
+
+                        <TextView
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:layout_marginBottom="4dp"
+                            android:text="💧 Geyser Pressure"
+                            android:textColor="#ffffff"
+                            android:textSize="16sp"
+                            android:textStyle="bold" />
+
+                        <TextView
+                            android:id="@+id/waterPressureValue"
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="-- Bar"
+                            android:textColor="#9FA8DA"
+                            android:textSize="32sp"
+                            android:textStyle="bold" />
+
+                        <TextView
+                            android:id="@+id/waterPressureStatus"
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="Normal Range"
+                            android:textColor="#4CAF50"
+                            android:textSize="14sp" />
+
+                    </LinearLayout>
+
+                    <LinearLayout
+                        android:layout_width="wrap_content"
+                        android:layout_height="wrap_content"
+                        android:orientation="vertical"
+                        android:gravity="center">
+
+                        <TextView
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="Min: 2 Bar"
+                            android:textSize="12sp"
+                            android:textColor="#9FA8DA" />
+
+                        <TextView
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="Max: 6 Bar"
+                            android:textSize="12sp"
+                            android:textColor="#9FA8DA" />
+
+                        <TextView
+                            android:id="@+id/waterPressureTrend"
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="→"
+                            android:textSize="20sp"
+                            android:textColor="#9FA8DA"
+                            android:layout_marginTop="4dp" />
+
+                    </LinearLayout>
+
+                </LinearLayout>
+            </androidx.cardview.widget.CardView>
+
+            <!-- 4) Electrical system -->
             <TextView
                 android:layout_width="wrap_content"
                 android:layout_height="wrap_content"
@@ -806,241 +718,234 @@
 
             </androidx.cardview.widget.CardView>
 
-            <!-- PLC Controls Section -->
-            <!--
+            <!-- 5) Equipment status card(s) -->
             <TextView
                 android:layout_width="wrap_content"
                 android:layout_height="wrap_content"
-                android:text="🏠 House Controls"
+                android:text="� Equipment Status"
                 android:textSize="18sp"
                 android:textColor="?android:attr/textColorPrimary"
                 android:textStyle="bold"
                 android:layout_marginBottom="12dp" />
 
-            <androidx.cardview.widget.CardView
+            <!-- System Health Grid for Equipment: DVR heartbeat + Alarm status -->
+            <LinearLayout
                 android:layout_width="match_parent"
                 android:layout_height="wrap_content"
+                android:orientation="horizontal"
                 android:layout_marginBottom="16dp"
-                app:cardBackgroundColor="#2C2C2C"
-                app:cardCornerRadius="12dp"
-                app:cardElevation="4dp">
+                android:paddingTop="4dp"
+                android:paddingBottom="4dp">
+
+                <!-- DVR Heartbeat card (left) - matches Alarm Status card (right) -->
+                <androidx.cardview.widget.CardView
+                    android:layout_width="0dp"
+                    android:layout_weight="1"
+                    android:layout_height="80dp"
+                    android:layout_marginEnd="6dp"
+                    app:cardBackgroundColor="#37474F"
+                    app:cardCornerRadius="8dp"
+                    app:cardElevation="2dp">
 
-                <LinearLayout
-                    android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:orientation="vertical"
-                    android:padding="16dp">
-
-                    <TextView
-                        android:layout_width="wrap_content"
-                        android:layout_height="wrap_content"
-                        android:text="📱 Main Controller"
-                        android:textSize="16sp"
-                        android:textColor="?android:attr/textColorPrimary"
-                        android:textStyle="bold"
-                        android:layout_marginBottom="8dp" />
+                    <LinearLayout
+                        android:layout_width="match_parent"
+                        android:layout_height="match_parent"
+                        android:orientation="vertical"
+                        android:padding="10dp"
+                        android:gravity="center_vertical">
 
-                    <TextView
-                        android:id="@+id/plcStatus"
-                        android:layout_width="wrap_content"
-                        android:layout_height="wrap_content"
-                        android:text="🟢 Controller Online - Ready for Integration"
-                        android:textSize="14sp"
-                        android:textColor="?android:attr/textColorSecondary"
-                        android:layout_marginBottom="12dp" />
+                        <TextView
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="DVR Heartbeat"
+                            android:textColor="#FFFFFF"
+                            android:textSize="12sp"
+                            android:textStyle="bold" />
 
-                    <LinearLayout
-                        android:layout_width="match_parent"
-                        android:layout_height="wrap_content"
-                        android:orientation="horizontal"
-                        android:gravity="center">
+                        <LinearLayout
+                            android:layout_width="match_parent"
+                            android:layout_height="wrap_content"
+                            android:orientation="horizontal"
+                            android:gravity="center_vertical"
+                            android:layout_marginTop="6dp">
 
-                        <androidx.cardview.widget.CardView
-                            android:layout_width="0dp"
-                            android:layout_weight="1"
-                            android:layout_height="wrap_content"
-                            android:layout_marginEnd="4dp"
-                            app:cardBackgroundColor="#37474F"
-                            app:cardCornerRadius="8dp">
+                            <ImageView
+                                android:id="@+id/dvrStatusDot"
+                                android:layout_width="14dp"
+                                android:layout_height="14dp"
+                                android:layout_marginEnd="8dp"
+                                android:src="@drawable/ic_status_dot"
+                                app:tint="#4CAF50"
+                                android:contentDescription="DVR status" />
 
                             <TextView
-                                android:layout_width="match_parent"
+                                android:id="@+id/dvrHeartbeatStatus"
+                                android:layout_width="wrap_content"
                                 android:layout_height="wrap_content"
-                                android:text="Connect Controller"
-                                android:textColor="?android:attr/textColorPrimary"
+                                android:text="Online"
+                                android:textColor="#4CAF50"
                                 android:textSize="14sp"
-                                android:gravity="center"
-                                android:padding="12dp" />
+                                android:textStyle="bold" />
 
-                        </androidx.cardview.widget.CardView>
+                        </LinearLayout>
+
+                    </LinearLayout>
+                </androidx.cardview.widget.CardView>
 
-                        <androidx.cardview.widget.CardView
-                            android:layout_width="0dp"
-                            android:layout_weight="1"
-                            android:layout_height="wrap_content"
-                            android:layout_marginStart="4dp"
-                            app:cardBackgroundColor="#37474F"
-                            app:cardCornerRadius="8dp">
+                <!-- Alarm Status card (right) - Modern Material Design -->
+                <androidx.cardview.widget.CardView
+                    android:id="@+id/alarmStatusCard"
+                    android:layout_width="0dp"
+                    android:layout_weight="1"
+                    android:layout_height="80dp"
+                    android:layout_marginStart="6dp"
+                    app:cardBackgroundColor="#2C3E50"
+                    app:cardCornerRadius="12dp"
+                    app:cardElevation="4dp">
+
+                    <LinearLayout
+                        android:layout_width="match_parent"
+                        android:layout_height="match_parent"
+                        android:orientation="vertical"
+                        android:padding="10dp"
+                        android:gravity="center_vertical">
 
-                            <TextView
-                                android:layout_width="match_parent"
-                                android:layout_height="wrap_content"
-                                android:text="View Data"
-                                android:textColor="?android:attr/textColorPrimary"
-                                android:textSize="14sp"
-                                android:gravity="center"
-                                android:padding="12dp" />
-
-                        </androidx.cardview.widget.CardView>
+                        <TextView
+                            android:layout_width="match_parent"
+                            android:layout_height="wrap_content"
+                            android:text="⚙️ Setup"
+                            android:textColor="#ECEFF1"
+                            android:textSize="13sp"
+                            android:textStyle="bold"
+                            android:letterSpacing="0.05" />
 
-                    </LinearLayout>
-
-                </LinearLayout>
-            </androidx.cardview.widget.CardView>
-            -->
-
-            <!-- Outside Lights Control -->
-            <LinearLayout
-                android:layout_width="wrap_content"
-                android:layout_height="wrap_content"
-                android:orientation="horizontal"
-                android:layout_marginTop="16dp"
-                android:layout_marginBottom="12dp"
-                android:gravity="center_vertical">
+                        <!-- Row with dot + label to match DVR alignment -->
+                        <LinearLayout
+                            android:layout_width="match_parent"
+                            android:layout_height="wrap_content"
+                            android:orientation="horizontal"
+                            android:gravity="center_vertical"
+                            android:layout_marginTop="6dp">
 
-                <ImageView
-                    android:id="@+id/lightsTitleIcon"
-                    android:layout_width="20dp"
-                    android:layout_height="20dp"
-                    android:layout_marginEnd="8dp"
-                    android:src="@drawable/ic_lightbulb"
-                    app:tint="?android:attr/textColorPrimary"
-                    android:contentDescription="Lights" />
+                            <ImageView
+                                android:id="@+id/alarmStatusDot"
+                                android:layout_width="14dp"
+                                android:layout_height="14dp"
+                                android:layout_marginEnd="8dp"
+                                android:src="@drawable/ic_status_dot"
+                                app:tint="#4CAF50"
+                                android:contentDescription="Alarm status" />
 
-                <TextView
-                    android:id="@+id/lightsTitleText"
-                    android:layout_width="wrap_content"
-                    android:layout_height="wrap_content"
-                    android:text="Outside Lights"
-                    android:textSize="18sp"
-                    android:textColor="?android:attr/textColorPrimary"
-                    android:textStyle="bold" />
+                            <TextView
+                                android:id="@+id/alarmActiveStatus"
+                                android:layout_width="wrap_content"
+                                android:layout_height="wrap_content"
+                                android:text="Active"
+                                android:textColor="#4CAF50"
+                                android:textSize="14sp"
+                                android:textStyle="bold" />
 
-            </LinearLayout>
+                        </LinearLayout>
 
-            <androidx.cardview.widget.CardView
-                android:layout_width="match_parent"
-                android:layout_height="wrap_content"
-                app:cardBackgroundColor="#2C2C2C"
-                app:cardCornerRadius="8dp"
-                android:layout_marginBottom="16dp">
-
-                <LinearLayout
-                    android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:orientation="vertical"
-                    android:padding="16dp">
-
-                    <!-- Lights Status Display -->
-                    <LinearLayout
-                        android:layout_width="match_parent"
-                        android:layout_height="wrap_content"
-                        android:orientation="horizontal"
-                        android:gravity="center_vertical"
-                        android:layout_marginBottom="16dp">
+                        <!-- Presence indicator row: shows whether the device is on the home network -->
+                        <LinearLayout
+                            android:layout_width="match_parent"
+                            android:layout_height="wrap_content"
+                            android:orientation="horizontal"
+                            android:gravity="center_vertical"
+                            android:layout_marginTop="8dp">
+
+                            <ImageView
+                                android:id="@+id/setupPresenceDot"
+                                android:layout_width="10dp"
+                                android:layout_height="10dp"
+                                android:layout_marginEnd="8dp"
+                                android:src="@drawable/ic_status_dot"
+                                app:tint="#4CAF50"
+                                android:contentDescription="Presence dot" />
 
-                        <TextView
-                            android:layout_width="0dp"
-                            android:layout_weight="1"
-                            android:layout_height="wrap_content"
-                            android:text="🔌 Status:"
-                            android:textColor="#ffffff"
-                            android:textSize="16sp" />
-
-                        <!-- Replaced emoji TextView with an icon + text for consistent rendering -->
-                        <LinearLayout
-                            android:layout_width="wrap_content"
-                            android:layout_height="wrap_content"
-                            android:orientation="horizontal"
-                            android:gravity="center_vertical">
+                            <TextView
+                                android:id="@+id/setupPresenceText"
+                                android:layout_width="0dp"
+                                android:layout_weight="1"
+                                android:layout_height="wrap_content"
+                                android:text="At home"
+                                android:textColor="#ECEFF1"
+                                android:textSize="12sp" />
 
-                            <ImageView
-                                android:id="@+id/lightsStatusIcon"
-                                android:layout_width="20dp"
-                                android:layout_height="20dp"
-                                android:src="@drawable/ic_lightbulb"
-                                app:tint="#FF5722"
-                                android:contentDescription="Lights status icon"
-                                android:layout_marginEnd="6dp" />
-
-                            <TextView
-                                android:id="@+id/lightsStatusText"
+                            <Button
+                                android:id="@+id/checkNetworkButton"
                                 android:layout_width="wrap_content"
                                 android:layout_height="wrap_content"
-                                android:text="OFF"
-                                android:textColor="#FF5722"
-                                android:textSize="16sp"
-                                android:textStyle="bold" />
+                                android:text="Check network"
+                                android:textSize="11sp"
+                                android:backgroundTint="#607D8B"
+                                android:textColor="#FFFFFF" />
 
                         </LinearLayout>
 
                     </LinearLayout>
+                </androidx.cardview.widget.CardView>
 
-                    <!-- Control Buttons -->
-                    <LinearLayout
-                        android:layout_width="match_parent"
-                        android:layout_height="wrap_content"
-                        android:orientation="horizontal"
-                        android:gravity="center">
+            </LinearLayout>
+
+            <!-- DVR Temperature Monitoring -->
+            <LinearLayout
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                android:orientation="horizontal"
+                android:layout_marginBottom="16dp">
+
+                <androidx.cardview.widget.CardView
+                    android:id="@+id/dvrSection"
+                    android:layout_width="match_parent"
+                    android:layout_height="80dp"
+                    app:cardBackgroundColor="#37474F"
+                    app:cardCornerRadius="8dp"
+                    android:clickable="true"
+                    android:focusable="true"
+                    android:foreground="?android:attr/selectableItemBackground">
 
-                        <Button
-                            android:id="@+id/lightsOnButton"
-                            android:layout_width="0dp"
-                            android:layout_weight="1"
-                            android:layout_height="56dp"
-                            android:layout_marginEnd="8dp"
-                            android:text="LIGHTS ON"
-                            android:drawableStart="@drawable/ic_lightbulb"
+                    <LinearLayout
+                        android:layout_width="match_parent"
+                        android:layout_height="match_parent"
+                        android:orientation="vertical"
+                        android:gravity="center"
+                        android:padding="8dp">
+
+                        <TextView
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="🌡️ DVR Enclosure Temperature"
                             android:textColor="#ffffff"
-                            android:backgroundTint="#4CAF50"
-                            android:textSize="12sp"
-                            android:textStyle="bold" />
+                            android:textSize="10sp"
+                            android:textStyle="bold"
+                            android:maxLines="1"
+                            android:ellipsize="end" />
 
-                        <Button
-                            android:id="@+id/lightsOffButton"
-                            android:layout_width="0dp"
-                            android:layout_weight="1"
-                            android:layout_height="56dp"
-                            android:layout_marginStart="8dp"
-                            android:text="LIGHTS OFF"
-                            android:drawableStart="@drawable/ic_lightbulb"
+                        <TextView
+                            android:id="@+id/dvrTemp"
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="--°C"
                             android:textColor="#ffffff"
-                            android:backgroundTint="#FF5722"
-                            android:textSize="12sp"
+                            android:textSize="14sp"
                             android:textStyle="bold" />
 
-                    </LinearLayout>
-
-
-                    <!-- Technical Details -->
-                    <TextView
-                        android:id="@+id/lightsDetails"
-                        android:layout_width="match_parent"
-                        android:layout_height="wrap_content"
-                        android:layout_marginTop="12dp"
-                        android:text="Sent TXT: -- | Y21_read: 0 | Last Command: --"
-                        android:textColor="@color/light_grey"
-                        android:textSize="12sp"
-                        android:gravity="center" />
+                        <TextView
+                            android:id="@+id/dvrTempStatus"
+                            android:layout_width="wrap_content"
+                            android:layout_height="wrap_content"
+                            android:text="Normal"
+                            android:textColor="#4CAF50"
+                            android:textSize="9sp" />
 
-                </LinearLayout>
-
-            </androidx.cardview.widget.CardView>
+                    </LinearLayout>
+                </androidx.cardview.widget.CardView>
 
-
+            </LinearLayout>
 
-
-
+            <!-- 6) System Health (moved to bottom) -->
             <!-- System Diagnostics -->
             <TextView
                 android:layout_width="wrap_content"
@@ -1155,8 +1060,7 @@
                 android:layout_marginTop="16dp"
                 android:layout_marginBottom="16dp" />
 
-            <!-- Add a small status badge at the bottom of the SCADA card/container -->
-            <!-- Assuming the SCADA card root uses ConstraintLayout; if not, this TextView will still be added near the end -->
+            <!-- Hide legacy status badges: they’re no longer used; status is shown in System Health text -->
             <TextView
                 android:id="@+id/scadaStatusBadge"
                 android:layout_width="wrap_content"
@@ -1175,9 +1079,8 @@
                 android:layout_marginEnd="8dp"
                 android:layout_marginStart="8dp"
                 android:gravity="center"
-                android:contentDescription="SCADA status badge"
-                app:layout_constraintBottom_toBottomOf="parent"
-                app:layout_constraintEnd_toEndOf="parent" />
+                android:contentDescription="SCADA status"
+                android:visibility="gone" />
 
             <!-- Inside the SCADA card container, add a small status badge at the bottom -->
             <androidx.constraintlayout.widget.ConstraintLayout
Index: app/src/main/res/layout/activity_security.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<androidx.swiperefreshlayout.widget.SwipeRefreshLayout\r\n    xmlns:android=\"http://schemas.android.com/apk/res/android\"\r\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\r\n    android:id=\"@+id/swipeRefreshLayout\"\r\n    android:layout_width=\"match_parent\"\r\n    android:layout_height=\"match_parent\">\r\n\r\n    <ScrollView\r\n        android:layout_width=\"match_parent\"\r\n        android:layout_height=\"match_parent\">\r\n\r\n        <LinearLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:orientation=\"vertical\"\r\n            android:padding=\"16dp\">\r\n\r\n            <!-- Header -->\r\n            <LinearLayout\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\"\r\n                android:gravity=\"center_vertical\"\r\n                android:layout_marginBottom=\"24dp\">\r\n\r\n                <TextView\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:text=\"\uD83D\uDEA8 Security System\"\r\n                    android:textSize=\"18sp\"\r\n                    android:textColor=\"#ffffff\"\r\n                    android:textStyle=\"bold\" />\r\n\r\n                <!-- Inline network status dot so user sees home-network state without opening advanced panel -->\r\n                <ImageView\r\n                    android:id=\"@+id/securityNetworkHomeDotInline\"\r\n                    android:layout_width=\"12dp\"\r\n                    android:layout_height=\"12dp\"\r\n                    android:layout_marginEnd=\"8dp\"\r\n                    android:src=\"@drawable/ic_status_dot\"\r\n                    app:tint=\"#9E9E9E\"\r\n                    android:contentDescription=\"Home network status (inline)\" />\r\n\r\n                <TextView\r\n                    android:id=\"@+id/securityBackButton\"\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:text=\"← Back\"\r\n                    android:textSize=\"16sp\"\r\n                    android:textColor=\"#4CAF50\"\r\n                    android:padding=\"8dp\" />\r\n\r\n            </LinearLayout>\r\n\r\n            <!-- System Status -->\r\n            <androidx.cardview.widget.CardView\r\n                android:id=\"@+id/systemStatusCard\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:layout_marginBottom=\"12dp\"\r\n                app:cardBackgroundColor=\"#2D5016\"\r\n                app:cardCornerRadius=\"12dp\"\r\n                app:cardElevation=\"4dp\">\r\n\r\n                <LinearLayout\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:orientation=\"vertical\"\r\n                    android:padding=\"16dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"80dp\"\r\n                        android:layout_marginBottom=\"8dp\"\r\n                        android:gravity=\"center_vertical\"\r\n                        android:orientation=\"horizontal\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"0dp\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:layout_weight=\"1\"\r\n                            android:text=\"System Status\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textSize=\"18sp\"\r\n                            android:textStyle=\"bold\" />\r\n\r\n                        <androidx.appcompat.widget.SwitchCompat\r\n                            android:id=\"@+id/securityAlarmsSwitch\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:checked=\"true\" />\r\n\r\n                        <!-- Replaced multiple force toggles with a single spanner icon that opens an advanced panel -->\r\n                        <ImageView\r\n                            android:id=\"@+id/securitySettingsSpanner\"\r\n                            android:layout_width=\"36dp\"\r\n                            android:layout_height=\"36dp\"\r\n                            android:layout_marginStart=\"8dp\"\r\n                            android:layout_marginEnd=\"8dp\"\r\n                            android:src=\"@android:drawable/ic_menu_manage\"\r\n                            android:contentDescription=\"Settings\"\r\n                            app:tint=\"#FFFFFF\" />\r\n\r\n                    </LinearLayout>\r\n\r\n                    <!-- Summary/status texts remain visible -->\r\n                    <TextView\r\n                        android:id=\"@+id/systemStatusText\"\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:text=\"\uD83D\uDFE2 All Zones Armed - System Online\"\r\n                        android:textSize=\"16sp\"\r\n                        android:textColor=\"#B8D4A0\" />\r\n\r\n                    <TextView\r\n                        android:id=\"@+id/securityScheduleSummary\"\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:text=\"Scheduled: Always\"\r\n                        android:textSize=\"12sp\"\r\n                        android:textColor=\"#CCCCCC\"\r\n                        android:layout_marginTop=\"6dp\" />\r\n\r\n                    <!-- Advanced panel (hidden by default) opened via the spanner icon: contains force toggles + network LEDs -->\r\n                    <LinearLayout\r\n                        android:id=\"@+id/securityAdvancedPanel\"\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:orientation=\"vertical\"\r\n                        android:paddingTop=\"12dp\"\r\n                        android:paddingBottom=\"8dp\"\r\n                        android:visibility=\"gone\">\r\n\r\n                        <!-- Force toggles made clearer -->\r\n                        <LinearLayout\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:orientation=\"horizontal\"\r\n                            android:gravity=\"center_vertical\"\r\n                            android:layout_marginBottom=\"8dp\">\r\n\r\n                            <TextView\r\n                                android:layout_width=\"0dp\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:layout_weight=\"1\"\r\n                                android:text=\"Force alarms off while away\"\r\n                                android:textColor=\"#FFFFFF\"\r\n                                android:textSize=\"14sp\" />\r\n\r\n                            <androidx.appcompat.widget.SwitchCompat\r\n                                android:id=\"@+id/securityForceAwaySwitch\"\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:checked=\"false\" />\r\n\r\n                        </LinearLayout>\r\n\r\n                        <LinearLayout\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:orientation=\"horizontal\"\r\n                            android:gravity=\"center_vertical\"\r\n                            android:layout_marginBottom=\"12dp\">\r\n\r\n                            <TextView\r\n                                android:layout_width=\"0dp\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:layout_weight=\"1\"\r\n                                android:text=\"Force alarms off while home\"\r\n                                android:textColor=\"#FFFFFF\"\r\n                                android:textSize=\"14sp\" />\r\n\r\n                            <androidx.appcompat.widget.SwitchCompat\r\n                                android:id=\"@+id/securityForceHomeSwitch\"\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:checked=\"false\" />\r\n\r\n                        </LinearLayout>\r\n\r\n                        <!-- Divider -->\r\n                        <View\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"1dp\"\r\n                            android:background=\"#33444444\"\r\n                            android:layout_marginBottom=\"8dp\" />\r\n\r\n                        <!-- Network status LEDs and descriptions -->\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Network status\"\r\n                            android:textColor=\"#CCCCCC\"\r\n                            android:textSize=\"12sp\"\r\n                            android:layout_marginBottom=\"6dp\" />\r\n\r\n                        <LinearLayout\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:orientation=\"horizontal\"\r\n                            android:gravity=\"center_vertical\"\r\n                            android:layout_marginBottom=\"6dp\">\r\n\r\n                            <ImageView\r\n                                android:id=\"@+id/securityNetworkHomeDot\"\r\n                                android:layout_width=\"12dp\"\r\n                                android:layout_height=\"12dp\"\r\n                                android:src=\"@drawable/ic_status_dot\"\r\n                                app:tint=\"#9E9E9E\"\r\n                                android:contentDescription=\"Home network status\" />\r\n\r\n                            <TextView\r\n                                android:id=\"@+id/securityNetworkHomeText\"\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:layout_marginStart=\"8dp\"\r\n                                android:text=\"On home network\"\r\n                                android:textColor=\"#FFFFFF\"\r\n                                android:textSize=\"14sp\" />\r\n\r\n                        </LinearLayout>\r\n\r\n                        <LinearLayout\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:orientation=\"horizontal\"\r\n                            android:gravity=\"center_vertical\">\r\n\r\n                            <ImageView\r\n                                android:id=\"@+id/securityNetworkBridgeDot\"\r\n                                android:layout_width=\"12dp\"\r\n                                android:layout_height=\"12dp\"\r\n                                android:src=\"@drawable/ic_status_dot\"\r\n                                app:tint=\"#9E9E9E\"\r\n                                android:contentDescription=\"Bridge network status\" />\r\n\r\n                            <TextView\r\n                                android:id=\"@+id/securityNetworkBridgeText\"\r\n                                android:layout_width=\"wrap_content\"\r\n                                android:layout_height=\"wrap_content\"\r\n                                android:layout_marginStart=\"8dp\"\r\n                                android:text=\"Bridge / cloud status\"\r\n                                android:textColor=\"#FFFFFF\"\r\n                                android:textSize=\"14sp\" />\r\n\r\n                        </LinearLayout>\r\n\r\n                        <!-- Developer debug line: shows SSID/method/onHome/gateway when present -->\r\n                        <TextView\r\n                            android:id=\"@+id/securityNetworkDebugText\"\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"SSID: n/a  method: n/a  onHome: n/a  gw: n/a\"\r\n                            android:textColor=\"#FFCC00\"\r\n                            android:textSize=\"12sp\"\r\n                            android:layout_marginTop=\"8dp\"\r\n                            android:visibility=\"visible\" />\r\n\r\n                        <!-- Quick actions for developers/users -->\r\n                        <LinearLayout\r\n                            android:layout_width=\"match_parent\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:orientation=\"horizontal\"\r\n                            android:gravity=\"center_vertical\"\r\n                            android:layout_marginTop=\"8dp\">\r\n\r\n                            <Button\r\n                                android:id=\"@+id/refreshNetworkButton\"\r\n                                android:layout_width=\"0dp\"\r\n                                android:layout_weight=\"1\"\r\n                                android:layout_height=\"40dp\"\r\n                                android:text=\"Refresh\"\r\n                                android:textSize=\"12sp\"\r\n                                android:backgroundTint=\"#455A64\"\r\n                                android:textColor=\"#FFFFFF\" />\r\n\r\n                            <Space\r\n                                android:layout_width=\"8dp\"\r\n                                android:layout_height=\"1dp\" />\r\n\r\n                            <Button\r\n                                android:id=\"@+id/saveHomeButton\"\r\n                                android:layout_width=\"0dp\"\r\n                                android:layout_weight=\"1\"\r\n                                android:layout_height=\"40dp\"\r\n                                android:text=\"Save as Home\"\r\n                                android:textSize=\"12sp\"\r\n                                android:backgroundTint=\"#388E3C\"\r\n                                android:textColor=\"#FFFFFF\" />\r\n\r\n                        </LinearLayout>\r\n\r\n                     </LinearLayout>\r\n\r\n                    <!-- ...existing code... -->\r\n\r\n                </LinearLayout>\r\n            </androidx.cardview.widget.CardView>\r\n\r\n            <!-- Zone Grid -->\r\n            <TextView\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:text=\"Security Zones\"\r\n                android:textSize=\"18sp\"\r\n                android:textColor=\"#ffffff\"\r\n                android:textStyle=\"bold\"\r\n                android:layout_marginBottom=\"12dp\" />\r\n\r\n            <!-- Row 1: front, garage, garage side -->\r\n            <LinearLayout\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\"\r\n                android:layout_marginBottom=\"12dp\">\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:id=\"@+id/frontCard\"\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"120dp\"\r\n                    android:layout_marginEnd=\"6dp\"\r\n                    app:cardBackgroundColor=\"#1B5E20\"\r\n                    app:cardCornerRadius=\"8dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"12dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83C\uDFE1\"\r\n                            android:textSize=\"24sp\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Front\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textStyle=\"bold\"\r\n                            android:textSize=\"10sp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/frontStatus\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83D\uDFE2 Clear\"\r\n                            android:textColor=\"#4CAF50\"\r\n                            android:textSize=\"12sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:id=\"@+id/garageCard\"\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"120dp\"\r\n                    android:layout_marginStart=\"6dp\"\r\n                    android:layout_marginEnd=\"6dp\"\r\n                    app:cardBackgroundColor=\"#1B5E20\"\r\n                    app:cardCornerRadius=\"8dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"12dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83D\uDEAA\"\r\n                            android:textSize=\"24sp\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Garage\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textStyle=\"bold\"\r\n                            android:textSize=\"10sp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/garageStatus\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83D\uDFE2 Clear\"\r\n                            android:textColor=\"#4CAF50\"\r\n                            android:textSize=\"12sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:id=\"@+id/garageSideCard\"\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"120dp\"\r\n                    android:layout_marginStart=\"6dp\"\r\n                    app:cardBackgroundColor=\"#1B5E20\"\r\n                    app:cardCornerRadius=\"8dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"12dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83C\uDFE0\"\r\n                            android:textSize=\"24sp\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Garage Side\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textStyle=\"bold\"\r\n                            android:textSize=\"10sp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/garageSideStatus\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83D\uDFE2 Clear\"\r\n                            android:textColor=\"#4CAF50\"\r\n                            android:textSize=\"12sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n            </LinearLayout>\r\n\r\n            <!-- Row 2: north, door, south -->\r\n            <LinearLayout\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\"\r\n                android:layout_marginBottom=\"12dp\">\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:id=\"@+id/northCard\"\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"120dp\"\r\n                    android:layout_marginEnd=\"6dp\"\r\n                    app:cardBackgroundColor=\"#1B5E20\"\r\n                    app:cardCornerRadius=\"8dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"12dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"❄\uFE0F\"\r\n                            android:textSize=\"24sp\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"North\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textStyle=\"bold\"\r\n                            android:textSize=\"10sp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/northStatus\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83D\uDFE2 Clear\"\r\n                            android:textColor=\"#4CAF50\"\r\n                            android:textSize=\"12sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:id=\"@+id/doorCard\"\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"120dp\"\r\n                    android:layout_marginStart=\"6dp\"\r\n                    android:layout_marginEnd=\"6dp\"\r\n                    app:cardBackgroundColor=\"#1B5E20\"\r\n                    app:cardCornerRadius=\"8dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"12dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83D\uDEAA\"\r\n                            android:textSize=\"24sp\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Door\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textStyle=\"bold\"\r\n                            android:textSize=\"10sp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/doorStatus\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83D\uDFE2 Clear\"\r\n                            android:textColor=\"#4CAF50\"\r\n                            android:textSize=\"12sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:id=\"@+id/southCard\"\r\n                    android:layout_width=\"0dp\"\r\n                    android:layout_weight=\"1\"\r\n                    android:layout_height=\"120dp\"\r\n                    android:layout_marginStart=\"6dp\"\r\n                    app:cardBackgroundColor=\"#1B5E20\"\r\n                    app:cardCornerRadius=\"8dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"12dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83C\uDF05\"\r\n                            android:textSize=\"24sp\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"South\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textStyle=\"bold\"\r\n                            android:textSize=\"10sp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/southStatus\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83D\uDFE2 Clear\"\r\n                            android:textColor=\"#4CAF50\"\r\n                            android:textSize=\"12sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n            </LinearLayout>\r\n\r\n            <!-- Row 3: back (single) -->\r\n            <LinearLayout\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\"\r\n                android:layout_marginBottom=\"24dp\"\r\n                android:gravity=\"center_horizontal\">\r\n\r\n                <androidx.cardview.widget.CardView\r\n                    android:id=\"@+id/backCard\"\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"120dp\"\r\n                    app:cardBackgroundColor=\"#1B5E20\"\r\n                    app:cardCornerRadius=\"8dp\">\r\n\r\n                    <LinearLayout\r\n                        android:layout_width=\"match_parent\"\r\n                        android:layout_height=\"match_parent\"\r\n                        android:orientation=\"vertical\"\r\n                        android:gravity=\"center\"\r\n                        android:padding=\"12dp\">\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83C\uDF33\"\r\n                            android:textSize=\"24sp\" />\r\n\r\n                        <TextView\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"Back\"\r\n                            android:textColor=\"#ffffff\"\r\n                            android:textStyle=\"bold\"\r\n                            android:textSize=\"14sp\" />\r\n\r\n                        <TextView\r\n                            android:id=\"@+id/backStatus\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:text=\"\uD83D\uDFE2 Clear\"\r\n                            android:textColor=\"#4CAF50\"\r\n                            android:textSize=\"12sp\" />\r\n\r\n                    </LinearLayout>\r\n                </androidx.cardview.widget.CardView>\r\n\r\n            </LinearLayout>\r\n\r\n            <!-- Recent Alerts -->\r\n            <TextView\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:text=\"Recent Activity\"\r\n                android:textSize=\"18sp\"\r\n                android:textColor=\"#ffffff\"\r\n                android:textStyle=\"bold\"\r\n                android:layout_marginBottom=\"12dp\" />\r\n\r\n            <androidx.cardview.widget.CardView\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                app:cardBackgroundColor=\"#2C2C2C\"\r\n                app:cardCornerRadius=\"8dp\">\r\n\r\n                <TextView\r\n                    android:id=\"@+id/recentActivityText\"\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:text=\"No recent activity\"\r\n                    android:textSize=\"14sp\"\r\n                    android:textColor=\"#888888\"\r\n                    android:padding=\"16dp\" />\r\n\r\n            </androidx.cardview.widget.CardView>\r\n\r\n        </LinearLayout>\r\n    </ScrollView>\r\n</androidx.swiperefreshlayout.widget.SwipeRefreshLayout>\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/res/layout/activity_security.xml b/app/src/main/res/layout/activity_security.xml
--- a/app/src/main/res/layout/activity_security.xml	(revision 44d69ffda4d1488978c0d0db75712de451938b41)
+++ b/app/src/main/res/layout/activity_security.xml	(date 1766890021326)
@@ -640,14 +640,28 @@
                 app:cardBackgroundColor="#2C2C2C"
                 app:cardCornerRadius="8dp">
 
-                <TextView
-                    android:id="@+id/recentActivityText"
-                    android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:text="No recent activity"
-                    android:textSize="14sp"
-                    android:textColor="#888888"
-                    android:padding="16dp" />
+                <!-- Replace plain TextView with a NestedScrollView so the history can be scrolled -->
+                <androidx.core.widget.NestedScrollView
+                    android:layout_width="match_parent"
+                    android:layout_height="140dp"
+                    android:fillViewport="false"
+                    android:fadeScrollbars="true"
+                    android:scrollbarStyle="insideInset"
+                    android:scrollbars="vertical">
+
+                    <TextView
+                        android:id="@+id/recentActivityText"
+                        android:layout_width="match_parent"
+                        android:layout_height="wrap_content"
+                        android:text="No recent activity"
+                        android:textSize="14sp"
+                        android:textColor="#888888"
+                        android:padding="16dp"
+                        android:lineSpacingExtra="2dp"
+                        android:ellipsize="none"
+                        android:overScrollMode="ifContentScrolls" />
+
+                </androidx.core.widget.NestedScrollView>
 
             </androidx.cardview.widget.CardView>
 
Index: app/src/main/java/com/security/app/SecurityActivity.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.security.app\r\n\r\nimport android.Manifest\r\nimport android.app.NotificationChannel\r\nimport android.app.NotificationManager\r\nimport android.content.Context\r\nimport android.content.Intent\r\nimport android.content.pm.PackageManager\r\nimport android.media.RingtoneManager\r\nimport android.net.ConnectivityManager\r\nimport android.net.LinkProperties\r\nimport android.net.Network\r\nimport android.net.wifi.WifiManager\r\nimport android.os.Build\r\nimport android.os.Bundle\r\nimport android.os.Handler\r\nimport android.os.Looper\r\nimport android.util.Log\r\nimport android.widget.TextView\r\nimport android.widget.Toast\r\nimport androidx.cardview.widget.CardView\r\nimport androidx.core.app.ActivityCompat\r\nimport androidx.core.app.NotificationCompat\r\nimport androidx.swiperefreshlayout.widget.SwipeRefreshLayout\r\nimport androidx.core.app.NotificationManagerCompat\r\nimport androidx.core.content.ContextCompat\r\nimport com.google.firebase.firestore.FirebaseFirestore\r\nimport androidx.appcompat.app.AlertDialog\r\n\r\nimport java.net.InetAddress\r\nimport java.text.SimpleDateFormat\r\nimport java.util.*\r\nimport android.graphics.Color\r\nimport kotlinx.coroutines.*\r\n\r\nclass SecurityActivity : BaseActivity() {\r\n    \r\n    private lateinit var db: FirebaseFirestore\r\n    private lateinit var systemStatusText: TextView\r\n    private lateinit var garageStatus: TextView\r\n    private lateinit var garageSideStatus: TextView\r\n    private lateinit var southStatus: TextView\r\n    private lateinit var backStatus: TextView\r\n    private lateinit var northStatus: TextView\r\n    private lateinit var frontStatus: TextView\r\n    private lateinit var doorStatus: TextView\r\n    private lateinit var securityAlarmsSwitch: androidx.appcompat.widget.SwitchCompat\r\n    private lateinit var securityScheduleSummary: TextView\r\n    private lateinit var systemStatusCard: androidx.cardview.widget.CardView\r\n    private lateinit var securityForceSwitch: androidx.appcompat.widget.SwitchCompat\r\n    private lateinit var securityForceOffSwitch: androidx.appcompat.widget.SwitchCompat\r\n    private lateinit var recentActivityText: TextView\r\n\r\n    // Network indicator views (promoted so we can refresh them from lifecycle callbacks)\r\n    private var networkHomeDot: android.widget.ImageView? = null\r\n    private var networkBridgeDot: android.widget.ImageView? = null\r\n    private var networkHomeDotInline: android.widget.ImageView? = null\r\n    // Optional debug text view (present in layout if developer added it); shows SSID/method/gateway for quick debugging\r\n    private var networkDebugText: TextView? = null\r\n\r\n    // Small in-memory cache to keep recent activity between update cycles\r\n    private val recentActivityCache: MutableList<String> = mutableListOf()\r\n\r\n    // Firestore listener registration for proper cleanup\r\n    private var securityListener: com.google.firebase.firestore.ListenerRegistration? = null\r\n\r\n    private val CHANNEL_ID = \"security_alerts\"\r\n    private val NOTIF_ID = 1001\r\n\r\n    companion object {\r\n        private const val REQ_POST_NOTIF = 2001\r\n        private const val REQ_FINE_LOCATION = 3001\r\n\r\n        // New default silent channel id for non-security notifications\r\n        private const val DEFAULT_CHANNEL_ID = \"default_notifications\"\r\n    }\r\n\r\n    // Cached SSID value populated by NetworkCallback to avoid direct heavy use of deprecated WifiInfo getter\r\n    @Volatile\r\n    private var lastKnownSsid: String? = null\r\n\r\n    // NetworkCallback used to monitor connectivity and update SSID when Wi-Fi is active\r\n    private var networkCallback: ConnectivityManager.NetworkCallback? = null\r\n\r\n    // Helper: check whether a gateway IP is within the RFC1918 172.16.0.0/12 private range\r\n    private fun is172PrivateRange(ip: String?): Boolean {\r\n        try {\r\n            if (ip.isNullOrEmpty()) return false\r\n            val parts = ip.split('.')\r\n            if (parts.size < 2) return false\r\n            val first = parts[0].toIntOrNull() ?: return false\r\n            val second = parts[1].toIntOrNull() ?: return false\r\n            return first == 172 && second in 16..31\r\n        } catch (e: Exception) {\r\n            return false\r\n        }\r\n    }\r\n\r\n    // Actively fetch and cache SSID once (useful at startup when NetworkCallback hasn't fired yet)\r\n    private fun fetchAndCacheSsidOnce(onComplete: (() -> Unit)? = null) {\r\n        try {\r\n            // Ensure we have permission to read SSID\r\n            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED) {\r\n                Log.d(\"SecurityActivity\", \"fetchAndCacheSsidOnce: no location permission, requesting\")\r\n                ensureLocationPermissionForSsid { fetchAndCacheSsidOnce(onComplete) }\r\n                return\r\n            }\r\n            // Run on background thread to avoid blocking UI\r\n            CoroutineScope(Dispatchers.IO).launch {\r\n                try {\r\n                    val cm = getSystemService(Context.CONNECTIVITY_SERVICE) as? ConnectivityManager\r\n                    val active = cm?.activeNetwork\r\n                    var ssid: String? = null\r\n                    if (active != null) {\r\n                        val caps = cm.getNetworkCapabilities(active)\r\n                        if (caps != null && caps.hasTransport(android.net.NetworkCapabilities.TRANSPORT_WIFI)) {\r\n                            try {\r\n                                // Use the network-backed helper which prefers modern APIs and falls back safely\r\n                                val helperSsid = readSsidFromWifiManager()\r\n                                if (!helperSsid.isNullOrEmpty()) ssid = helperSsid\r\n                            } catch (e: Exception) {\r\n                                Log.w(\"SecurityActivity\", \"fetchAndCacheSsidOnce: wifi read failed\", e)\r\n                            }\r\n                        }\r\n                    }\r\n                    if (!ssid.isNullOrEmpty()) {\r\n                        lastKnownSsid = ssid\r\n                        Log.d(\"SecurityActivity\", \"fetchAndCacheSsidOnce: cached ssid=$ssid\")\r\n                    } else {\r\n                        Log.d(\"SecurityActivity\", \"fetchAndCacheSsidOnce: no SSID available\")\r\n                    }\r\n                } catch (e: Exception) {\r\n                    Log.w(\"SecurityActivity\", \"fetchAndCacheSsidOnce failed\", e)\r\n                } finally {\r\n                    try { withContext(Dispatchers.Main) { onComplete?.invoke() } } catch (_: Exception) {}\r\n                }\r\n            }\r\n        } catch (e: Exception) {\r\n            Log.w(\"SecurityActivity\", \"fetchAndCacheSsidOnce outer failed\", e)\r\n            onComplete?.invoke()\r\n        }\r\n    }\r\n\r\n    // Helper: request runtime location permission if needed to read connected SSID\r\n    private fun ensureLocationPermissionForSsid(onGranted: () -> Unit) {\r\n        try {\r\n            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\r\n                if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED) {\r\n                    ActivityCompat.requestPermissions(this, arrayOf(Manifest.permission.ACCESS_FINE_LOCATION), REQ_FINE_LOCATION)\r\n                    return\r\n                }\r\n            }\r\n            onGranted()\r\n        } catch (e: Exception) {\r\n            Log.w(\"SecurityActivity\", \"ensureLocationPermissionForSsid failed\", e)\r\n        }\r\n    }\r\n\r\n    private fun startSsidMonitoring() {\r\n        try {\r\n            val cm = getSystemService(Context.CONNECTIVITY_SERVICE) as? ConnectivityManager ?: return\r\n            // Avoid registering multiple times\r\n            if (networkCallback != null) return\r\n            val cb = object : ConnectivityManager.NetworkCallback() {\r\n                override fun onAvailable(network: Network) {\r\n                    try {\r\n                        val caps = cm.getNetworkCapabilities(network)\r\n                        if (caps != null && caps.hasTransport(android.net.NetworkCapabilities.TRANSPORT_WIFI)) {\r\n                            try {\r\n                                // Prefer network-backed SSID read helper\r\n                                val rawSsid = readSsidFromWifiManager()\r\n                                if (!rawSsid.isNullOrEmpty()) {\r\n                                  lastKnownSsid = rawSsid\r\n                                } else {\r\n                                  lastKnownSsid = null\r\n                                }\r\n                                Log.d(\"SecurityActivity\", \"NetworkCallback onAvailable: ssid=${lastKnownSsid}\")\r\n                                try { runOnUiThread { updateNetworkIndicators(networkHomeDot, networkBridgeDot, networkHomeDotInline) } } catch (_: Exception) {}\r\n                            } catch (e: Exception) {\r\n                                Log.w(\"SecurityActivity\", \"NetworkCallback failed reading SSID\", e)\r\n                            }\r\n                        }\r\n                    } catch (e: Exception) {\r\n                        Log.w(\"SecurityActivity\", \"NetworkCallback onAvailable error\", e)\r\n                    }\r\n                }\r\n\r\n                override fun onLost(network: Network) {\r\n                    try {\r\n                        // If Wi-Fi lost, clear cached SSID\r\n                        lastKnownSsid = null\r\n                        Log.d(\"SecurityActivity\", \"NetworkCallback onLost: cleared cached SSID\")\r\n                        try { runOnUiThread { updateNetworkIndicators(networkHomeDot, networkBridgeDot, networkHomeDotInline) } } catch (_: Exception) {}\r\n                    } catch (_: Exception) {}\r\n                }\r\n\r\n                override fun onCapabilitiesChanged(network: Network, networkCapabilities: android.net.NetworkCapabilities) {\r\n                    try {\r\n                        if (networkCapabilities.hasTransport(android.net.NetworkCapabilities.TRANSPORT_WIFI)) {\r\n                            try {\r\n                                // Prefer network-backed SSID read helper\r\n                                val rawSsid = readSsidFromWifiManager()\r\n                                if (!rawSsid.isNullOrEmpty()) {\r\n                                  lastKnownSsid = rawSsid\r\n                                } else {\r\n                                  lastKnownSsid = null\r\n                                }\r\n                                Log.d(\"SecurityActivity\", \"NetworkCallback onCapabilitiesChanged: ssid=${lastKnownSsid}\")\r\n                                try { runOnUiThread { updateNetworkIndicators(networkHomeDot, networkBridgeDot, networkHomeDotInline) } } catch (_: Exception) {}\r\n                            } catch (e: Exception) {\r\n                                Log.w(\"SecurityActivity\", \"NetworkCallback capabilities read SSID failed\", e)\r\n                            }\r\n                        }\r\n                    } catch (_: Exception) {}\r\n                }\r\n            }\r\n            networkCallback = cb\r\n            try {\r\n                val req = android.net.NetworkRequest.Builder()\r\n                    .addTransportType(android.net.NetworkCapabilities.TRANSPORT_WIFI)\r\n                    .build()\r\n                cm.registerNetworkCallback(req, cb)\r\n                Log.d(\"SecurityActivity\", \"Registered SSID NetworkCallback\")\r\n                // Kick off an active single-shot fetch to populate lastKnownSsid quickly at startup\r\n                fetchAndCacheSsidOnce(null)\r\n            } catch (e: Exception) {\r\n                Log.w(\"SecurityActivity\", \"Failed to register NetworkCallback for SSID monitoring\", e)\r\n                networkCallback = null\r\n            }\r\n        } catch (e: Exception) {\r\n            Log.w(\"SecurityActivity\", \"startSsidMonitoring failed\", e)\r\n        }\r\n    }\r\n\r\n    private fun stopSsidMonitoring() {\r\n        try {\r\n            val cm = getSystemService(Context.CONNECTIVITY_SERVICE) as? ConnectivityManager ?: return\r\n            val cb = networkCallback ?: return\r\n            try { cm.unregisterNetworkCallback(cb) } catch (e: Exception) { Log.w(\"SecurityActivity\", \"Failed to unregister NetworkCallback\", e) }\r\n            networkCallback = null\r\n            lastKnownSsid = null\r\n            Log.d(\"SecurityActivity\", \"Unregistered SSID NetworkCallback\")\r\n        } catch (e: Exception) {\r\n            Log.w(\"SecurityActivity\", \"stopSsidMonitoring failed\", e)\r\n        }\r\n    }\r\n\r\n    // Helper: read current connected SSID (may return null if unavailable)\r\n    private fun readSsidFromWifiManager(): String? {\r\n        try {\r\n            val cm = getSystemService(Context.CONNECTIVITY_SERVICE) as? ConnectivityManager\r\n            val wifiManager = applicationContext.getSystemService(Context.WIFI_SERVICE) as? WifiManager\r\n            // First, try to use WifiManager.getConnectionInfo(Network) if available (API 30+); use reflection so code compiles on older APIs.\r\n            try {\r\n                val active = cm?.activeNetwork\r\n                if (active != null && wifiManager != null) {\r\n                    try {\r\n                        val m = wifiManager.javaClass.getMethod(\"getConnectionInfo\", Network::class.java)\r\n                        val wifiInfo = m.invoke(wifiManager, active)\r\n                        val raw = wifiInfo?.javaClass?.getMethod(\"getSSID\")?.invoke(wifiInfo) as? String\r\n                        if (!raw.isNullOrEmpty()) {\r\n                          val cleaned = raw.trim('\\\"','\\'').trim()\r\n                          val lower = cleaned.lowercase(Locale.getDefault())\r\n                          if (lower == \"<unknown ssid>\" || lower == \"unknown\" || lower.startsWith(\"0x\") || lower == \"<none>\") return null\r\n                          return cleaned\r\n                        }\r\n                    } catch (e: NoSuchMethodException) {\r\n                        // method not available on this platform, fall through\r\n                    } catch (e: Exception) {\r\n                        Log.w(\"SecurityActivity\", \"readSsidFromWifiManager reflection read failed\", e)\r\n                    }\r\n                }\r\n            } catch (e: Exception) {\r\n                Log.w(\"SecurityActivity\", \"readSsidFromWifiManager active-network attempt failed\", e)\r\n            }\r\n\r\n            // Modern network-backed method not available: as a last resort attempt deprecated WifiManager.connectionInfo\r\n            // but only when we have runtime ACCESS_FINE_LOCATION permission. Suppress deprecation warning for this block.\r\n            try {\r\n                val hasPerm = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) ContextCompat.checkSelfPermission(this@SecurityActivity, Manifest.permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED else true\r\n                if (hasPerm) {\r\n                    try {\r\n                        @Suppress(\"DEPRECATION\")\r\n                        val wifiMgr = applicationContext.getSystemService(Context.WIFI_SERVICE) as? WifiManager\r\n                        @Suppress(\"DEPRECATION\")\r\n                        val info = wifiMgr?.connectionInfo\r\n                        val raw = info?.ssid\r\n                        if (!raw.isNullOrEmpty()) {\r\n                            val cleaned = raw.trim('\\\"','\\'').trim()\r\n                            val lower = cleaned.lowercase(Locale.getDefault())\r\n                            if (lower == \"<unknown ssid>\" || lower == \"unknown\" || lower.startsWith(\"0x\") || lower == \"<none>\") return null\r\n                            Log.d(\"SecurityActivity\", \"readSsidFromWifiManager: deprecated connectionInfo fallback used\")\r\n                            return cleaned\r\n                        }\r\n                    } catch (e: Exception) {\r\n                        Log.w(\"SecurityActivity\", \"readSsidFromWifiManager deprecated fallback failed\", e)\r\n                    }\r\n                } else {\r\n                    Log.d(\"SecurityActivity\", \"readSsidFromWifiManager: no location permission for deprecated fallback\")\r\n                }\r\n            } catch (e: Exception) {\r\n                Log.w(\"SecurityActivity\", \"readSsidFromWifiManager permission check failed\", e)\r\n            }\r\n            return null\r\n        } catch (e: Exception) {\r\n            Log.w(\"SecurityActivity\", \"readSsidFromWifiManager failed\", e)\r\n            return null\r\n        }\r\n    }\r\n\r\n    private fun getCurrentSsid(): String? {\r\n        try {\r\n            val cached = lastKnownSsid\r\n            if (!cached.isNullOrEmpty()) return cached\r\n            // Try the new helper which prefers network-backed read\r\n            val s = readSsidFromWifiManager()\r\n            if (!s.isNullOrEmpty()) return s\r\n            return null\r\n        } catch (e: Exception) {\r\n            Log.w(\"SecurityActivity\", \"getCurrentSsid failed\", e)\r\n            return null\r\n        }\r\n    }\r\n\r\n    // Save current SSID as the configured home SSID\r\n    private fun saveCurrentSsidAsHome() {\r\n        ensureLocationPermissionForSsid {\r\n            try {\r\n                val ssid = getCurrentSsid()\r\n                if (ssid != null) {\r\n                    getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE).edit().putString(\"home_ssid\", ssid).apply()\r\n                    try { ToastHelper.show(this, \"Saved home SSID: $ssid\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                } else {\r\n                    try { ToastHelper.show(this, \"Unable to read SSID\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                }\r\n            } catch (e: Exception) {\r\n                Log.w(\"SecurityActivity\", \"saveCurrentSsidAsHome failed\", e)\r\n            }\r\n        }\r\n    }\r\n\r\n    override fun onCreate(savedInstanceState: Bundle?) {\r\n        super.onCreate(savedInstanceState)\r\n        setContentView(R.layout.activity_security)\r\n        // Start SSID monitoring to populate a reliable cached SSID\r\n        startSsidMonitoring()\r\n        Log.d(\"SecurityActivity\", \"onCreate: SecurityActivity started\")\r\n\r\n        // Initialize Firebase\r\n        db = FirebaseFirestore.getInstance()\r\n        \r\n        // Initialize views\r\n        systemStatusText = findViewById(R.id.systemStatusText)\r\n        garageStatus = findViewById(R.id.garageStatus)\r\n        garageSideStatus = findViewById(R.id.garageSideStatus)\r\n        southStatus = findViewById(R.id.southStatus)\r\n        backStatus = findViewById(R.id.backStatus)\r\n        northStatus = findViewById(R.id.northStatus)\r\n        frontStatus = findViewById(R.id.frontStatus)\r\n        doorStatus = findViewById(R.id.doorStatus)\r\n        recentActivityText = findViewById(R.id.recentActivityText)\r\n\r\n        // Restore persisted recent activity (if any)\r\n        val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n        val persisted = prefs.getString(\"security_recent_activity\", null)\r\n        if (!persisted.isNullOrEmpty()) {\r\n            // Normalize line endings and remove any accidental empty lines\r\n            val normalized = persisted.replace(\"\\r\\n\", \"\\n\").replace(\"\\r\", \"\\n\").trim('\\n')\r\n            val items = if (normalized.isEmpty()) emptyList() else normalized.split(\"\\n\")\r\n            recentActivityCache.clear()\r\n            recentActivityCache.addAll(items)\r\n            // Show newest activity at the top: take the last 5 (most recent) then reverse so latest is first\r\n            try {\r\n                recentActivityText.text = recentActivityCache.takeLast(5).reversed().joinToString(\"\\n\")\r\n                recentActivityText.setTextColor(resources.getColor(android.R.color.white, theme))\r\n            } catch (e: Exception) {\r\n                Log.w(\"SecurityActivity\", \"Failed setting recentActivityText from persisted data\", e)\r\n            }\r\n            Log.d(\"SecurityActivity\", \"Loaded ${recentActivityCache.size} persisted recentActivity entries\")\r\n        }\r\n\r\n        // Setup back button\r\n        findViewById<TextView>(R.id.securityBackButton).setOnClickListener {\r\n            finish()\r\n        }\r\n\r\n        // Security alarms switch\r\n        securityAlarmsSwitch = findViewById(R.id.securityAlarmsSwitch)\r\n        val enabledPref = prefs.getBoolean(\"security_alarms_enabled\", true)\r\n        securityAlarmsSwitch.isChecked = enabledPref\r\n        securityAlarmsSwitch.setOnCheckedChangeListener { _, isChecked ->\r\n            prefs.edit().putBoolean(\"security_alarms_enabled\", isChecked).apply()\r\n            try { ToastHelper.show(this, if (isChecked) \"Security alarms enabled\" else \"Security alarms disabled\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n            updateScheduleUi()\r\n        }\r\n\r\n        // Re-bind force switches to the new IDs in the layout (clearer labels in XML)\r\n        securityForceSwitch = findViewById(R.id.securityForceAwaySwitch)\r\n        val forcePref = prefs.getBoolean(\"security_alarms_force_on\", false)\r\n        securityForceSwitch.isChecked = forcePref\r\n        securityForceSwitch.setOnCheckedChangeListener { _, isChecked ->\r\n            prefs.edit().putBoolean(\"security_alarms_force_on\", isChecked).apply()\r\n            try { ToastHelper.show(this, if (isChecked) \"Security alarms forced ON\" else \"Security alarms no longer forced\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n            updateScheduleUi()\r\n        }\r\n\r\n        securityForceOffSwitch = findViewById(R.id.securityForceHomeSwitch)\r\n        val forceOffPref = prefs.getBoolean(\"security_alarms_force_off\", false)\r\n        securityForceOffSwitch.isChecked = forceOffPref\r\n        securityForceOffSwitch.setOnCheckedChangeListener { _, isChecked ->\r\n            prefs.edit().putBoolean(\"security_alarms_force_off\", isChecked).apply()\r\n            try { ToastHelper.show(this, if (isChecked) \"Security alarms forced OFF\" else \"Security alarms no longer forced OFF\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n            updateScheduleUi()\r\n        }\r\n\r\n        // Bind schedule summary and status card for dimming\r\n        securityScheduleSummary = findViewById(R.id.securityScheduleSummary)\r\n        systemStatusCard = findViewById(R.id.systemStatusCard)\r\n        updateScheduleUi()\r\n\r\n        // Bind the spanner icon + advanced panel and network LEDs\r\n         try {\r\n             val spanner = findViewById<android.widget.ImageView>(R.id.securitySettingsSpanner)\r\n             val advancedPanel = findViewById<android.widget.LinearLayout>(R.id.securityAdvancedPanel)\r\n             // Assign to class members so we can refresh them later\r\n             networkHomeDot = findViewById<android.widget.ImageView>(R.id.securityNetworkHomeDot)\r\n             networkBridgeDot = findViewById<android.widget.ImageView>(R.id.securityNetworkBridgeDot)\r\n             // Inline dot placed on the main card header so users see network state without opening advanced panel\r\n             networkHomeDotInline = findViewById<android.widget.ImageView?>(R.id.securityNetworkHomeDotInline)\r\n\r\n             // Bind optional debug text view if present in layout (id: securityNetworkDebugText)\r\n             try {\r\n                 val dbgId = resources.getIdentifier(\"securityNetworkDebugText\", \"id\", packageName)\r\n                 if (dbgId != 0) {\r\n                     try { networkDebugText = findViewById<TextView>(dbgId) } catch (_: Exception) { networkDebugText = null }\r\n                 }\r\n             } catch (_: Exception) { networkDebugText = null }\r\n\r\n            // Wire quick action buttons\r\n            try {\r\n                val refreshId = resources.getIdentifier(\"refreshNetworkButton\", \"id\", packageName)\r\n                if (refreshId != 0) {\r\n                    try {\r\n                        findViewById<android.widget.Button>(refreshId).setOnClickListener {\r\n                            try { ToastHelper.show(this, \"Refreshing network status...\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                            // Active fetch then update indicators when done\r\n                            fetchAndCacheSsidOnce { runOnUiThread { updateNetworkIndicators(networkHomeDot, networkBridgeDot, networkHomeDotInline) } }\r\n                        }\r\n                    } catch (_: Exception) {}\r\n                }\r\n            } catch (_: Exception) {}\r\n\r\n            try {\r\n                val saveId = resources.getIdentifier(\"saveHomeButton\", \"id\", packageName)\r\n                if (saveId != 0) {\r\n                    try {\r\n                        findViewById<android.widget.Button>(saveId).setOnClickListener {\r\n                            // Prompt user: will request permission if needed\r\n                            saveCurrentSsidAsHome()\r\n                        }\r\n                    } catch (_: Exception) {}\r\n                }\r\n            } catch (_: Exception) {}\r\n\r\n              // Initialize network indicators immediately\r\n             updateNetworkIndicators(networkHomeDot, networkBridgeDot, networkHomeDotInline)\r\n\r\n             // Toggle the advanced panel when spanner is clicked\r\n             spanner?.setOnClickListener {\r\n                 try {\r\n                     if (advancedPanel.visibility == android.view.View.GONE) {\r\n                         advancedPanel.visibility = android.view.View.VISIBLE\r\n                         // refresh indicators when opening\r\n                         updateNetworkIndicators(networkHomeDot, networkBridgeDot, networkHomeDotInline)\r\n                     } else {\r\n                         advancedPanel.visibility = android.view.View.GONE\r\n                     }\r\n                 } catch (e: Exception) {\r\n                     Log.w(\"SecurityActivity\", \"Failed toggling advanced panel\", e)\r\n                 }\r\n             }\r\n         } catch (_: Exception) {}\r\n\r\n        createNotificationChannel()\r\n\r\n        // Request runtime POST_NOTIFICATIONS permission on Android 13+\r\n        requestNotificationPermissionIfNeeded()\r\n\r\n        // Listen for real-time security updates\r\n        listenForSecurityUpdates()\r\n\r\n        // Setup refresh listener\r\n        val swipeRefreshLayout = findViewById<SwipeRefreshLayout>(R.id.swipeRefreshLayout)\r\n        swipeRefreshLayout.setOnRefreshListener {\r\n            listenForSecurityUpdates()\r\n            swipeRefreshLayout.isRefreshing = false\r\n        }\r\n\r\n        // Setup click listeners for camera views\r\n        setupCameraClickListeners()\r\n\r\n        // Long-press on the recent activity area to change appearance (card color / graph bg)\r\n        recentActivityText.setOnLongClickListener {\r\n            val options = arrayOf(\"Card background color\", \"Graph background color\")\r\n            val builder = android.app.AlertDialog.Builder(this)\r\n            builder.setTitle(\"Security appearance\")\r\n            builder.setItems(options) { _, which ->\r\n                when (which) {\r\n                    0 -> showColorPicker(\"card_security_color\", \"Choose Security card color\") {\r\n                        try { ToastHelper.show(this, \"Security card color saved. Return to dashboard to see change.\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                    }\r\n                    1 -> showColorPicker(\"graph_background_color\", \"Choose Security graph background\") {\r\n                        try { ToastHelper.show(this, \"Security graph background saved.\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                    }\r\n                }\r\n            }\r\n            builder.show()\r\n            true\r\n        }\r\n\r\n        // Wire presence check button\r\n        try {\r\n            // Resolve the id at runtime to avoid a compile-time reference to a missing R.id field\r\n            val checkPresenceId = resources.getIdentifier(\"checkPresenceButton\", \"id\", packageName)\r\n            if (checkPresenceId != 0) {\r\n                findViewById<android.widget.Button>(checkPresenceId).setOnClickListener {\r\n                    // Show presence dialog which now includes a Save SSID button for configuring home SSID\r\n                    showPresenceDialog()\r\n                }\r\n            }\r\n        } catch (_: Exception) {}\r\n    }\r\n\r\n    private fun setupCameraClickListeners() {\r\n        // Full list of Drive image URLs (nullable so missing cameras show a friendly message)\r\n        // These are defaults; the user can override any of them by setting SharedPreferences keys like \"camera_door_url\"\r\n        val defaults: Map<String, String?> = mapOf(\r\n            \"garage\" to \"https://lh3.googleusercontent.com/d/1i7yQEZAIEwjB1aYfN0jKUwVdOKhL2uBr\",\r\n            \"garage_side\" to \"https://lh3.googleusercontent.com/d/1mZTC_6Nb4thZAQvH4bafJVwO6p8yB6KH\",\r\n            \"south\" to \"https://lh3.googleusercontent.com/d/1Fw9dvmwaWkw8RjCi18Zr_fUdXzN5MApw\",\r\n            \"back\" to \"https://lh3.googleusercontent.com/d/1D-RC21Z5p9atX1xTle31uDlA1dgqAAJ-\",\r\n            \"north\" to \"https://lh3.googleusercontent.com/d/1uPhu1YBPCTVtDog8a7TdTOt8zI2x3s_L\",\r\n            \"front\" to \"https://lh3.googleusercontent.com/d/1aGcQTvdpYNsmUNOLN-4TFruxk7MTu-wg\",\r\n            // Door default: use the user-provided Drive file (converted to direct GoogleUserContent URL)\r\n            \"door\" to \"https://lh3.googleusercontent.com/d/1Ngq-uxaXuoHFySX-ynU1vwafeRh5InU5\"\r\n        )\r\n\r\n        // Allow overrides from shared prefs: keys of the form camera_<key>_url, e.g. camera_door_url\r\n        val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n        val imageUrls = defaults.mapValues { (key, defaultVal) ->\r\n            val prefKey = \"camera_${key}_url\"\r\n            val fromPref = prefs.getString(prefKey, null)\r\n            if (!fromPref.isNullOrBlank()) fromPref else defaultVal\r\n        }\r\n\r\n        fun openOrNotify(urlKey: String, zoneName: String) {\r\n            val url = imageUrls[urlKey]\r\n            if (url != null) {\r\n                Log.d(\"SecurityActivity\", \"Card pressed: $zoneName -> opening image URL: $url\")\r\n                // When opening from a zone card, request the image view to force a network reload\r\n                openImageView(url, true)\r\n            } else {\r\n                Log.w(\"SecurityActivity\", \"Card pressed: $zoneName -> no image URL configured\")\r\n                // Use a more conservative approach to avoid system toast conflicts\r\n                Handler(Looper.getMainLooper()).postDelayed({\r\n                    try { ToastHelper.show(this, \"No camera image available for $zoneName\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                }, 100)\r\n            }\r\n        }\r\n\r\n        findViewById<CardView>(R.id.garageCard).setOnClickListener { openOrNotify(\"garage\", \"Garage\") }\r\n        findViewById<CardView>(R.id.garageSideCard).setOnClickListener { openOrNotify(\"garage_side\", \"Garage Side\") }\r\n        findViewById<CardView>(R.id.southCard).setOnClickListener { openOrNotify(\"south\", \"South\") }\r\n        findViewById<CardView>(R.id.backCard).setOnClickListener { openOrNotify(\"back\", \"Back\") }\r\n        findViewById<CardView>(R.id.northCard).setOnClickListener { openOrNotify(\"north\", \"North\") }\r\n        findViewById<CardView>(R.id.frontCard).setOnClickListener { openOrNotify(\"front\", \"Front\") }\r\n        findViewById<CardView>(R.id.doorCard).setOnClickListener { openOrNotify(\"door\", \"Door\") }\r\n        // Long-press the Door card to set or remove a camera URL (saved in prefs as camera_door_url)\r\n        try {\r\n            val doorCardView = findViewById<CardView?>(R.id.doorCard)\r\n            doorCardView?.setOnLongClickListener {\r\n                try {\r\n                    val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n                    val current = prefs.getString(\"camera_door_url\", \"\") ?: \"\"\r\n                    val edit = android.widget.EditText(this@SecurityActivity)\r\n                    edit.setText(current)\r\n                    edit.hint = \"https://...\"\r\n                    val dlg = AlertDialog.Builder(this@SecurityActivity)\r\n                        .setTitle(\"Door camera URL\")\r\n                        .setView(edit)\r\n                        .setPositiveButton(\"Save\") { _, _ ->\r\n                            val v = edit.text.toString().trim()\r\n                            if (v.isNotEmpty()) prefs.edit().putString(\"camera_door_url\", v).apply() else prefs.edit().remove(\"camera_door_url\").apply()\r\n                            try { ToastHelper.show(this@SecurityActivity, \"Door camera URL saved\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                        }\r\n                        .setNeutralButton(\"Remove\") { _, _ ->\r\n                            prefs.edit().remove(\"camera_door_url\").apply()\r\n                            try { ToastHelper.show(this@SecurityActivity, \"Door camera URL removed\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                        }\r\n                        .setNegativeButton(\"Cancel\", null)\r\n                    dlg.show()\r\n                } catch (e: Exception) {\r\n                    Log.w(\"SecurityActivity\", \"Failed to show door URL dialog\", e)\r\n                    try { ToastHelper.show(this@SecurityActivity, \"Unable to edit URL\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                }\r\n                true\r\n            }\r\n        } catch (_: Exception) {}\r\n    }\r\n\r\n    private fun openImageView(imageUrl: String?, forceReload: Boolean = false) {\r\n        if (imageUrl != null) {\r\n            val intent = Intent(this, ImageViewActivity::class.java)\r\n            intent.putExtra(\"IMAGE_URL\", imageUrl)\r\n            // Signal the ImageViewActivity to bypass caches and force a network reload when opened from a zone card\r\n            intent.putExtra(\"FORCE_RELOAD\", forceReload)\r\n            startActivity(intent)\r\n        }\r\n    }\r\n\r\n    private fun requestNotificationPermissionIfNeeded() {\r\n        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {\r\n            if (ContextCompat.checkSelfPermission(this, Manifest.permission.POST_NOTIFICATIONS)\r\n                != PackageManager.PERMISSION_GRANTED\r\n            ) {\r\n                Log.d(\"SecurityActivity\", \"Requesting POST_NOTIFICATIONS permission\")\r\n                ActivityCompat.requestPermissions(this, arrayOf(Manifest.permission.POST_NOTIFICATIONS), REQ_POST_NOTIF)\r\n            } else {\r\n                Log.d(\"SecurityActivity\", \"POST_NOTIFICATIONS already granted\")\r\n            }\r\n        }\r\n    }\r\n\r\n    override fun onRequestPermissionsResult(requestCode: Int, permissions: Array<out String>, grantResults: IntArray) {\r\n        super.onRequestPermissionsResult(requestCode, permissions, grantResults)\r\n        if (requestCode == REQ_POST_NOTIF) {\r\n            if (grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED) {\r\n                Log.d(\"SecurityActivity\", \"POST_NOTIFICATIONS granted by user\")\r\n            } else {\r\n                Log.w(\"SecurityActivity\", \"POST_NOTIFICATIONS denied by user; alerts may be suppressed\")\r\n            }\r\n        }\r\n        // Handle location permission request result\r\n        if (requestCode == REQ_FINE_LOCATION) {\r\n            if (grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED) {\r\n                Log.d(\"SecurityActivity\", \"ACCESS_FINE_LOCATION granted by user\")\r\n                // Permission granted, refresh network indicators so SSID read is attempted now\r\n                try {\r\n                    runOnUiThread { updateNetworkIndicators(networkHomeDot, networkBridgeDot, networkHomeDotInline) }\r\n                } catch (e: Exception) {\r\n                    Log.w(\"SecurityActivity\", \"Failed to refresh network indicators after permission grant\", e)\r\n                }\r\n            } else {\r\n                Log.w(\"SecurityActivity\", \"ACCESS_FINE_LOCATION denied by user; SSID read will be unavailable\")\r\n            }\r\n        }\r\n    }\r\n\r\n    private fun listenForSecurityUpdates() {\r\n        securityListener = db.collection(\"security sensors\").document(\"live_status\")\r\n            .addSnapshotListener { documentSnapshot, e ->\r\n                if (e != null) {\r\n                    Log.w(\"SecurityActivity\", \"Listen failed.\", e)\r\n                    return@addSnapshotListener\r\n                }\r\n                \r\n                if (documentSnapshot != null && documentSnapshot.exists()) {\r\n                    updateSecurityDisplay(documentSnapshot.data ?: emptyMap())\r\n                }\r\n            }\r\n    }\r\n    \r\n    private fun updateSecurityDisplay(data: Map<String, Any>) {\r\n        val zones = mapOf(\r\n            \"Garage\" to Pair(listOf(\"garage_motion\", \"garage_sensor\"), garageStatus),\r\n            \"Garage Side\" to Pair(listOf(\"garage_side_motion\", \"garage_side_sensor\"), garageSideStatus),\r\n            \"South\" to Pair(listOf(\"south_motion\", \"south_sensor\"), southStatus),\r\n            \"Back\" to Pair(listOf(\"back_motion\", \"back_sensor\"), backStatus),\r\n            \"North\" to Pair(listOf(\"north_motion\", \"north_sensor\"), northStatus),\r\n            \"Front\" to Pair(listOf(\"front_motion\", \"front_sensor\"), frontStatus),\r\n            // Door left in place (sensors may be added later)\r\n            \"Door\" to Pair(listOf(\"door_motion\", \"door_sensor\"), doorStatus)\r\n        )\r\n        \r\n        var activeZones = 0\r\n        val activityLog = mutableListOf<String>()\r\n        val currentTime = SimpleDateFormat(\"HH:mm:ss\", Locale.getDefault()).format(Date())\r\n\r\n        // Collect UI updates first (so we can apply them on the UI thread)\r\n        val zoneUiUpdates = mutableListOf<Triple<TextView, String, Int>>()\r\n\r\n        // Track whether we should show a full-screen alarm and which zone triggered it\r\n        var alarmZoneName: String? = null\r\n\r\n        zones.forEach { (zoneName, zoneData) ->\r\n            val (sensors, statusView) = zoneData\r\n            val sensor1Raw = data[sensors[0]]\r\n            val sensor2Raw = data[sensors[1]]\r\n\r\n            val sensor1 = sensorValueToBoolean(sensor1Raw)\r\n            val sensor2 = sensorValueToBoolean(sensor2Raw)\r\n\r\n            when {\r\n                sensor1 && sensor2 -> {\r\n                    zoneUiUpdates.add(Triple(statusView, \"\uD83D\uDD34 BREACH!\", android.R.color.holo_red_light))\r\n                    activeZones++ // dual-sensor breach counts as active zone\r\n                    activityLog.add(\"[$currentTime] $zoneName: BOTH SENSORS ACTIVE\")\r\n                    // mark the first zone with a dual breach to launch the full-screen alarm\r\n                    if (alarmZoneName == null) alarmZoneName = zoneName\r\n                }\r\n                sensor1 || sensor2 -> {\r\n                    zoneUiUpdates.add(Triple(statusView, \"\uD83D\uDFE1 Motion\", android.R.color.holo_orange_light))\r\n                    val sensorType = if (sensor1) \"Motion\" else \"Sensor\"\r\n                    activityLog.add(\"[$currentTime] $zoneName: $sensorType detected (monitoring only)\")\r\n                }\r\n                else -> {\r\n                    zoneUiUpdates.add(Triple(statusView, \"\uD83D\uDFE2 Clear\", android.R.color.holo_green_light))\r\n                }\r\n            }\r\n        }\r\n\r\n        // Apply collected UI updates on the main thread\r\n        runOnUiThread {\r\n            zoneUiUpdates.forEach { (view, text, colorRes) ->\r\n                view.text = text\r\n                view.setTextColor(resources.getColor(colorRes, theme))\r\n            }\r\n\r\n            // Update system status\r\n            systemStatusText.text = when (activeZones) {\r\n                0 -> \"\uD83D\uDFE2 All Zones Armed - System Online\"\r\n                1 -> \"\uD83D\uDFE1 1 Zone Active - Monitoring\"\r\n                else -> \"\uD83D\uDD34 $activeZones Zones Active - ALERT!\"\r\n            }\r\n\r\n            systemStatusText.setTextColor(\r\n                when (activeZones) {\r\n                    0 -> resources.getColor(android.R.color.holo_green_light, theme)\r\n                    1 -> resources.getColor(android.R.color.holo_orange_light, theme)\r\n                    else -> resources.getColor(android.R.color.holo_red_light, theme)\r\n                }\r\n            )\r\n\r\n            // Update recent activity: append new entries to an in-memory cache so the card doesn't clear when there are no events\r\n            if (activityLog.isNotEmpty()) {\r\n                recentActivityCache.addAll(activityLog)\r\n                // keep cache to a reasonable size\r\n                if (recentActivityCache.size > 50) {\r\n                    val removeCount = recentActivityCache.size - 50\r\n                    repeat(removeCount) { recentActivityCache.removeAt(0) }\r\n                }\r\n                // persist recent activity\r\n                val prefsSave = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n                prefsSave.edit().putString(\"security_recent_activity\", recentActivityCache.joinToString(\"\\n\")).apply()\r\n\r\n                // Display the most recent entries first\r\n                recentActivityText.text = recentActivityCache.takeLast(5).reversed().joinToString(\"\\n\")\r\n                recentActivityText.setTextColor(resources.getColor(android.R.color.white, theme))\r\n            } else {\r\n                if (recentActivityCache.isNotEmpty()) {\r\n                    recentActivityText.text = recentActivityCache.takeLast(5).reversed().joinToString(\"\\n\")\r\n                    recentActivityText.setTextColor(resources.getColor(android.R.color.white, theme))\r\n                } else {\r\n                    recentActivityText.text = \"No recent activity\"\r\n                    recentActivityText.setTextColor(resources.getColor(android.R.color.darker_gray, theme))\r\n                }\r\n            }\r\n\r\n            // Launch full-screen alarm activity for the zone with a dual-sensor breach, if any\r\n            if (alarmZoneName != null && shouldTriggerSecurityAlarms()) {\r\n                val now = System.currentTimeMillis()\r\n                val lastZone = AlarmFullscreenActivity.lastAlarmZone\r\n                val lastTime = AlarmFullscreenActivity.lastAlarmTimeMs\r\n                if (lastZone == alarmZoneName && now - lastTime < AlarmFullscreenActivity.MIN_RESTART_MS) {\r\n                    Log.d(\"SecurityActivity\", \"Alarm for $alarmZoneName recently shown, skipping relaunch\")\r\n                } else {\r\n                    AlarmFullscreenActivity.lastAlarmZone = alarmZoneName\r\n                    AlarmFullscreenActivity.lastAlarmTimeMs = now\r\n                    Log.i(\"SecurityActivity\", \"Requesting NotificationService to show full-screen alarm for $alarmZoneName\")\r\n                    // Ask NotificationService to post a full-screen security alarm (service will start the fullscreen activity)\r\n                    val svcIntent = Intent(this, NotificationService::class.java)\r\n                    svcIntent.action = NotificationService.ACTION_SECURITY_ALARM\r\n                    svcIntent.putExtra(\"alarm_title\", alarmZoneName)\r\n                    svcIntent.putExtra(\"alarm_message\", \"Dual sensor breach in $alarmZoneName\")\r\n                    startService(svcIntent)\r\n                }\r\n            }\r\n        }\r\n\r\n        // Send notification for breaches (if any) only when alarms enabled/scheduled\r\n        if (activeZones > 0 && shouldTriggerSecurityAlarms()) {\r\n            showSecurityNotification(activeZones, activityLog.takeLast(3))\r\n        }\r\n    }\r\n\r\n    // Robust converter for Firestore values -> boolean\r\n    private fun sensorValueToBoolean(value: Any?): Boolean {\r\n        return when (value) {\r\n            is Boolean -> value\r\n            is Long -> value == 1L\r\n            is Int -> value == 1\r\n            is Double -> value == 1.0\r\n            is String -> value == \"1\" || value.equals(\"true\", ignoreCase = true)\r\n            else -> false\r\n        }\r\n    }\r\n\r\n    private fun createNotificationChannel() {\r\n        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {\r\n            val name = \"Security Alerts\"\r\n            val descriptionText = \"Notifications for security breaches\"\r\n            val importance = NotificationManager.IMPORTANCE_HIGH\r\n            // Use bundled alarm tone for this channel so it matches other app alarm sounds\r\n            val soundUri = android.net.Uri.parse(\"android.resource://$packageName/${R.raw.alarm_tone}\")\r\n            val audioAttrs = android.media.AudioAttributes.Builder()\r\n                .setUsage(android.media.AudioAttributes.USAGE_ALARM)\r\n                .setContentType(android.media.AudioAttributes.CONTENT_TYPE_SONIFICATION)\r\n                .setFlags(android.media.AudioAttributes.FLAG_AUDIBILITY_ENFORCED)\r\n                .build()\r\n            val channel = NotificationChannel(CHANNEL_ID, name, importance).apply {\r\n                description = descriptionText\r\n                enableLights(true)\r\n                enableVibration(true)\r\n                setSound(soundUri, audioAttrs)\r\n            }\r\n            val notificationManager: NotificationManager =\r\n                getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager\r\n            notificationManager.createNotificationChannel(channel)\r\n\r\n            // Create a default, silent channel for all other app notifications so only security alerts play sound\r\n            val defaultName = \"App Notifications\"\r\n            val defaultDescription = \"General app notifications (silent)\"\r\n            val defaultImportance = NotificationManager.IMPORTANCE_LOW\r\n            val defaultChannel = NotificationChannel(DEFAULT_CHANNEL_ID, defaultName, defaultImportance).apply {\r\n                description = defaultDescription\r\n                enableLights(false)\r\n                enableVibration(false)\r\n                // Explicitly set no sound for this channel\r\n                setSound(null, null)\r\n                setShowBadge(true)\r\n            }\r\n            notificationManager.createNotificationChannel(defaultChannel)\r\n        }\r\n    }\r\n\r\n    private fun showSecurityNotification(activeZones: Int, recent: List<String>) {\r\n        val soundUri = android.net.Uri.parse(\"android.resource://$packageName/${R.raw.alarm_tone}\")\r\n\r\n        val content = if (recent.isNotEmpty()) {\r\n            recent.joinToString(\"\\n\")\r\n        } else {\r\n            \"$activeZones zone(s) active\"\r\n        }\r\n\r\n        // Use a platform icon fallback to avoid missing drawable resources\r\n        val smallIcon = android.R.drawable.ic_dialog_alert\r\n\r\n        val builder = NotificationCompat.Builder(this, CHANNEL_ID)\r\n            .setSmallIcon(smallIcon)\r\n            .setContentTitle(\"Security Alert: $activeZones breach(s)\")\r\n            .setContentText(content)\r\n            .setStyle(NotificationCompat.BigTextStyle().bigText(content))\r\n            .setPriority(NotificationCompat.PRIORITY_HIGH)\r\n            .setSound(soundUri)\r\n            .setAutoCancel(true)\r\n\r\n        // Check POST_NOTIFICATIONS permission on Android 13+\r\n        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {\r\n            if (ContextCompat.checkSelfPermission(this, Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED) {\r\n                Log.w(\"SecurityActivity\", \"Skipping notification send: POST_NOTIFICATIONS not granted\")\r\n                return\r\n            }\r\n        }\r\n\r\n        with(NotificationManagerCompat.from(this)) {\r\n            notify(NOTIF_ID, builder.build())\r\n        }\r\n    }\r\n    \r\n    override fun onDestroy() {\r\n        super.onDestroy()\r\n        // Remove Firestore listener to prevent memory leaks\r\n        try { securityListener?.remove() } catch (_: Exception) {}\r\n        // Unregister network callback used for SSID monitoring\r\n        try { stopSsidMonitoring() } catch (_: Exception) {}\r\n    }\r\n\r\n    // Check whether security alarms should be active now (enabled toggle + daily schedule)\r\n    private fun shouldTriggerSecurityAlarms(): Boolean {\r\n        try {\r\n            val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n            val forceOff = prefs.getBoolean(\"security_alarms_force_off\", false)\r\n            val forceOn = prefs.getBoolean(\"security_alarms_force_on\", false)\r\n            val enabled = prefs.getBoolean(\"security_alarms_enabled\", true)\r\n\r\n            // New: explicit opt-in flag for enabling alarms when away from the home network\r\n            val enableWhenAway = prefs.getBoolean(\"security_enable_when_away\", false)\r\n\r\n            // Schedule values in minutes since midnight or null if not configured\r\n            val enableHour = prefs.getInt(\"security_enable_hour\", -1)\r\n            val enableMin = prefs.getInt(\"security_enable_min\", 0)\r\n            val disableHour = prefs.getInt(\"security_disable_hour\", -1)\r\n            val disableMin = prefs.getInt(\"security_disable_min\", 0)\r\n            val scheduleStart = if (enableHour < 0 || disableHour < 0) null else enableHour * 60 + enableMin\r\n            val scheduleEnd = if (enableHour < 0 || disableHour < 0) null else disableHour * 60 + disableMin\r\n\r\n            // Determine presence using modern ConnectivityManager + LinkProperties\r\n            val isAtHome = try {\r\n                // Use the unified helper isOnHomeNetwork() which prefers saved SSID, known gateways\r\n                // and RFC1918 heuristics. This avoids a brittle equality check against a single gateway.\r\n                val onHome = isOnHomeNetwork()\r\n                Log.d(\"SecurityActivity\", \"Presence detection via isOnHomeNetwork -> $onHome\")\r\n                onHome\r\n            } catch (e: Exception) {\r\n                Log.w(\"SecurityActivity\", \"presence check failed\", e)\r\n                // Conservative default: assume at home if presence check fails\r\n                true\r\n            }\r\n\r\n            return SecurityPolicy.shouldTriggerSecurityAlarms(\r\n                enabled = enabled,\r\n                forceOn = forceOn,\r\n                forceOff = forceOff,\r\n                isAtHome = isAtHome,\r\n                enableWhenAway = enableWhenAway,\r\n                scheduleStartMinutes = scheduleStart,\r\n                scheduleEndMinutes = scheduleEnd\r\n            )\r\n        } catch (e: Exception) {\r\n            Log.w(\"SecurityActivity\", \"shouldTriggerSecurityAlarms check failed\", e)\r\n            return true\r\n        }\r\n    }\r\n\r\n    // Helper: return gateway IP like ScadaActivity used, or null\r\n    private fun getGatewayIp(): String? {\r\n        try {\r\n            val cm = getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager\r\n            val active: Network? = cm.activeNetwork\r\n            if (active == null) return null\r\n            val lp: LinkProperties? = cm.getLinkProperties(active)\r\n            if (lp == null) return null\r\n            val routes = lp.routes\r\n            // Log and sanitize all discovered gateway addresses to help diagnose odd formats (zone ids, IPv6, etc.)\r\n            for (route in routes) {\r\n                try {\r\n                    val gw = route.gateway\r\n                    if (gw != null) {\r\n                        var host = gw.hostAddress\r\n                        if (!host.isNullOrEmpty() && host != \"0.0.0.0\") {\r\n                            // Remove zone identifier (e.g. %wlan0) if present, trim whitespace\r\n                            host = host.split('%')[0].trim()\r\n                            Log.d(\"SecurityActivity\", \"getGatewayIp: discovered gateway route -> $host\")\r\n                            return host\r\n                        }\r\n                    }\r\n                } catch (ex: Exception) {\r\n                    Log.w(\"SecurityActivity\", \"getGatewayIp: route processing failed\", ex)\r\n                }\r\n            }\r\n             return null\r\n         } catch (e: Exception) {\r\n             Log.w(\"SecurityActivity\", \"getGatewayIp failed\", e)\r\n             return null\r\n         }\r\n     }\r\n\r\n    // Helper: return true if the currently active network transport is Wi‑Fi\r\n    private fun isActiveNetworkWifi(): Boolean {\r\n        try {\r\n            val cm = getSystemService(Context.CONNECTIVITY_SERVICE) as? ConnectivityManager ?: return false\r\n            val active = cm.activeNetwork ?: return false\r\n            val caps = cm.getNetworkCapabilities(active) ?: return false\r\n            return caps.hasTransport(android.net.NetworkCapabilities.TRANSPORT_WIFI)\r\n        } catch (e: Exception) {\r\n            Log.w(\"SecurityActivity\", \"isActiveNetworkWifi failed\", e)\r\n            return false\r\n        }\r\n    }\r\n\r\n    private fun isOnHomeNetwork(): Boolean {\r\n        try {\r\n            val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n            val savedHome = prefs.getString(\"home_ssid\", null)\r\n            val savedHomeGateway = prefs.getString(\"home_gateway\", null)\r\n            val currentSsid = try { getCurrentSsid() } catch (_: Exception) { null }\r\n\r\n            // If a saved SSID exists and we can read SSID, prefer that (trimmed, case-insensitive)\r\n            if (!savedHome.isNullOrEmpty() && !currentSsid.isNullOrEmpty()) {\r\n                return savedHome.trim().equals(currentSsid.trim(), ignoreCase = true)\r\n            }\r\n\r\n            // Fallback to gateway heuristics\r\n            val gw = try { getGatewayIp() } catch (_: Exception) { null } ?: return false\r\n\r\n            // If user explicitly saved a gateway, trust it\r\n            if (!savedHomeGateway.isNullOrEmpty() && savedHomeGateway.trim() == gw.trim()) return true\r\n\r\n            val knownHomeGateways = setOf(\"192.168.8.1\", \"192.168.0.1\", \"192.168.1.1\")\r\n            if (gw in knownHomeGateways) return true\r\n\r\n            // Treat private-range gateways as home ONLY when the active transport is Wi‑Fi. This avoids\r\n            // misclassifying carrier-private addresses (e.g., 10.x) on mobile data as the home network.\r\n            val isWifi = isActiveNetworkWifi()\r\n            if (isWifi) {\r\n                if (gw.startsWith(\"10.\") || gw.startsWith(\"192.168.\") || is172PrivateRange(gw)) return true\r\n            }\r\n\r\n            return false\r\n        } catch (e: Exception) {\r\n            Log.w(\"SecurityActivity\", \"isOnHomeNetwork check failed\", e)\r\n            return false\r\n        }\r\n    }\r\n\r\n     private fun isNetworkAvailable(): Boolean {\r\n         try {\r\n             val cm = getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager\r\n             val active = cm.activeNetwork\r\n             return active != null\r\n         } catch (_: Exception) { return false }\r\n     }\r\n\r\n     // Updated: accept an optional inline dot to mirror homeDot state on the main card header\r\n     private fun updateNetworkIndicators(homeDot: android.widget.ImageView?, bridgeDot: android.widget.ImageView?, inlineDot: android.widget.ImageView? = null) {\r\n         try {\r\n             val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n             val savedHome = prefs.getString(\"home_ssid\", null)\r\n\r\n             // If we have a saved home SSID but don't have location permission, request it asynchronously\r\n             // but continue with gateway heuristics so UI still shows network/bridge status immediately.\r\n             if (!savedHome.isNullOrEmpty() && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\r\n                 if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED) {\r\n                     Log.d(\"SecurityActivity\", \"Location permission not granted; requesting to enable SSID-aware home detection\")\r\n                     ensureLocationPermissionForSsid {\r\n                         try { updateNetworkIndicators(homeDot, bridgeDot, inlineDot) } catch (e: Exception) { Log.w(\"SecurityActivity\", \"Re-run updateNetworkIndicators failed\", e) }\r\n                     }\r\n                     // Do NOT return here — continue and use gateway-based detection so indicators update immediately.\r\n                 }\r\n             }\r\n\r\n             // Determine whether we're on the home network. Prefer SSID comparison when available, otherwise fall back to gateway heuristics.\r\n             var currentSsid = try { getCurrentSsid() } catch (e: Exception) { Log.w(\"SecurityActivity\", \"getCurrentSsid failed\", e); null }\r\n             // If we couldn't read SSID synchronously, try an active fetch (only if permission is present)\r\n             if (currentSsid.isNullOrEmpty() && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED) {\r\n                 try {\r\n                     fetchAndCacheSsidOnce { try { updateNetworkIndicators(homeDot, bridgeDot, inlineDot) } catch (_: Exception) {} }\r\n                 } catch (_: Exception) {}\r\n                 // Use lastKnownSsid if updated by the background fetch, otherwise continue with gateway heuristics for now\r\n                 currentSsid = lastKnownSsid\r\n             }\r\n\r\n             val onHome = try {\r\n                 if (!savedHome.isNullOrEmpty() && !currentSsid.isNullOrEmpty()) {\r\n                     // Use trimmed case-insensitive comparisons to avoid quoting/ case issues\r\n                     savedHome.trim().equals(currentSsid.trim(), ignoreCase = true)\r\n                 } else {\r\n                     // Gateway heuristic fallback\r\n                    val gw = try { getGatewayIp() } catch (e: Exception) { Log.w(\"SecurityActivity\", \"getGatewayIp failed\", e); null }\r\n                    val knownHomeGateways = setOf(\"192.168.8.1\", \"192.168.0.1\", \"192.168.1.1\")\r\n                    if (gw == null) {\r\n                        false\r\n                    } else if (gw in knownHomeGateways) {\r\n                        true\r\n                    } else {\r\n                        // Only treat private gateways as \"home\" when active transport is Wi‑Fi. Cellular carriers\r\n                        // often use private NAT addresses (10.x) and should not be classified as home.\r\n                        val isWifi = isActiveNetworkWifi()\r\n                        if (isWifi) {\r\n                            gw.startsWith(\"10.\") || gw.startsWith(\"192.168.\") || is172PrivateRange(gw)\r\n                        } else {\r\n                            false\r\n                        }\r\n                    }\r\n                 }\r\n             } catch (e: Exception) {\r\n                 Log.w(\"SecurityActivity\", \"Determining home network failed\", e)\r\n                 false\r\n             }\r\n\r\n            // Check general network availability for bridge indicator\r\n            val net = try { isNetworkAvailable() } catch (e: Exception) { Log.w(\"SecurityActivity\", \"isNetworkAvailable failed\", e); false }\r\n\r\n            // Colors\r\n            val homeGreen = Color.parseColor(\"#4CAF50\")\r\n            val grey = Color.parseColor(\"#9E9E9E\")\r\n            val bridgeGreen = Color.parseColor(\"#4CAF50\")\r\n\r\n            // Update UI on main thread to be safe\r\n            runOnUiThread {\r\n                try {\r\n                    if (homeDot != null) {\r\n                        val color = if (onHome) homeGreen else grey\r\n                        homeDot.imageTintList = android.content.res.ColorStateList.valueOf(color)\r\n                        // Mirror onto inline dot if provided\r\n                        try { inlineDot?.imageTintList = android.content.res.ColorStateList.valueOf(color) } catch (_: Exception) {}\r\n                    } else {\r\n                        try { inlineDot?.imageTintList = android.content.res.ColorStateList.valueOf(grey) } catch (_: Exception) {}\r\n                    }\r\n\r\n                    if (bridgeDot != null) {\r\n                        bridgeDot.imageTintList = android.content.res.ColorStateList.valueOf(if (net) bridgeGreen else grey)\r\n                    }\r\n                    // Update optional debug text (if layout includes it) with short runtime diagnostics\r\n                    try {\r\n                        val method = if (!savedHome.isNullOrEmpty() && !currentSsid.isNullOrEmpty()) \"SSID\" else \"gateway\"\r\n                        val gw = try { getGatewayIp() } catch (_: Exception) { null }\r\n                        val hasPerm = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) ContextCompat.checkSelfPermission(this@SecurityActivity, Manifest.permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED else true\r\n                        networkDebugText?.text = \"savedHome:${savedHome ?: \"(none)\"}  lastKnown:${lastKnownSsid ?: \"n/a\"}  SSID:${currentSsid ?: \"n/a\"}  method:$method  onHome:$onHome  gw:${gw ?: \"n/a\"}  net:$net  perm:${hasPerm}\"\r\n                    } catch (_: Exception) {}\r\n                 } catch (e: Exception) {\r\n                     Log.w(\"SecurityActivity\", \"Failed applying network indicator colors to UI\", e)\r\n                 }\r\n             }\r\n\r\n            // Diagnostic log showing what we determined\r\n            Log.d(\"SecurityActivity\", \"updateNetworkIndicators: savedHome=$savedHome currentSsid=$currentSsid onHome=$onHome net=$net\")\r\n        } catch (e: Exception) {\r\n            Log.w(\"SecurityActivity\", \"updateNetworkIndicators failed\", e)\r\n        }\r\n    }\r\n\r\n    private fun showPresenceDialog() {\r\n         val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n         val gateway = try { getGatewayIp() } catch (e: Exception) { null }\r\n         val detectedSsid = try { getCurrentSsid() } catch (_: Exception) { null }\r\n         val savedHomeSsid = prefs.getString(\"home_ssid\", null)\r\n         val savedHomeGateway = prefs.getString(\"home_gateway\", null)\r\n         val isHomeBySsid = if (!savedHomeSsid.isNullOrEmpty() && !detectedSsid.isNullOrEmpty()) detectedSsid == savedHomeSsid else false\r\n         val isHomeByGateway = gateway == \"192.168.8.1\"\r\n         val atHome = if (!savedHomeSsid.isNullOrEmpty()) isHomeBySsid else isHomeByGateway\r\n         val gwText = gateway ?: \"unknown\"\r\n         val ssidText = detectedSsid ?: \"unknown\"\r\n         val savedText = savedHomeSsid ?: \"(not set)\"\r\n         val savedGwText = savedHomeGateway ?: \"(not set)\"\r\n         val message = \"Gateway: $gwText\\nSSID: $ssidText\\nSaved home SSID: $savedText\\nAt home: $atHome\"\r\n         runOnUiThread {\r\n             val builder = AlertDialog.Builder(this)\r\n                 .setTitle(\"Presence check\")\r\n                 .setMessage(message)\r\n                 .setPositiveButton(\"OK\", null)\r\n             // Provide a Save... action which opens a small menu allowing saving either SSID or Gateway when available\r\n             if (!detectedSsid.isNullOrEmpty() || !gateway.isNullOrEmpty()) {\r\n                 builder.setNeutralButton(\"Save...\") { _, _ ->\r\n                     try {\r\n                         val options = mutableListOf<String>()\r\n                         if (!detectedSsid.isNullOrEmpty()) options.add(\"Save SSID as Home\")\r\n                         if (!gateway.isNullOrEmpty()) options.add(\"Save Gateway as Home\")\r\n                         val opts = options.toTypedArray()\r\n                         val sub = AlertDialog.Builder(this)\r\n                             .setTitle(\"Save home identifier\")\r\n                             .setItems(opts) { _, which ->\r\n                                 when (opts[which]) {\r\n                                     \"Save SSID as Home\" -> saveCurrentSsidAsHome()\r\n                                     \"Save Gateway as Home\" -> {\r\n                                         try {\r\n                                             prefs.edit().putString(\"home_gateway\", gateway).apply()\r\n                                             try { ToastHelper.show(this, \"Saved home gateway: $gateway\", android.widget.Toast.LENGTH_SHORT) } catch (_: Exception) {}\r\n                                             // Refresh indicators to pick up new saved gateway immediately\r\n                                             runOnUiThread { updateNetworkIndicators(networkHomeDot, networkBridgeDot, networkHomeDotInline) }\r\n                                         } catch (e: Exception) { Log.w(\"SecurityActivity\", \"Failed saving home gateway\", e) }\r\n                                     }\r\n                                 }\r\n                             }\r\n                             .setNegativeButton(\"Cancel\", null)\r\n                         sub.show()\r\n                     } catch (e: Exception) {\r\n                         Log.w(\"SecurityActivity\", \"Failed showing save options\", e)\r\n                     }\r\n                 }\r\n             } else {\r\n                 // Request permission then re-open the dialog so user can save SSID\r\n                 builder.setNeutralButton(\"Enable SSID read\") { _, _ -> ensureLocationPermissionForSsid { showPresenceDialog() } }\r\n             }\r\n             val dlg = builder.create()\r\n             dlg.show()\r\n         }\r\n     }\r\n\r\n    private fun updateScheduleUi() {\r\n        try {\r\n            val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n            val eh = prefs.getInt(\"security_enable_hour\", -1)\r\n            val em = prefs.getInt(\"security_enable_min\", 0)\r\n            val dh = prefs.getInt(\"security_disable_hour\", -1)\r\n            val dm = prefs.getInt(\"security_disable_min\", 0)\r\n            val summary = SecuritySchedule.formatSchedule(eh, em, dh, dm)\r\n            securityScheduleSummary.text = \"Scheduled: $summary\"\r\n\r\n            val forced = prefs.getBoolean(\"security_alarms_force_on\", false)\r\n             // Always keep system status card fully opaque (no dimming)\r\n             systemStatusCard.alpha = 1.0f\r\n\r\n\r\n            // Reflect force switch state in UI (ensure switch matches persisted pref)\r\n            securityForceSwitch.isChecked = forced\r\n            // Reflect force-off switch in UI\r\n            val forcedOff = prefs.getBoolean(\"security_alarms_force_off\", false)\r\n            securityForceOffSwitch.isChecked = forcedOff\r\n        } catch (e: Exception) {\r\n            Log.w(\"SecurityActivity\", \"updateScheduleUi failed\", e)\r\n        }\r\n    }\r\n\r\n    override fun onResume() {\r\n        super.onResume()\r\n        // Refresh network indicators in case network state changed while activity was not visible\r\n        try { updateNetworkIndicators(networkHomeDot, networkBridgeDot, networkHomeDotInline) } catch (_: Exception) {}\r\n\r\n        // If a home SSID has been saved, ensure we have permission to read the SSID so the indicator can use it.\r\n        try {\r\n            val prefs = getSharedPreferences(\"app_prefs\", Context.MODE_PRIVATE)\r\n            val savedHome = prefs.getString(\"home_ssid\", null)\r\n            if (!savedHome.isNullOrEmpty()) {\r\n                ensureLocationPermissionForSsid {\r\n                    try { updateNetworkIndicators(networkHomeDot, networkBridgeDot, networkHomeDotInline) } catch (_: Exception) {}\r\n                }\r\n            }\r\n        } catch (_: Exception) {}\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/security/app/SecurityActivity.kt b/app/src/main/java/com/security/app/SecurityActivity.kt
--- a/app/src/main/java/com/security/app/SecurityActivity.kt	(revision 44d69ffda4d1488978c0d0db75712de451938b41)
+++ b/app/src/main/java/com/security/app/SecurityActivity.kt	(date 1766890479207)
@@ -61,6 +61,32 @@
     // Small in-memory cache to keep recent activity between update cycles
     private val recentActivityCache: MutableList<String> = mutableListOf()
 
+    // Classify whether a log line is security-related. Heuristics based on common zone/door events
+    private fun isSecurityLine(line: String?): Boolean {
+        if (line.isNullOrBlank()) return false
+        val s = line.lowercase(Locale.getDefault())
+        // Explicit tag or common security terms
+        return s.contains("security") ||
+               s.contains("zone") || s.contains("door") || s.contains("garage") || s.contains("front") ||
+               s.contains("back") || s.contains("north") || s.contains("south") || s.contains("alarm") ||
+               s.contains("breach") || s.contains("motion")
+    }
+
+    private fun filteredSecurityActivityAll(): List<String> {
+        return recentActivityCache.filter { isSecurityLine(it) }
+    }
+
+    private fun renderRecentActivityPreview() {
+        val lines = filteredSecurityActivityAll()
+        if (lines.isNotEmpty()) {
+            recentActivityText.text = lines.takeLast(5).reversed().joinToString("\n")
+            try { recentActivityText.setTextColor(resources.getColor(android.R.color.white, theme)) } catch (_: Exception) {}
+        } else {
+            recentActivityText.text = "No recent activity"
+            try { recentActivityText.setTextColor(resources.getColor(android.R.color.darker_gray, theme)) } catch (_: Exception) {}
+        }
+    }
+
     // Firestore listener registration for proper cleanup
     private var securityListener: com.google.firebase.firestore.ListenerRegistration? = null
 
@@ -371,14 +397,57 @@
             recentActivityCache.addAll(items)
             // Show newest activity at the top: take the last 5 (most recent) then reverse so latest is first
             try {
-                recentActivityText.text = recentActivityCache.takeLast(5).reversed().joinToString("\n")
-                recentActivityText.setTextColor(resources.getColor(android.R.color.white, theme))
+                renderRecentActivityPreview()
             } catch (e: Exception) {
                 Log.w("SecurityActivity", "Failed setting recentActivityText from persisted data", e)
             }
             Log.d("SecurityActivity", "Loaded ${recentActivityCache.size} persisted recentActivity entries")
         }
 
+        // Backfill: merge any FCM alarm history entries received while app was backgrounded
+        try {
+            val alarmPrefs = getSharedPreferences("alarm_history", Context.MODE_PRIVATE)
+            val key = "recent_alarms_json"
+            val json = alarmPrefs.getString(key, "[]") ?: "[]"
+            val arr = try { org.json.JSONArray(json) } catch (_: Exception) { org.json.JSONArray("[]") }
+            if (arr.length() > 0) {
+                val fmt = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.getDefault())
+                val newLines = mutableListOf<String>()
+                var i = 0
+                while (i < arr.length()) {
+                    try {
+                        val obj = arr.getJSONObject(i)
+                        val t = obj.optLong("time_ms", System.currentTimeMillis())
+                        val zone = obj.optString("zone", "Security")
+                        val msg = obj.optString("message", obj.optString("title", "Activity"))
+                        val timeStr = fmt.format(java.util.Date(t))
+                        newLines.add("[$timeStr] $zone: $msg")
+                    } catch (_: Exception) {}
+                    i++
+                }
+                if (newLines.isNotEmpty()) {
+                    // Append and persist, de-duplicating trivial consecutive duplicates
+                    newLines.forEach { line ->
+                        val last = recentActivityCache.lastOrNull()
+                        if (last == null || last != line) recentActivityCache.add(line)
+                    }
+                    // Trim to last 50 entries
+                    if (recentActivityCache.size > 50) {
+                        val removeCount = recentActivityCache.size - 50
+                        repeat(removeCount) { recentActivityCache.removeAt(0) }
+                    }
+                    prefs.edit().putString("security_recent_activity", recentActivityCache.joinToString("\n")).apply()
+                    // Refresh UI
+                    try {
+                        renderRecentActivityPreview()
+                    } catch (_: Exception) {}
+                    Log.d("SecurityActivity", "Backfilled ${newLines.size} FCM alarms into recent activity")
+                }
+            }
+        } catch (e: Exception) {
+            Log.w("SecurityActivity", "Failed to backfill FCM alarm history", e)
+        }
+
         // Setup back button
         findViewById<TextView>(R.id.securityBackButton).setOnClickListener {
             finish()
@@ -753,16 +822,13 @@
                 val prefsSave = getSharedPreferences("app_prefs", Context.MODE_PRIVATE)
                 prefsSave.edit().putString("security_recent_activity", recentActivityCache.joinToString("\n")).apply()
 
-                // Display the most recent entries first
-                recentActivityText.text = recentActivityCache.takeLast(5).reversed().joinToString("\n")
-                recentActivityText.setTextColor(resources.getColor(android.R.color.white, theme))
+                // Display the most recent entries first (filtered)
+                renderRecentActivityPreview()
             } else {
                 if (recentActivityCache.isNotEmpty()) {
-                    recentActivityText.text = recentActivityCache.takeLast(5).reversed().joinToString("\n")
-                    recentActivityText.setTextColor(resources.getColor(android.R.color.white, theme))
+                    renderRecentActivityPreview()
                 } else {
-                    recentActivityText.text = "No recent activity"
-                    recentActivityText.setTextColor(resources.getColor(android.R.color.darker_gray, theme))
+                    renderRecentActivityPreview()
                 }
             }
 
Index: app/src/main/java/com/security/app/FcmHealthWorker.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.security.app\r\n\r\nimport android.content.Context\r\nimport android.util.Log\r\nimport androidx.work.Constraints\r\nimport androidx.work.CoroutineWorker\r\nimport androidx.work.ExistingPeriodicWorkPolicy\r\nimport androidx.work.NetworkType\r\nimport androidx.work.PeriodicWorkRequestBuilder\r\nimport androidx.work.WorkManager\r\nimport androidx.work.WorkerParameters\r\nimport com.google.firebase.messaging.FirebaseMessaging\r\nimport kotlinx.coroutines.tasks.await\r\nimport java.util.concurrent.TimeUnit\r\n\r\n/**\r\n * Periodic health check for Firebase Cloud Messaging.\r\n *\r\n * What it does:\r\n * - Fetches current FCM registration token.\r\n * - Compares with last stored token; if changed, stores it and resubscribes topics.\r\n * - Optionally can report status to logs/backend.\r\n */\r\nclass FcmHealthWorker(\r\n    appContext: Context,\r\n    params: WorkerParameters\r\n) : CoroutineWorker(appContext, params) {\r\n\r\n    override suspend fun doWork(): Result {\r\n        val appCtx = applicationContext\r\n        val prefs = appCtx.getSharedPreferences(\"security_prefs\", Context.MODE_PRIVATE)\r\n\r\n        return try {\r\n            // Get the current token using coroutine Task await (we're already in a suspend function)\r\n            val currentToken: String? = FirebaseMessaging.getInstance().token.await()\r\n\r\n            val lastToken = prefs.getString(KEY_LAST_FCM_TOKEN, null)\r\n            val changed = currentToken != null && currentToken != lastToken\r\n\r\n            if (currentToken.isNullOrBlank()) {\r\n                Log.w(TAG, \"FCM Health: token is null/blank; will retry next cycle\")\r\n            } else {\r\n                if (changed) {\r\n                    Log.i(TAG, \"FCM Health: token changed. Updating and resubscribing to topics\")\r\n                    prefs.edit().putString(KEY_LAST_FCM_TOKEN, currentToken).apply()\r\n                    resubscribeTopicsSafely()\r\n                } else {\r\n                    Log.d(TAG, \"FCM Health: token OK and unchanged\")\r\n                }\r\n            }\r\n\r\n            // Minimal success; WorkManager will schedule next run\r\n            Result.success()\r\n        } catch (t: Throwable) {\r\n            Log.e(TAG, \"FCM Health: check failed\", t)\r\n            Result.retry()\r\n        }\r\n    }\r\n\r\n    private fun resubscribeTopicsSafely() {\r\n        // Keep this list small and stable; you can customize\r\n        val topics = listOf(\r\n            \"alerts-security\",\r\n            \"alerts-water\",\r\n            \"alerts-dvr\"\r\n        )\r\n        topics.forEach { topic ->\r\n            FirebaseMessaging.getInstance().subscribeToTopic(topic)\r\n                .addOnFailureListener { e -> Log.w(TAG, \"Failed to subscribe to $topic\", e) }\r\n                .addOnSuccessListener { Log.d(TAG, \"Subscribed to $topic\") }\r\n        }\r\n    }\r\n\r\n    companion object {\r\n        private const val TAG = \"FcmHealth\"\r\n        private const val UNIQUE_WORK = \"fcm_health_check\"\r\n        private const val KEY_LAST_FCM_TOKEN = \"last_fcm_token\"\r\n\r\n        fun schedule(context: Context) {\r\n            val constraints = Constraints.Builder()\r\n                .setRequiredNetworkType(NetworkType.CONNECTED)\r\n                .setRequiresBatteryNotLow(true)\r\n                .build()\r\n\r\n            // Use a 1-hour interval with some flex to let the scheduler batch efficiently\r\n            val request = PeriodicWorkRequestBuilder<FcmHealthWorker>(1, TimeUnit.HOURS)\r\n                .setConstraints(constraints)\r\n                .build()\r\n\r\n            WorkManager.getInstance(context).enqueueUniquePeriodicWork(\r\n                UNIQUE_WORK,\r\n                ExistingPeriodicWorkPolicy.UPDATE,\r\n                request\r\n            )\r\n        }\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/security/app/FcmHealthWorker.kt b/app/src/main/java/com/security/app/FcmHealthWorker.kt
--- a/app/src/main/java/com/security/app/FcmHealthWorker.kt	(revision 44d69ffda4d1488978c0d0db75712de451938b41)
+++ b/app/src/main/java/com/security/app/FcmHealthWorker.kt	(date 1766856924474)
@@ -9,8 +9,8 @@
 import androidx.work.PeriodicWorkRequestBuilder
 import androidx.work.WorkManager
 import androidx.work.WorkerParameters
+import com.google.android.gms.tasks.Tasks
 import com.google.firebase.messaging.FirebaseMessaging
-import kotlinx.coroutines.tasks.await
 import java.util.concurrent.TimeUnit
 
 /**
@@ -19,7 +19,7 @@
  * What it does:
  * - Fetches current FCM registration token.
  * - Compares with last stored token; if changed, stores it and resubscribes topics.
- * - Optionally can report status to logs/backend.
+ * - Persists a simple Online/Offline status for UI.
  */
 class FcmHealthWorker(
     appContext: Context,
@@ -31,14 +31,20 @@
         val prefs = appCtx.getSharedPreferences("security_prefs", Context.MODE_PRIVATE)
 
         return try {
-            // Get the current token using coroutine Task await (we're already in a suspend function)
-            val currentToken: String? = FirebaseMessaging.getInstance().token.await()
+            // Use Tasks.await here to avoid missing coroutines-play-services dependency issues
+            val currentToken: String? = try {
+                Tasks.await(FirebaseMessaging.getInstance().token)
+            } catch (e: Exception) {
+                Log.w(TAG, "FCM Health: token fetch failed via Tasks.await", e)
+                null
+            }
 
             val lastToken = prefs.getString(KEY_LAST_FCM_TOKEN, null)
             val changed = currentToken != null && currentToken != lastToken
 
-            if (currentToken.isNullOrBlank()) {
-                Log.w(TAG, "FCM Health: token is null/blank; will retry next cycle")
+            if (currentToken == null || currentToken.isBlank()) {
+                Log.w(TAG, "FCM Health: token is null/blank; marking Offline and retrying next cycle")
+                prefs.edit().putString(KEY_FCM_STATUS, STATUS_OFFLINE).apply()
             } else {
                 if (changed) {
                     Log.i(TAG, "FCM Health: token changed. Updating and resubscribing to topics")
@@ -47,12 +53,16 @@
                 } else {
                     Log.d(TAG, "FCM Health: token OK and unchanged")
                 }
+                prefs.edit().putString(KEY_FCM_STATUS, STATUS_ONLINE).apply()
             }
 
             // Minimal success; WorkManager will schedule next run
             Result.success()
         } catch (t: Throwable) {
             Log.e(TAG, "FCM Health: check failed", t)
+            // Persist offline so UI reflects degraded state
+            applicationContext.getSharedPreferences("security_prefs", Context.MODE_PRIVATE)
+                .edit().putString(KEY_FCM_STATUS, STATUS_OFFLINE).apply()
             Result.retry()
         }
     }
@@ -75,6 +85,9 @@
         private const val TAG = "FcmHealth"
         private const val UNIQUE_WORK = "fcm_health_check"
         private const val KEY_LAST_FCM_TOKEN = "last_fcm_token"
+        const val KEY_FCM_STATUS = "fcm_status"
+        const val STATUS_ONLINE = "Online"
+        const val STATUS_OFFLINE = "Offline"
 
         fun schedule(context: Context) {
             val constraints = Constraints.Builder()
Index: app/src/main/java/com/security/app/LightsService.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/security/app/LightsService.kt b/app/src/main/java/com/security/app/LightsService.kt
new file mode 100644
--- /dev/null	(date 1766914029393)
+++ b/app/src/main/java/com/security/app/LightsService.kt	(date 1766914029393)
@@ -0,0 +1,92 @@
+package com.security.app
+
+import android.content.Context
+import android.util.Log
+import com.google.firebase.firestore.FieldValue
+import com.google.firebase.firestore.FirebaseFirestore
+import com.google.firebase.firestore.SetOptions
+
+/**
+ * Centralized service for sending commands to the bridge for lights-related actions.
+ * Keep the public surface tiny: one helper to write the outside lights command.
+ */
+class LightsService(
+    // ...existing code...
+) {
+    /**
+     * Write the desired outside lights state to the bridge.
+     * Returns true if the request was issued without local errors.
+     */
+    fun writeOutsideLights(context: Context, turnOn: Boolean): Boolean {
+        return try {
+            val db = FirebaseFirestore.getInstance()
+            val bridgeCmdDoc = db.collection("Flights_commands").document("current_command")
+
+            // Bridge payload must match what Unified Bridge consumes
+            val desired = turnOn
+            val cmd = if (turnOn) "on" else "off"
+            val nonce = System.currentTimeMillis() // ensure every press produces a unique change
+            val bridgePayload = hashMapOf<String, Any>(
+                "desired" to desired,
+                "desired_ts" to FieldValue.serverTimestamp(),
+                "command" to cmd,
+                "command_ts" to FieldValue.serverTimestamp(),
+                "command_source" to "android_app",
+                "client_nonce" to nonce
+            )
+
+            Log.d("LightsService", "Writing bridge command: $cmd (nonce=$nonce)")
+
+            // Write to bridge command doc (merge so other fields the bridge adds remain intact)
+            bridgeCmdDoc
+                .set(bridgePayload, SetOptions.merge())
+                .addOnSuccessListener {
+                    Log.d("LightsService", "Bridge command set (turnOn=$turnOn)")
+                    // Read-back for diagnostics (non-blocking)
+                    try {
+                        bridgeCmdDoc.get()
+                            .addOnSuccessListener { snap -> Log.d("LightsService", "Bridge doc after set: ${snap.data}") }
+                            .addOnFailureListener { e -> Log.w("LightsService", "Bridge doc readback failed", e) }
+                    } catch (e: Exception) {
+                        Log.w("LightsService", "Bridge doc readback threw", e)
+                    }
+                }
+                .addOnFailureListener { e -> Log.e("LightsService", "Bridge command write failed", e) }
+
+            // Redundant minimal write using existing local helper (ensures command+ts present)
+            try {
+                FcmSender(db).sendToBridgeCommand(cmd)
+            } catch (e: Exception) {
+                Log.w("LightsService", "Fallback FcmSender write failed (ignored)", e)
+            }
+
+            // Compatibility: also reflect desired state under scada_controls/lights so listeners can update UI/state
+            try {
+                val controlsDoc = db.collection("scada_controls").document("lights")
+                val controlsPayload = hashMapOf<String, Any>(
+                    "desired" to desired,
+                    "command" to cmd,
+                    "source" to "android_app",
+                    "ts" to FieldValue.serverTimestamp()
+                )
+                controlsDoc.set(controlsPayload, SetOptions.merge())
+                    .addOnSuccessListener { Log.d("LightsService", "Reflected controls/lights (turnOn=$turnOn)") }
+                    .addOnFailureListener { e -> Log.w("LightsService", "Failed reflecting controls/lights", e) }
+            } catch (e: Exception) {
+                Log.w("LightsService", "controls/lights reflection failed", e)
+            }
+
+            true
+        } catch (t: Throwable) {
+            Log.w("LightsService", "Failed to write outside lights state", t)
+            false
+        }
+    }
+}
+
+/**
+ * Backwards-compatible helper so existing code can call a top-level function while routing through LightsService.
+ */
+fun toggleOutsideLights(context: Context, turnOn: Boolean): Boolean {
+    return LightsService().writeOutsideLights(context, turnOn)
+}
Index: tools/lights_listener_bridge.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/tools/lights_listener_bridge.py b/tools/lights_listener_bridge.py
new file mode 100644
--- /dev/null	(date 1766919478543)
+++ b/tools/lights_listener_bridge.py	(date 1766919478543)
@@ -0,0 +1,257 @@
+#!/usr/bin/env python3
+"""
+Minimal Lights Listener Bridge
+- Listens to Firestore document Flights_commands/current_command
+- On each new command (on/off), writes Modbus TCP coil 2070 and confirms via coil 1298
+
+Run this alongside your new security-only bridge so lights commands from the Android app work again.
+
+Requirements:
+  pip install firebase-admin google-cloud-firestore
+
+If your service account path differs, update SERVICE_ACCOUNT_FILE below or set
+  set GOOGLE_APPLICATION_CREDENTIALS=C:\path\to\service_account.json
+"""
+import time
+import socket
+import struct
+import os
+import sys
+from datetime import datetime
+
+# Firestore
+import firebase_admin
+from firebase_admin import credentials, firestore
+
+# ==================== CONFIGURATION ====================
+SERVICE_ACCOUNT_FILE = r"C:\\website\\firebase\\security-33809-firebase-adminsdk-fbsvc-5bbc47b722.json"
+FIRESTORE_PROJECT = "security-33809"
+
+FS_COLLECTION = "Flights_commands"
+FS_DOC = "current_command"
+
+# PLC / Modbus
+PLC_HOST = "192.168.8.5"
+PLC_PORT = 8080
+UNIT_ID = 1
+ADDRESS_IS_1_BASED = True
+
+COIL_CMD_DOC = 2070   # command coil (1-based as per your previous bridge)
+COIL_CONFIRM_DOC = 1298  # confirm coil (1-based)
+
+CONNECT_TIMEOUT = 4.0
+RECV_TIMEOUT = 3.0
+DRAIN_SEC = 0.12
+CONFIRM_RETRY_COUNT = 6
+CONFIRM_RETRY_DELAY = 0.5
+
+# ==================== UTILS ====================
+def now_iso():
+    return datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")
+
+def log_print(*args):
+    print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}]", *args)
+
+def doc_to_modbus(doc):
+    return (doc - 1) if ADDRESS_IS_1_BASED else doc
+
+# ==================== MODBUS HELPERS ====================
+def _build_mbap_request(func, tid, unit, addr, qty_or_value):
+    pdu = struct.pack(">BHH", func, addr & 0xFFFF, qty_or_value & 0xFFFF)
+    length = 1 + len(pdu)
+    return struct.pack(">HHHB", tid & 0xFFFF, 0, length & 0xFFFF, unit & 0xFF) + pdu
+
+def _recv_mbap_response(sock, timeout):
+    sock.settimeout(timeout)
+    try:
+        hdr = sock.recv(7)
+    except socket.timeout:
+        return None, "no header (timeout)"
+    except Exception as e:
+        return None, f"recv header err: {e}"
+    if not hdr or len(hdr) < 7:
+        return None, "short header"
+    try:
+        resp_tid, proto, length, unit = struct.unpack(">HHHB", hdr)
+    except Exception as e:
+        return None, f"bad header unpack: {e}"
+    toread = max(0, length - 1)
+    pdu = b""
+    deadline = time.time() + timeout
+    while len(pdu) < toread and time.time() < deadline:
+        try:
+            chunk = sock.recv(toread - len(pdu))
+        except socket.timeout:
+            break
+        except Exception:
+            break
+        if not chunk:
+            break
+        pdu += chunk
+    return (hdr, pdu), None
+
+def modbus_write_coil(host, port, unit, addr, value, timeout):
+    tid = int(time.time() * 1000) & 0xFFFF
+    coil_value = 0xFF00 if value else 0x0000
+    req = _build_mbap_request(0x05, tid, unit, addr, coil_value)
+    try:
+        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
+            sock.settimeout(timeout)
+            sock.connect((host, port))
+            sock.sendall(req)
+            time.sleep(DRAIN_SEC)
+            resp, err = _recv_mbap_response(sock, RECV_TIMEOUT)
+            if err:
+                return False, err
+            return True, "OK"
+    except Exception as e:
+        return False, str(e)
+
+def modbus_read_coil(host, port, unit, addr, timeout):
+    tid = int(time.time() * 1000) & 0xFFFF
+    req = _build_mbap_request(0x01, tid, unit, addr, 1)
+    try:
+        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
+            sock.settimeout(timeout)
+            sock.connect((host, port))
+            sock.sendall(req)
+            time.sleep(DRAIN_SEC)
+            resp, err = _recv_mbap_response(sock, RECV_TIMEOUT)
+            if err:
+                return None, err
+            hdr, pdu = resp
+            if len(pdu) < 2:
+                return None, "short pdu"
+            fc = pdu[0]
+            if fc != 0x01:
+                return None, f"unexpected fc={fc}"
+            byte_count = pdu[1]
+            if len(pdu) < 2 + byte_count:
+                return None, "incomplete data"
+            data = pdu[2:2+byte_count]
+            if len(data) == 0:
+                return None, "no data bytes"
+            coil_state = bool(data[0] & 0x01)
+            return coil_state, None
+    except Exception as e:
+        return None, str(e)
+
+# ==================== FIRESTORE LISTENER ====================
+def main():
+    os.system("title Lights Listener Bridge")
+
+    # Init Firebase
+    try:
+        if os.path.exists(SERVICE_ACCOUNT_FILE):
+            cred = credentials.Certificate(SERVICE_ACCOUNT_FILE)
+            firebase_admin.initialize_app(cred)
+        else:
+            # Fallback to env var if provided
+            cred = credentials.ApplicationDefault()
+            firebase_admin.initialize_app(cred, {"projectId": FIRESTORE_PROJECT})
+    except Exception as e:
+        log_print(f"✗ Firebase init failed: {e}")
+        sys.exit(1)
+
+    db = firestore.client()
+    log_print("✓ Firebase connected (Lights Listener)")
+
+    cmd_ref = db.collection(FS_COLLECTION).document(FS_DOC)
+    status_ref = db.collection("scada_controls").document("lights_status")
+    last_ts = [None]
+
+    def on_snapshot(doc_snapshot, changes, read_time):
+        try:
+            if not doc_snapshot:
+                log_print("[Modbus] on_snapshot: empty snapshot")
+                return
+            snap = doc_snapshot[0]
+            if not snap.exists:
+                log_print("[Modbus] command doc missing")
+                return
+            data = snap.to_dict() or {}
+            cmd = str(data.get("command", "")).lower().strip()
+            cmd_ts = data.get("command_ts")
+
+            if not cmd:
+                log_print("[Modbus] empty command - ignore")
+                return
+            if cmd_ts is not None and cmd_ts == last_ts[0]:
+                log_print("[Modbus] duplicate command_ts - ignore")
+                return
+            last_ts[0] = cmd_ts
+
+            desired = True if cmd == "on" else False if cmd == "off" else None
+            if desired is None:
+                log_print(f"[Modbus] Unknown command '{cmd}' - ignore")
+                return
+
+            log_print(f"[Modbus] Command {cmd.upper()} @ {now_iso()} -> writing coil {COIL_CMD_DOC}")
+            success, msg = modbus_write_coil(
+                PLC_HOST, PLC_PORT, UNIT_ID, doc_to_modbus(COIL_CMD_DOC), desired, CONNECT_TIMEOUT
+            )
+            if not success:
+                log_print(f"[Modbus] Write failed: {msg}")
+                try:
+                    status_ref.set({
+                        "error": msg,
+                        "command": cmd,
+                        "confirmed": False,
+                        "timestamp": firestore.SERVER_TIMESTAMP,
+                        "bridge_version": "lights_listener_v1"
+                    }, merge=True)
+                except Exception:
+                    pass
+                return
+
+            # Confirm coil state
+            confirm_addr = doc_to_modbus(COIL_CONFIRM_DOC)
+            confirmed = False
+            for i in range(CONFIRM_RETRY_COUNT):
+                time.sleep(CONFIRM_RETRY_DELAY)
+                state, err = modbus_read_coil(PLC_HOST, PLC_PORT, UNIT_ID, confirm_addr, CONNECT_TIMEOUT)
+                if err:
+                    log_print(f"[Modbus] confirm attempt {i+1}: ERROR {err}")
+                else:
+                    log_print(f"[Modbus] confirm attempt {i+1}: {state}")
+                    if state == desired:
+                        confirmed = True
+                        break
+
+            # Write status so Android UI can display result
+            try:
+                status_ref.set({
+                    "coil_1298_state": confirmed,
+                    "coil_1298_state_bool": confirmed,
+                    "command": cmd,
+                    "confirmed": confirmed,
+                    "timestamp": firestore.SERVER_TIMESTAMP,
+                    "bridge_version": "lights_listener_v1"
+                }, merge=True)
+            except Exception as e:
+                log_print(f"[Modbus] Failed to write status: {e}")
+
+            log_print(f"[Modbus] Result: {'CONFIRMED' if confirmed else 'NOT CONFIRMED'}")
+        except Exception as e:
+            log_print(f"[Modbus] on_snapshot error: {e}")
+
+    try:
+        watch = cmd_ref.on_snapshot(on_snapshot)
+    except Exception as e:
+        log_print(f"✗ Failed to attach listener: {e}")
+        sys.exit(1)
+
+    log_print("▶ Listener attached. Waiting for commands… (Ctrl+C to exit)")
+    try:
+        while True:
+            time.sleep(3600)
+    except KeyboardInterrupt:
+        if 'watch' in locals() and watch:
+            try:
+                watch.unsubscribe()
+            except Exception:
+                pass
+        log_print("Lights Listener Bridge stopped")
+
+if __name__ == "__main__":
+    main()
